---
title: "Length of Stay as Survival of Discharge"
subtitle: "Data Preparation"
author: "Paul Hooven"
date: 8/1/2020
#output: html_notebook
#https://yixuan.cos.name/prettydoc/cayman.html
output:
  prettydoc::html_pretty:
    #theme: hpstr
    theme: cayman
    #theme: tactile
    #theme: architect
    #theme: leonids
    #highlight: github
    highlight: vignette
  rmarkdown::html_document:
    theme: lumen
  word_document:
    fig_height: 4
    fig_width: 5
  pdf_document:
    fig_height: 4
    fig_width: 4.5
  html_document:
    fig_height: 4
    fig_width: 4.5
    
---

```{r aws_installs, include=FALSE, results='hide', echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, eval=FALSE}
# if you laod this on AWS from an R image, uncomment this to install necessary packages.
install.packages(c("ranger"
                  ,"doParallel"
                  ,"caret"
                  ,"e1071"
                  ,"treemap"
                  ,"fastDummies"
                  ,"rpart.plot"
                  ,"gbm"
                  ,"forestFloor"
                  ,"randomForestExplainer"
                  ,"FNN"
                  ,"randomForest"
                  ,"glmnet"
                  ,"anytime"
                  ,"doMC"
                  ,"foreach"
                  ,"prettydoc"
                  ,"mosaic"
                  ,"car"
                  ,"qqplotr"
                  ,"tidyr"
                  ,"ggcorrplot"
                  ,"fields"
                  ,"viridis"
                  ,"ggExtra"
                  ,"cowplot"
                  ,"kableExtra"
                  ,"tree"
                  ,"fasttime"
                  ,"psych"
                  ,"tis"
                  ,"DMwR"
                  ,"ggfortify"
                  ,"ellipse"
                  ,"EnvStats"
                ))
install.packages(c("survival", "survminer"))

#install.packages("~/Downloads/ranger_0.12.1.tar.gz", repos = NULL, type = "source")
#install.packages("~/Downloads/e1071_1.7-3.tgz", repos = NULL, type = .Platform$pkgType)
```

```{r clear_all, include=FALSE}
# clear out variables/environment
rm(list=ls())
```

```{r register_cores, results='hide', include=FALSE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
require(foreach) 
require(doMC)
doMC::registerDoMC(cores = detectCores()-1)
detectCores()
```

```{r stnd_pckgs, setup, include=FALSE, results='hide', echo=FALSE, warning=FALSE, message=FALSE}
require(mosaic)   # Load additional packages here 
require(car)
require(qqplotr)
require(tidyr)
require(dplyr)
require(psych) #for describe()
require(data.table)
require(ggplot2)
require(ggcorrplot)
require(fields)
require(gridExtra)
require(viridis)
require(ggExtra)
require(cowplot)
#require(kableExtra)
require(xtable)
#require(textGrob)
require(ggplot2)
require(gridExtra)
require(grid)
# Some customization.  You can alter or delete as desired (if you know what you are doing).
#trellis.par.set(theme=theme.mosaic()) # change default color scheme for lattice

# use the knitr root.dir option in the setup chunk to change the working directory for notebook chunks.
theme_set(theme_gray())
knitr::opts_chunk$set(
  root.dir="~/MSDS/DS785capstone",
  tidy=FALSE,     # display code as typed
  size="tiny")   # smaller font for code
```

```{r other_pckgs, eval=FALSE, results='hide', echo=FALSE, warning=FALSE, message=FALSE}
#some packages that we don't always need...
#require(ranger)
#require(tree)
#require(rpart.plot)
#require(rpart)
#require(gbm)
#require(forestFloor)
#require(randomForestExplainer)
#require(FNN)
#require(MASS)
require(randomForest)
require(glmnet)
require(EnvStats)
#require(anytime)
#library(statnet) #networks
#library(igraph) #networks
#library(intergraph) #networks
require(fasttime)
#require(fastDummies)
require(survival)
require(survminer)
```

#Overview

Model inpatient length of hospital stay (LOS) as the survival of discharge decisions. Evaluate predictive performance of non-parametric discrete time survival model framework compared to traditional LOS models and identify factors impacting length of stay which could lead to actionable operational insights.

#Data Source

The data used for this analysis represented inpatient (patient class = Inpatient) visits at a single hospital customer where the [attending provider](https://en.wikipedia.org/wiki/Attending_physician) was a Hospitalist at some point during the stay.

Clinical, administrative, and billing data were collected and aggregated by [Agathos](https://www.agathos.io), a physician analytics and performance improvement company, from hospital system [electronic medical records (EMRs)](https://en.wikipedia.org/wiki/Electronic_health_record).

#Data Filters

* Agathos user (hospitalist) is listed as attending provider on case at some point

* patient class is Inpatient

* discharged in 2019

* not deceased

* #TODO - i didn't include this, should i? there is a billing DRG listed on the encounter

* length of stay is greater than .1 days (measured using timestamps, rather than calendar days)

#Why Hospitalists?

The data was limited to [Inpatient patient hospital stays](https://www.medicare.gov/Pubs/pdf/11435-Are-You-an-Inpatient-or-Outpatient.pdf) where an Agathos user, a [hospitalist](https://en.wikipedia.org/wiki/Hospital_medicine), was identified as the attending provider for at least a portion of the case. This means that we will not see cases attended solely by non-hospitalists.

One reason for focusing on the hospitalist group is that the patient cases attended by hospitalists are fundamentally different from those attended by specialists. The workflows of hospitalists within a given hospital system are generally consistent, and the patient care provided by hospitalists is more easily compared to hospitalists peers than to providers with other specialties.

#Hospitalist Background

Hospitalists are usually fully licensed physicians (MD/DO) or a physician fellow (resident/student), but any of a variety of [Advanced practitioners](http://mhmg.memorialhermann.org/about-us/advanced-practice-provider/), whose training is more specialized than a nurse but not as extensive as a full "doctor", could serve as a hospitalist. Advanced practitioners could include Physicians Assistants, Nurse Practitioners, or Advanced Practice Nurses. As the hospitalist medical specialty is relatively new (30 years is "new" when measured at the pace of hospital corporate structure), a hospitalist will often have an official specialty of General Medicine, Internal Medicine, or Family Practice (which complicates the use of provider specialty in relation to hospitalists).

Hospitalists attend the "general" inpatient and observation patient, whereas specialists might attend [peri-natal](https://www.medicinenet.com/script/main/art.asp?articlekey=7898) mothers and infants, for instance. After a surgery, a hospitalist might attend a patient, or a surgeon might keep responsibility for their patient [post-operatively](https://www.who.int/surgery/publications/Postoperativecare.pdf). [ICU](https://en.wikipedia.org/wiki/Intensive_care_unit) patients are generally attended by hospitalists, but some organizations employ [intensivists](https://www.umassmemorialhealthcare.org/umass-memorial-medical-center/services-treatments/critical-care/what-intensivist) who specialize in ICU care.

Note that the terms patient stay, case, visit, and sometimes encounter will be used mostly interchangeably.

#Goal/hypothesis

...

Length of Hospital Stay (LoS) will be used as a proxy measure for the quality and efficiency of patient care, after adjusting for the reason for the patient's visit and general patient acuity (using the billing [Diagnosis Related Group (DRG)](https://hmsa.com/portal/provider/zav_pel.fh.DIA.650.htm) and the specialty/role of the sending (outgoing) provider).

#Data Extraction

###SQL query

TODO: facts_attending is inferior to attendings_actions. Get a pull of attendings actions to use in the future...

```{sql facts_attending_query, eval = FALSE}
WITH users AS (
    select p.id AS user_prov_id
    from dimensions_provider p
        INNER JOIN users_user u ON u.id=p.associated_user_id
    WHERE u.product_module_id = 1 --they are a user of the agathos hospital module
), enc_attended_by_hosp AS (
    select DISTINCT a.encounter_id AS visit_id
    from facts_attending a
       INNER JOIN users u1 ON u1.user_prov_id=a.provider_id
) SELECT
       fa.id,
       fa.encounter_id,
       fe.visit AS visit_id,
       fa.ordinal,
       fa.from_date,
       fa.to_date,
       fe.admission_date,
       fe.inpatient_admit_date,
       fe.discharge_date,
       fa.provider_id,
       prov.team_id,
       prov.provider_type,
       prov.associated_user_id,
       loc.name AS location,
       fe.admission_type,
       fe.acuity_level,
       fe.admission_source,
       fe.patient_class,
       fe.financial_class,
       fe.service,
       fe.total_charges,
       fe.pat_zip_at_disch,
       fe.har_id,
       fe.admitting_provider_id,
       fe.billing_attending_provider_id,
       fe.client_id,
       fe.department_id,
       fe.ed_disposition,
       fe.discharge_disposition_id,
       disp.description AS discharge_disposition,
       fe.discharge_kickoff_provider_id,
       fe.discharging_provider_id,
       fe.ingestion_date,
       edrg.encounter_drg_length_of_stay,
       drg.name AS DRG,
       drg.amlos,
       drg.gmlos
FROM facts_attending fa
    INNER JOIN enc_attended_by_hosp eabh
        ON eabh.visit_id=fa.encounter_id --case involved a hospitalist as attending
  INNER JOIN facts_encounter fe ON fa.encounter_id=fe.id
  INNER JOIN facts_encounterdrg edrg ON edrg.encounter_id=fe.id AND edrg.is_billing='TRUE'
  INNER JOIN dimensions_diagnosisrelatedgroup drg ON drg.id=edrg.drg_id
  INNER JOIN dimensions_provider prov ON fa.provider_id=prov.id
  --LEFT JOIN facts_dischargeorder dischord ON dischord.encounter_id=fe.id
  LEFT JOIN dimensions_location loc ON loc.id=fe.location_id
  LEFT JOIN dimensions_majordiagnosticcategory mdc ON drg.mdc_id=mdc.id
  LEFT JOIN dimensions_dischargedisposition disp ON disp.id=fe.discharge_disposition_id
WHERE drg.id IS NOT NULL
    AND fe.patient_class='Inpatient'
    AND fe.discharge_date > '2019-01-01'
    AND fe.discharge_date < '2020-01-01'
ORDER BY fe.inpatient_admit_date, fa.encounter_id, fa.ordinal
LIMIT 500000;
```

```{sql facts_dischargeorder_query, eval = FALSE}

WITH users AS (
    select p.id AS user_prov_id
    from dimensions_provider p
        INNER JOIN users_user u ON u.id=p.associated_user_id
    WHERE u.product_module_id = 1 --they are a user of the agathos hospitalist module
), enc_attended_by_hosp AS (
    select DISTINCT a.encounter_id AS visit_id
    from facts_attending a
       INNER JOIN users u1 ON u1.user_prov_id=a.provider_id
), enc_atnd_hosp_inrange AS (
    SELECT DISTINCT e.id AS visit_id
    FROM facts_encounter e
      INNER JOIN enc_attended_by_hosp eabh ON eabh.visit_id=e.id
      INNER JOIN facts_encounterdrg edrg ON edrg.encounter_id=e.id AND edrg.is_billing='TRUE'
      INNER JOIN dimensions_diagnosisrelatedgroup drg ON drg.id=edrg.drg_id
    WHERE drg.id IS NOT NULL
      AND e.patient_class='Inpatient'
      AND e.discharge_date > '2019-01-01'
      AND e.discharge_date < '2020-01-01'
)
SELECT
       dischord.encounter_id,
       dischord.authorizing_provider_id,
       dischord.ordering_provider_id,
       dischord.cancel_reason,
       dischord.order_id,
       dischord.expected_discharge_date,
       dischord.order_date
FROM facts_dischargeorder dischord 
  INNER JOIN enc_atnd_hosp_inrange eahi ON dischord.encounter_id=eahi.visit_id
ORDER BY dischord.encounter_id
LIMIT 500000;
```

```{sql view_encounters_query, eval = FALSE}
  SELECT enc.visit_id
, enc.har_id
, enc.appt_serial_number
, enc.visit_type
, enc.appt_type
, enc.ept_id
, enc.pat_zip_at_disch
, enc.appt_made_dt
, enc.appt_confirmed_dttm
, enc.appt_sched_dttm
, enc.ed_arrival_dttm
, enc.admission_dttm
, enc.ed_departure_dttm
, enc.inpatient_admit_dttm
, enc.downgraded_from_inp_dttm
, enc.discharge_dttm
, enc.discharge_kickoff_dttm
, enc.expected_admit_dttm
, enc.expected_disch_dt
, enc.expected_disch_tm
, enc.expected_time_of_disch
, enc.admission_source
, enc.admission_type
, enc.means_of_arrival
, enc.patient_escorted_by
, enc.level_of_care
, enc.acuity_level
, enc.har_base_class
, enc.har_patient_class
, enc.patient_class
, enc.admit_for_surg_yn
, enc.surgical_service
, enc.har_hospital_service
, enc.visit_service
, enc.labor_status
, enc.adt_status
, enc.patient_status
, enc.discharge_disposition
, enc.discharge_destination
, enc.means_of_departure
, enc.dept_id
, enc.dept_name
, enc.dept_specialty
, enc.room_reason
, enc.room_type
, enc.revenue_location
, enc.har_admitting_ser_id
, enc.admitting_ser_id
, enc.discharge_kickoff_user_id
, enc.discharging_ser_id
, enc.bill_atnd_ser_id
, enc.har_atnd_ser_id
, enc.har_coding_status
, enc.coding_dttm
, enc.billing_status
, enc.bill_dt
, enc.har_financial_class
, enc.payor_financial_class
, enc.payor
, enc.selfpay_yn
, enc.do_not_bill_ins_yn
, enc.selfpay_satus
, enc.adjusted_charges
, enc.total_charges
, enc.num_charges
, enc.har_drg_qualifier
, enc.drg_line
, enc.drg_id
, enc.drg_code
, enc.drg_name
, enc.drg_type
, enc.drg_is_billing
, enc.drg_qualifier
, enc.drg_mdc_code
, enc.drg_amlos
, enc.drg_gmlos
, enc.drg_weight
, enc.drg_length_of_stay
, enc.patient_status_for_drg
, enc.drg_severity_of_illness
, enc.drg_risk_of_mortality
, enc.prim_prob_lpl_id
, enc.bill_drg_idtype_id
, enc.bill_drg_amlos
, enc.bill_drg_gmlos
, enc.infection_list
, enc.isolation_list
, enc.incident_date_list
, enc.visit_dx_count
, enc.pain_score
, enc.pain_score_scale
, enc.vitals_taken_dttm
, enc.temperature
, enc.pulse
, enc.spo2
, enc.temperature_source
, enc.temperature_comments
, enc.temperature_source_comments
, enc.pulse_comments
, enc.spo2_comments
, enc.bp
, enc.bp_systolic
, enc.bp_diastolic
, enc.bp_comments
, enc.respirations
, enc.respirations_comments
, enc.peak_lung_flow
, enc.height
, enc.weight
, enc.weight_comments
, enc.bmi
, enc.bsa
, enc.delivery_method
, enc.deliver_this_visit_yn
, enc.tobacco_use_yn
, enc.disch_instruct_note_id
, enc.expected_length_of_stay
, enc.created_by_or_yn
, enc.sequential_visit_yn
, enc.interface_comment
, enc.external_billing_id
, enc.drg_type_c
, enc.file
  FROM Sentara.view_encounters enc
  WHERE enc.drg_is_billing='Y'
      AND enc.patient_class like '%Inpatient%'
      AND enc.discharge_dttm > '2019-01-01'
      AND enc.discharge_dttm < '2020-01-01'
      
SELECT enc.visit_id
     , enc.har_id
     , enc.appt_serial_number
     , enc.visit_type
     , enc.appt_type
     , enc.ept_id
     , enc.pat_zip_at_disch
     , enc.appt_made_dt
     , enc.appt_confirmed_dttm
     , enc.appt_sched_dttm
     , enc.ed_arrival_dttm
     , enc.admission_dttm
     , enc.ed_departure_dttm
     , enc.inpatient_admit_dttm
     , enc.downgraded_from_inp_dttm
     , enc.discharge_dttm
     , enc.discharge_kickoff_dttm
     , enc.expected_admit_dttm
     , enc.expected_disch_dt
     , enc.expected_disch_tm
     , enc.expected_time_of_disch
     , enc.admission_source
     , enc.admission_type
     , enc.means_of_arrival
     , enc.patient_escorted_by
     , enc.level_of_care
     , enc.acuity_level
     , enc.har_base_class
     , enc.har_patient_class
     , enc.patient_class
     , enc.admit_for_surg_yn
     , enc.surgical_service
     , enc.har_hospital_service
     , enc.visit_service
     , enc.labor_status
     , enc.adt_status
     , enc.patient_status
     , enc.discharge_disposition
     , enc.discharge_destination
     , enc.means_of_departure
     , enc.dept_id
     , enc.dept_name
     , enc.dept_specialty
     , enc.room_reason
     , enc.room_type
     , enc.revenue_location
     , enc.har_admitting_ser_id
     , enc.admitting_ser_id
     , enc.discharge_kickoff_user_id
     , enc.discharging_ser_id
     , enc.bill_atnd_ser_id
     , enc.har_atnd_ser_id
     , enc.har_coding_status
     , enc.coding_dttm
     , enc.billing_status
     , enc.bill_dt
     , enc.har_financial_class
     , enc.payor_financial_class
     , enc.payor
     , enc.selfpay_yn
     , enc.do_not_bill_ins_yn
     , enc.selfpay_satus
     , enc.adjusted_charges
     , enc.total_charges
     , enc.num_charges
     , enc.har_drg_qualifier
     , enc.drg_line
     , enc.drg_id
     , enc.drg_code
     , enc.drg_name
     , enc.drg_type
     , enc.drg_is_billing
     , enc.drg_qualifier
     , enc.drg_mdc_code
     , enc.drg_amlos
     , enc.drg_gmlos
     , enc.drg_weight
     , enc.drg_length_of_stay
     , enc.patient_status_for_drg
     , enc.drg_severity_of_illness
     , enc.drg_risk_of_mortality
     , enc.prim_prob_lpl_id
     --, enc.bill_drg_idtype_id
     , ''
     --, enc.bill_drg_amlos
     ,''
     ,''
     --, enc.bill_drg_gmlos
     , enc.infection_list
     , enc.isolation_list
     , enc.incident_date_list
     , enc.visit_dx_count
     , enc.pain_score
     , enc.pain_score_scale
     , enc.vitals_taken_dttm
     , enc.temperature
     , enc.pulse
     , enc.spo2
     , enc.temperature_source
     , enc.temperature_comments
     , enc.temperature_source_comments
     , enc.pulse_comments
     , enc.spo2_comments
     , enc.bp
     , enc.bp_systolic
     , enc.bp_diastolic
     , enc.bp_comments
     , enc.respirations
     , enc.respirations_comments
     , enc.peak_lung_flow
     , enc.height
     , enc.weight
     , enc.weight_comments
     , enc.bmi
     , enc.bsa
     , enc.delivery_method
     , enc.deliver_this_visit_yn
     , enc.tobacco_use_yn
     , enc.disch_instruct_note_id
     , enc.expected_length_of_stay
     , enc.created_by_or_yn
     , enc.sequential_visit_yn
     , enc.interface_comment
     , enc.external_billing_id
     --, enc.drg_type_c
     , ''
     , enc.file
    --
    , enc.hospital_service_at_admit
    , enc.hospital_service_at_inp_admit
    , enc.hospital_service_at_discharge
    , enc.admit_dept_specialty
    , enc.admit_dept
    , enc.admit_accommodation
     , enc.inp_admit_dept_specialty
     , enc.inp_admit_dept
     , enc.inp_admit_accommodation
    , enc.inp_admit_level_of_care
     , enc.discharge_dept_specialty
     , enc.discharge_dept
     , enc.discharge_accommodation
     , enc.disch_level_of_care
    , enc.bed_type
    , enc.room_accommodation
, enc.cdi_specialist_info
, enc.har_drg_code
, enc.har_drg_qualifier
, enc.msdrg_family_c
, enc.adt_events

FROM TGH.view_encounters enc
WHERE enc.drg_is_billing='Y'
  AND enc.patient_class like '%Inpatient%'
  AND enc.discharge_dttm > '2019-01-01'
  AND enc.discharge_dttm < '2020-01-01'
  
select adt.visit_id
     , adt.adt_id
     , adt.event_type
     , adt.patient_class
     , adt.from_base_class
     , adt.to_base_class
     , adt.level_of_care
     , adt.accommodation
     , adt.adt_dttm
     , adt.adt_user_id
     , adt.adt_dept_id
FROM tgh.view_adt_events adt
    INNER JOIN tgh.view_encounters enc ON enc.visit_id=adt.visit_id
WHERE enc.drg_is_billing='Y'
  AND enc.patient_class like '%Inpatient%'
  AND enc.discharge_dttm > '2019-01-01'
  	
select dep.department_id
    , dep.external_name
    , dep.dept_specialty
    , dep.rev_loc_id
    , dep.adt_parent_id
    , dep.adt_unit_type
    , dep.or_unit_type
    , dep.is_periop_dep_yn
    , dep.inpatient_dept_yn
    , dep.dept_ed_type
    , dep.icu_dept_yn
from tgh.view_departments dep

select distinct p.* from tgh.view_patients p
INNER JOIN tgh.view_encounters enc ON enc.ept_id=p.ept_id
WHERE enc.patient_class like '%Inpatient%'
  AND enc.discharge_dttm > '2018-01-01'
  AND enc.discharge_dttm < '2020-10-01'
  
  select * from facts_encounter fe
WHERE fe.patient_class='Inpatient'
  AND fe.discharge_date > '2019-01-01'
  AND fe.discharge_date < '2020-01-01'
```

```{sql view_all_enc_by_drg_query, eval = FALSE}
WITH drg_type_priority AS (
    SELECT drg_type,
           --you could just load this from a table/csv that was manually created
           --I reviewed all the drg_types at TGH before trusting the string parsing
           CASE WHEN drg_type like '%CMS%' THEN '1^CMS'
                WHEN drg_type like '%APR%' THEN '2^APR'
                ELSE '3^OTHER' END AS type_priority
    FROM (SELECT DISTINCT enc.drg_type FROM TGH.view_encounters enc)
    ORDER BY type_priority, drg_type DESC
)
SELECT * --count(distinct visit_id), count(*) --840368,840368
FROM (
         SELECT enc.visit_id
                , enc.har_id
                , enc.appt_serial_number
                , enc.visit_type
                , enc.appt_type
                , enc.ept_id
                , enc.pat_zip_at_disch
                , enc.appt_made_dt
                , enc.appt_confirmed_dttm
                , enc.appt_sched_dttm
                , enc.ed_arrival_dttm
                , enc.admission_dttm
                , enc.ed_departure_dttm
                , enc.inpatient_admit_dttm
                , enc.downgraded_from_inp_dttm
                , enc.discharge_dttm
                , enc.discharge_kickoff_dttm
                , enc.expected_admit_dttm
                , enc.expected_disch_dt
                , enc.expected_disch_tm
                , enc.expected_time_of_disch
                , enc.admission_source
                , enc.admission_type
                , enc.means_of_arrival
                , enc.patient_escorted_by
                , enc.level_of_care
                , enc.acuity_level
                , enc.har_base_class
                , enc.har_patient_class
                , enc.patient_class
                , enc.admit_for_surg_yn
                , enc.surgical_service
                , enc.har_hospital_service
                , enc.visit_service
                , enc.labor_status
                , enc.adt_status
                , enc.patient_status
                , enc.discharge_disposition
                , enc.discharge_destination
                , enc.means_of_departure
                , enc.dept_id
                , enc.dept_name
                , enc.dept_specialty
                , enc.room_reason
                , enc.room_type
                , enc.revenue_location
                , enc.har_admitting_ser_id
                , enc.admitting_ser_id
                , enc.discharge_kickoff_user_id
                , enc.discharging_ser_id
                , enc.bill_atnd_ser_id
                , enc.har_atnd_ser_id
                , enc.har_coding_status
                , enc.coding_dttm
                , enc.billing_status
                , enc.bill_dt
                , enc.har_financial_class
                , enc.payor_financial_class
                , enc.payor
                , enc.selfpay_yn
                , enc.do_not_bill_ins_yn
                , enc.selfpay_satus
                , enc.adjusted_charges
                , enc.total_charges
                , enc.num_charges
                , enc.har_drg_code
                , enc.har_drg_qualifier
                , enc.msdrg_family_c
                , enc.drg_line
                , enc.drg_id
                , enc.drg_code
                , enc.drg_name
                , enc.drg_type
                , enc.drg_is_billing
                , enc.drg_qualifier
                , enc.drg_mdc_code
                , enc.drg_amlos
                , enc.drg_gmlos
                , enc.drg_weight
                , enc.drg_length_of_stay
                , enc.patient_status_for_drg
                , enc.drg_severity_of_illness
                , enc.drg_risk_of_mortality
                , enc.prim_prob_lpl_id
                , enc.infection_list
                , enc.isolation_list
                , enc.incident_date_list
                , enc.visit_dx_count
                , enc.pain_score
                , enc.pain_score_scale
                , enc.vitals_taken_dttm
                , enc.temperature
                , enc.pulse
                , enc.spo2
                , enc.temperature_source
                , enc.temperature_comments
                , enc.temperature_source_comments
                , enc.pulse_comments
                , enc.spo2_comments
                , enc.bp
                , enc.bp_systolic
                , enc.bp_diastolic
                , enc.bp_comments
                , enc.respirations
                , enc.respirations_comments
                , enc.peak_lung_flow
                , enc.height
                , enc.weight
                , enc.weight_comments
                , enc.bmi
                , enc.bsa
                , enc.delivery_method
                , enc.deliver_this_visit_yn
                , enc.tobacco_use_yn
                , enc.disch_instruct_note_id
                , enc.expected_length_of_stay
                , enc.created_by_or_yn
                , enc.sequential_visit_yn
                , enc.interface_comment
                , enc.external_billing_id
                , enc.file
                , enc.hospital_service_at_admit
                , enc.hospital_service_at_inp_admit
                , enc.hospital_service_at_discharge
                , enc.admit_dept_specialty
                , enc.admit_dept
                , enc.admit_accommodation
                , enc.inp_admit_dept_specialty
                , enc.inp_admit_dept
                , enc.inp_admit_accommodation
                , enc.inp_admit_level_of_care
                , enc.discharge_dept_specialty
                , enc.discharge_dept
                , enc.discharge_accommodation
                , enc.disch_level_of_care
                , enc.bed_type
                , enc.room_accommodation
                , enc.cdi_specialist_info
                , enc.adt_events
                , ROW_NUMBER() OVER(PARTITION BY visit_id ORDER BY enc.visit_id,pri.type_priority,enc.drg_line) rn
              ---> this gives a row number for each visit_id sorted by drg type priority
         FROM TGH.view_encounters enc
             LEFT JOIN drg_type_priority pri ON enc.drg_type=pri.drg_type
              ---> using this for sorting and conveniently null sorts last
         WHERE enc.discharge_dttm > '2018-01-01'
           AND enc.discharge_dttm < '2020-02-01'
           AND enc.visit_type <> '2505^Erroneous Encounter'
           AND (har_drg_code IS NULL --keep rows where there is no billing DRG for the whole visit
             OR enc.drg_is_billing='Y') --or this row is the billing drg
     ) a
WHERE rn = 1; --when there is not a billing DRG, get the first row, prioritizing CMS, then APR, ELSE just by drg_line

/*
har_base_class,base_class_before_discharge,visit_type,count(*)
,,51^Surgery,104294
1^Inpatient,4^Observation,3^Hospital Encounter,985
1^Inpatient,3^Emergency,3^Hospital Encounter,407
2^Outpatient,3^Emergency,3^Hospital Encounter,54
,1^Inpatient,3^Hospital Encounter,27
1^Inpatient,2^Outpatient,3^Hospital Encounter,83839
3^Emergency,,3^Hospital Encounter,15
,2^Outpatient,3^Hospital Encounter,223
2^Outpatient,0^Direct,3^Hospital Encounter,5
,3^Emergency,3^Hospital Encounter,2
,4^Observation,3^Hospital Encounter,4
3^Emergency,1^Inpatient,3^Hospital Encounter,1
2^Outpatient,2^Outpatient,3^Hospital Encounter,418525
1^Inpatient,1^Inpatient,3^Hospital Encounter,1051770
2^Outpatient,4^Observation,3^Hospital Encounter,65617
1^Inpatient,,3^Hospital Encounter,735
3^Emergency,3^Emergency,3^Hospital Encounter,160612
,,3^Hospital Encounter,2485
2^Outpatient,,3^Hospital Encounter,2626
2^Outpatient,1^Inpatient,3^Hospital Encounter,159
3^Emergency,2^Outpatient,3^Hospital Encounter,63
3^Emergency,4^Observation,3^Hospital Encounter,2
2^Outpatient,2^Outpatient,2505^Erroneous Encounter,1
WHERE enc.discharge_dttm > '2018-01-01'
  AND enc.discharge_dttm < '2020-02-01'
*/
```

```{sql view_procedure_orders_query, eval = FALSE}
  SELECT ord.*
  FROM sentara.view_procedure_orders ord
      INNER JOIN sentara.view_encounters enc ON enc.visit_id=ord.visit_id
  WHERE enc.drg_is_billing='Y'
      AND enc.patient_class like '%Inpatient%'
      AND enc.discharge_dttm > '2019-01-01'
      AND enc.discharge_dttm < '2020-01-01';
```

```{r headers, cache=FALSE, results='hide', echo=FALSE, warning=FALSE, message=FALSE}
fa_headers <- c("fa_id",
  "encounter_id",
  "visit_id",
  "fa_ordinal",
  "fa_from_dt",
  "fa_to_dt",
  "admit_dt",
  "inpatient_admit_dt",
  "discharge_dt",
  "fa_prov_id",
  "fa_prov_team_id",
  "fa_prov_type",
  "fa_prov_user_id",
  "location",
  "admission_type",
  "fe_acuity_level",
  "fe_admission_source",
  "fe_patient_class",
  "fe_financial_class",
  "fe_service",
  "fe_total_charges",
  "fe_pat_zip_at_disch",
  "har_id",
  "admit_prov_id",
  "bill_attend_prov_id",
  "client_id",
  "fe_dep_id",
  "ed_disposition",
  "disch_disposition_id",
  "disch_disposition,",
  "disch_kickoff_prov_id",
  "disch_prov_id",
  "fe_ingestion_dt",
  "drg_los",
  "drg_name",
  "drg_amlos",
  "drg_gmlos")

do_headers <- c(
  "dischord_encounter_id",
  "dischord_auth_prov_id",
  "dischord_ord_prov_id",
  "dischord_cancel_reason",
  "dischord_order_id",
  "dischord_expected_disch_dt",
  "dischord_ord_dt"
)

enc_headers <- c(
   "e_visit_id"
 , "e_har_id"
 , "e_appt_serial_number"
 , "e_visit_type"
 , "e_appt_type"
 , "e_ept_id"
 , "e_pat_zip_at_disch"
 , "e_appt_made_dt"
 , "e_appt_confirmed_dttm"
 , "e_appt_sched_dttm"
 , "e_ed_arrival_dttm"
 , "e_admission_dttm"
 , "e_ed_departure_dttm"
 , "e_inpatient_admit_dttm"
 , "e_downgraded_from_inp_dttm"
 , "e_discharge_dttm"
 , "e_discharge_kickoff_dttm"
 , "e_expected_admit_dttm"
 , "e_expected_disch_dt"
 , "e_expected_disch_tm"
 , "e_expected_time_of_disch"
 , "e_admission_source"
 , "e_admission_type"
 , "e_means_of_arrival"
 , "e_patient_escorted_by"
 , "e_level_of_care"
 , "e_acuity_level"
 , "e_har_base_class"
 , "e_har_patient_class"
 , "e_patient_class"
 , "e_admit_for_surg_yn"
 , "e_surgical_service"
 , "e_har_hospital_service"
 , "e_visit_service"
 , "e_labor_status"
 , "e_adt_status"
 , "e_patient_status"
 , "e_discharge_disposition"
 , "e_discharge_destination"
 , "e_means_of_departure"
 , "e_dept_id"
 , "e_dept_name"
 , "e_dept_specialty"
 , "e_room_reason"
 , "e_room_type"
 , "e_revenue_location"
 , "e_har_admitting_ser_id"
 , "e_admitting_ser_id"
 , "e_discharge_kickoff_user_id"
 , "e_discharging_ser_id"
 , "e_bill_atnd_ser_id"
 , "e_har_atnd_ser_id"
 , "e_har_coding_status"
 , "e_coding_dttm"
 , "e_billing_status"
 , "e_bill_dt"
 , "e_har_financial_class"
 , "e_payor_financial_class"
 , "e_payor"
 , "e_selfpay_yn"
 , "e_do_not_bill_ins_yn"
 , "e_selfpay_satus"
 , "e_adjusted_charges"
 , "e_total_charges"
 , "e_num_charges"
 , "e_har_drg_qualifier"
 , "e_drg_line"
 , "e_drg_id"
 , "e_drg_code"
 , "e_drg_name"
 , "e_drg_type"
 , "e_drg_is_billing"
 , "e_drg_qualifier"
 , "e_drg_mdc_code"
 , "e_drg_amlos"
 , "e_drg_gmlos"
 , "e_drg_weight"
 , "e_drg_length_of_stay"
 , "e_patient_status_for_drg"
 , "e_drg_severity_of_illness"
 , "e_drg_risk_of_mortality"
 , "e_prim_prob_lpl_id"
 , "e_bill_drg_idtype_id"
 , "e_bill_drg_amlos"
 , "e_bill_drg_gmlos"
 , "e_infection_list"
 , "e_isolation_list"
 , "e_incident_date_list"
 , "e_visit_dx_count"
 , "e_pain_score"
 , "e_pain_score_scale"
 , "e_vitals_taken_dttm"
 , "e_temperature"
 , "e_pulse"
 , "e_spo2"
 , "e_temperature_source"
 , "e_temperature_comments"
 , "e_temperature_source_comments"
 , "e_pulse_comments"
 , "e_spo2_comments"
 , "e_bp"
 , "e_bp_systolic"
 , "e_bp_diastolic"
 , "e_bp_comments"
 , "e_respirations"
 , "e_respirations_comments"
 , "e_peak_lung_flow"
 , "e_height"
 , "e_weight"
 , "e_weight_comments"
 , "e_bmi"
 , "e_bsa"
 , "e_delivery_method"
 , "e_deliver_this_visit_yn"
 , "e_tobacco_use_yn"
 , "e_disch_instruct_note_id"
 , "e_expected_length_of_stay"
 , "e_created_by_or_yn"
 , "e_sequential_visit_yn"
 , "e_interface_comment"
 , "e_external_billing_id"
 , "e_drg_type_c"
 , "e_file"
 #####---
, "e_hospital_service_at_admit"
, "e_hospital_service_at_inp_admit"
, "e_hospital_service_at_discharge"
, "e_admit_dept_specialty"
, "e_admit_dept"
, "e_admit_accommodation"
, "e_inp_admit_dept_specialty"
, "e_inp_admit_dept"
, "e_inp_admit_accommodation"
, "e_inp_admit_level_of_care"
, "e_discharge_dept_specialty"
, "e_discharge_dept"
, "e_discharge_accommodation"
, "e_disch_level_of_care"
, "e_bed_type"
, "e_room_accommodation"
, "e_cdi_specialist_info"
, "e_har_drg_code"
, "e_har_drg_qualifier"
, "e_msdrg_family_c"
, "e_adt_events"
)
```

#Load and clean data

Load data from file -- then take a look at some of the rows.

```{r load_data_1, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
#daily_encounter <- read.csv("~/MSDS/DS785capstone/PHI_data/sentara_user_facts_attending_2019.csv", col.names=fa_headers)
#~/MSDS/DS785capstone/PHI_data/TGH
#daily_encounter <- read.csv("PHI_data/TGH/TGH_2019_facts_attending_hosp_user.csv", col.names=fa_headers)
#dischord <- read.csv("PHI_data/TGH/disch_ord_TGH_2019.csv", col.names=do_headers)
dischord <- read.csv("PHI_data/TGH/facts_dischargeorderTGH2018_2019.csv", col.names=do_headers, header=TRUE)
#enc.raw <- read.csv("PHI_data/TGH/view_encounters_TGH_2019.csv", col.names=enc_headers) 
#dim(enc.raw) #47189   144
#uniqueN(enc.raw, by="e_visit_id") #47189
daily_atnd <- read.csv("PHI_data/TGH/primary_attendings_TGH_2019.csv", header=TRUE)
dim(daily_atnd) #663909     28
#facts_enc <- read.csv("~/MSDS/DS785capstone/PHI_data/TGH/facts_encounter2019.csv", header=TRUE)
#dim(facts_enc) #46088    29
facts_enc <- read.csv("PHI_data/TGH/facts_encounter_2018_thru_2019.csv", header=TRUE)
dim(facts_enc) #89303 28
```
```{r load_data_adt_events, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
#adt_events <- read.csv("~/MSDS/DS785capstone/PHI_data/TGH/TGH_adt_events_2019.csv", header=TRUE)
adt_events <- read.csv("PHI_data/TGH/TGH_adt_events_2019.csv", header=TRUE)
dim(adt_events) #950561     11
#dept <- read.csv("~/MSDS/DS785capstone/PHI_data/TGH/TGH_depts.csv", header=TRUE)
dept <- read.csv("PHI_data/TGH/TGH_depts.csv", header=TRUE)
dim(dept) #1141   11
#pat.raw <- read.csv("~/MSDS/DS785capstone/PHI_data/TGH/view_patients_2019enc.csv", header=TRUE)
#pat.raw <- read.csv("PHI_data/TGH/view_patients_2019enc.csv", header=TRUE); dim(pat.raw) #48542   170
pat.raw <- read.csv("PHI_data/TGH/view_patients2018to2020oct.csv", header=TRUE)
dim(pat.raw) #83373   170
```

```{r}
enc.full <- read.csv("PHI_data/TGH/view_enc_full_2018to2020feb.csv", header=TRUE)
dim(enc.full) #83373   170
```


```{r eval=FALSE}
#TODO:
zip_health20 <- read.csv("PLACES__Local_Data_for_Better_Health__ZCTA_Data_2020_release.csv", header=TRUE)
zip_income18 <- read.csv("18zpallagi.csv", header=TRUE)
```


```{r}
#load admit DRGs, use to predict final DRG

# false,,124392
# false,1^HAC Dx Included,94435
# false,5^Admission DRG,94413
# false,7^PPC Admit DRG,47192
# false,6^PPC DRG,47192
# false,2^Analyzed DRG,2590
# true,2^Analyzed DRG,37266
# true,,9914
# true,1^HAC Dx Included,8
# true,5^Admission DRG,3
```

##Attending Data

###Refine data filters

```{r atnd_in_facts_enc, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
#TODO: make sure we aren't dropping vists that we want here...no patient_class in the primary_attendings data
# assess primary attending records that are no in facts_enc
dim(daily_atnd) #663909     28
temp_atnd <- daily_atnd[!(daily_atnd$encounter_id %in% facts_enc$id),]
dim(temp_atnd) #378976     28
uniqueN(temp_atnd, by="encounter_id") #290936
dim(temp_atnd[which(!is.na(temp_atnd$associated_user_id)),]) # 109138     28
uniqueN(temp_atnd[which(!is.na(temp_atnd$associated_user_id)),], by="encounter_id") #84802
min(temp_atnd$admission_date) #"2018-07-23 18:07:00-04:00"
max(temp_atnd$discharge_date) #"2020-01-01 18:58:00-05:00"
temp_atnd <- NULL
```

Starting with primary attending data from Agathos module, join 2019 inpatient facts encounters. 

```{r atnd_in_facts_enc, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
#limiting to only visits touched by agathos hospitalist module users
atnd <- daily_atnd[(daily_atnd$encounter_id %in% facts_enc$id),]
dim(atnd) #284440     28, 284933     28

atnd.col.names <- c("index","id_x","id_y")
atnd.cols <- which(colnames(atnd) %in% atnd.col.names)
fe.col.names <- c("admission_date","discharge_date","code_version")
fe.cols <- which(colnames(facts_enc) %in% fe.col.names)
atnd.df <- atnd[,-atnd.cols] %>%
  left_join(facts_enc[,-fe.cols], by=c('encounter_id'='id'), suffix=c(".x",".y"))
dim(atnd.df) #284440     50,  284933     49
atnd <- NULL
daily_atnd <- NULL
```

####Assess data volumes

```{r atnd_assess_volume, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
require(data.table)
#uniqueN(daily_encounter[c('encounter_id')], by=c('encounter_id'))
#number of visits in facts_attending, sentara 2019: 17120, TGH 2019: 24480
#dim(daily_encounter)[1]
#number of rows in facts_attending, sentara 2019: 72139, TGH 2019: 81315
#these are both way less than actual number of visits.

#TODO: decide how to handle visits without a discharge order
#nunber of encounters in discharge order table, sentara 2019: 16328, TGH 2019: 23463
uniqueN( dischord[c('dischord_encounter_id')], by=c('dischord_encounter_id'))
#number of discharge orders in discharge order table, sentara 2019: 42056, TGH 2019: 56775
uniqueN(dischord[c('dischord_order_id')], by=c('dischord_order_id'))
dim(dischord)[1] #number of rows in discharge order table, sentara 2019: 42056, TGH 2019: 56775

uniqueN(atnd.df[c('encounter_id')], by=c('encounter_id')) 
#number of visits in primary attending data for inpatients TGH: 44253 (was 44339 in earlier data pulll)
dim(atnd.df)[1] 
#number of rows in primary attending data for inpatients TGH: 284440 (was 284933 in earlier data pull)
uniqueN(atnd.df[which(!is.na(atnd.df$associated_user_id)),], by="encounter_id") #25550
#this means currently there are 19k vists that have no Agathos user in any primary attending row.

#TODO: decide if the data should be limited to Agathos users/Hospitalists

#uniqueN(enc.raw[c(1)], by=c(1)) #number of visits in view_encounters, sentara 2019: 137085, TGH: 47189
#dim(enc.raw)[1] #number of rows in view_encounters Inpatient with, sentara 2019: 137085, TGH: 47189
uniqueN(enc.full[c(1)], by=c(1)) #number of visits in view_encounters TGH 2018 to feb 2020: 840368
dim(enc.full)[1] #840368
```

###Initial cleaning of data

```{r atnd_date_cleaning, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
require(data.table)
if (length(atnd.df[which(atnd.df$attending_to_date == ""),]$attending_to_date) > 0) {
  atnd.df[which(atnd.df$attending_to_date == ""),]$attending_to_date <- NA }
if (length(atnd.df[which(atnd.df$attending_from_date == ""),]$attending_from_date) > 0) {
  atnd.df[which(atnd.df$attending_from_date == ""),]$attending_from_date <- NA }
if (length(atnd.df[which(atnd.df$inpatient_admit_date == ""),]$inpatient_admit_date) > 0) {
  atnd.df[which(atnd.df$inpatient_admit_date == ""),]$inpatient_admit_date <- NA }

atnd.tbl <- data.table(atnd.df)

library("fasttime")
#https://cran.r-project.org/web/packages/fasttime/fasttime.pdf
atnd.tbl$inpatient_admit_date <- strftime(fastPOSIXct(atnd.tbl$inpatient_admit_date, tz="America/Detroit"))#, usetz = TRUE)
atnd.tbl$admission_date <- strftime(atnd.tbl$admission_date, tz="America/Detroit")
atnd.tbl$discharge_date <- strftime(atnd.tbl$discharge_date, tz="America/Detroit")
atnd.tbl$attending_to_date <-strftime(atnd.tbl$attending_to_date, tz="America/Detroit")
atnd.tbl$attending_from_date <-strftime(atnd.tbl$attending_from_date, tz="America/Detroit")
atnd.tbl$ingestion_date <- as.Date(atnd.tbl$ingestion_date)
atnd.tbl$date <- as.Date(atnd.tbl$date)
atnd.tbl$created_at <- strftime(atnd.tbl$created_at, tz="America/Detroit")
atnd.tbl$updated_at <- strftime(atnd.tbl$updated_at, tz="America/Detroit")

atnd.tbl$LengthOfStay <-  (as.numeric(as.POSIXct(atnd.tbl$discharge_date)) - as.numeric(as.POSIXct(atnd.tbl$inpatient_admit_date))) / (60*60*24)

atnd.tbl.sorted <- atnd.tbl[order(encounter_id, ordinal_day),] 
#Note: using primary attending data will enforce exactly one record in the table for each visit-day # Don
head(atnd.tbl)
head(atnd.tbl.sorted)
atnd.tbl <- NULL
```

##Discharge Orders

```{r disch_ord_date_cleaning, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
dischord.tbl <- data.table(dischord)
dischord.tbl$dischord_expected_disch_dt <- fastPOSIXct(dischord.tbl$dischord_expected_disch_dt, tz="America/Detroit")
dischord.tbl$dischord_ord_dt <- fastPOSIXct(dischord.tbl$dischord_ord_dt, tz="America/Detroit")
head(dischord.tbl)
```

##Encounters/Visits/Stays

```{r enc_date_cleaning, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
# require(fasttime)
# enc <- enc.raw
# enc[which(enc$e_appt_confirmed_dttm == ""),]$e_appt_confirmed_dttm <- NA
# enc[which(enc$e_appt_sched_dttm == ""),]$e_appt_sched_dttm <- NA
# enc[which(enc$e_ed_arrival_dttm == ""),]$e_ed_arrival_dttm <- NA
# enc[which(enc$e_ed_departure_dttm == ""),]$e_ed_departure_dttm <- NA
# enc[which(enc$e_inpatient_admit_dttm == ""),]$e_inpatient_admit_dttm <- NA
# enc[which(enc$e_downgraded_from_inp_dttm == ""),]$e_downgraded_from_inp_dttm <- NA
# enc[which(enc$e_discharge_kickoff_dttm == ""),]$e_discharge_kickoff_dttm <- NA
# enc[which(enc$e_vitals_taken_dttm == ""),]$e_vitals_taken_dttm <- NA
# enc[which(enc$e_expected_admit_dttm == ""),]$e_expected_admit_dttm <- NA
# 
# enc$e_appt_confirmed_dttm <- strftime(enc$e_appt_confirmed_dttm, tz="America/Detroit")
# enc$e_appt_sched_dttm <- strftime(enc$e_appt_sched_dttm, tz="America/Detroit")
# enc$e_ed_arrival_dttm <- strftime(enc$e_ed_arrival_dttm, tz="America/Detroit")
# enc$e_admission_dttm <- strftime(enc$e_admission_dttm, tz="America/Detroit")
# enc$e_ed_departure_dttm <- strftime(enc$e_ed_departure_dttm, tz="America/Detroit")
# enc$e_inpatient_admit_dttm <- strftime(enc$e_inpatient_admit_dttm, tz="America/Detroit")
# enc$e_downgraded_from_inp_dttm <- strftime(enc$e_downgraded_from_inp_dttm, tz="America/Detroit")
# enc$e_discharge_dttm <- strftime(enc$e_discharge_dttm, tz="America/Detroit")
# enc$e_discharge_kickoff_dttm <- strftime(enc$e_discharge_kickoff_dttm, tz="America/Detroit")
# enc$e_expected_admit_dttm <- strftime(enc$e_expected_admit_dttm, tz="America/Detroit")
# enc$e_coding_dttm <- strftime(enc$e_coding_dttm, tz="America/Detroit")
# enc$e_vitals_taken_dttm <- strftime(enc$e_vitals_taken_dttm, tz="America/Detroit")
# enc$e_expected_disch_dt <- as.Date(enc$e_expected_disch_dt)
# 
# enc[which(enc$e_expected_disch_tm == ""),]$e_expected_disch_tm <- NA
# temp_time <- enc$e_expected_disch_tm
# temp_time[which(!is.na(temp_time))] <- paste("2000-01-01",enc$e_expected_disch_tm[which(enc$e_expected_disch_tm!="")],sep="")
# temp_time <- strftime(temp_time)
# enc$e_expected_disch_tm <- as.numeric(format(fastPOSIXct(temp_time), format="%H"))
# temp_time <- NULL
```

```{r enc_full_date_cleaning, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
require(fasttime)
#enc <- enc.raw
enc <- enc.full
enc[which(enc$appt_confirmed_dttm == ""),]$appt_confirmed_dttm <- NA
enc[which(enc$appt_sched_dttm == ""),]$appt_sched_dttm <- NA
enc[which(enc$ed_arrival_dttm == ""),]$ed_arrival_dttm <- NA
enc[which(enc$ed_departure_dttm == ""),]$ed_departure_dttm <- NA
enc[which(enc$inpatient_admit_dttm == ""),]$inpatient_admit_dttm <- NA
enc[which(enc$downgraded_from_inp_dttm == ""),]$downgraded_from_inp_dttm <- NA
enc[which(enc$discharge_kickoff_dttm == ""),]$discharge_kickoff_dttm <- NA
enc[which(enc$vitals_taken_dttm == ""),]$vitals_taken_dttm <- NA
enc[which(enc$expected_admit_dttm == ""),]$expected_admit_dttm <- NA
enc[which(enc$admission_dttm == ""),]$admission_dttm <- NA
enc[which(enc$coding_dttm == ""),]$coding_dttm <- NA
enc[which(enc$expected_disch_dt == ""),]$expected_disch_dt <- NA

enc$appt_confirmed_dttm <- strftime(enc$appt_confirmed_dttm, tz="America/Detroit")
enc$appt_sched_dttm <- strftime(enc$appt_sched_dttm, tz="America/Detroit")
enc$ed_arrival_dttm <- strftime(enc$ed_arrival_dttm, tz="America/Detroit")
enc$admission_dttm <- strftime(enc$admission_dttm, tz="America/Detroit")
enc$ed_departure_dttm <- strftime(enc$ed_departure_dttm, tz="America/Detroit")
enc$inpatient_admit_dttm <- strftime(enc$inpatient_admit_dttm, tz="America/Detroit")
enc$downgraded_from_inp_dttm <- strftime(enc$downgraded_from_inp_dttm, tz="America/Detroit")
enc$discharge_dttm <- strftime(enc$discharge_dttm, tz="America/Detroit")
enc$discharge_kickoff_dttm <- strftime(enc$discharge_kickoff_dttm, tz="America/Detroit")
enc$expected_admit_dttm <- strftime(enc$expected_admit_dttm, tz="America/Detroit")
enc$coding_dttm <- strftime(enc$coding_dttm, tz="America/Detroit")
enc$vitals_taken_dttm <- strftime(enc$vitals_taken_dttm, tz="America/Detroit")
enc$expected_disch_dt <- as.Date(enc$expected_disch_dt)

enc[which(enc$expected_disch_tm == ""),]$expected_disch_tm <- NA
temp_time <- enc$expected_disch_tm
temp_time[which(!is.na(temp_time))] <- paste("2000-01-01",enc$expected_disch_tm[which(enc$expected_disch_tm!="")],sep="")
temp_time <- strftime(temp_time)
enc$expected_disch_tm <- as.numeric(format(fastPOSIXct(temp_time), format="%H"))
temp_time <- NULL
```

use this for sentara...it handles timezones differently.

```{r sort_data, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
# require(data.table)
# daily_encounter.tbl <  - data.table(daily_encounter)
# dischord.tbl <- data.table(dischord)
# 
# library("fasttime")
# #https://cran.r-project.org/web/packages/fasttime/fasttime.pdf
# daily_encounter.tbl$inpatient_admit_dt <- fastPOSIXct(daily_encounter.tbl$inpatient_admit_dt, tz="America/Detroit")
# daily_encounter.tbl$admit_dt <- fastPOSIXct(daily_encounter.tbl$admit_dt, tz="America/Detroit")
# daily_encounter.tbl$discharge_dt <- fastPOSIXct(daily_encounter.tbl$discharge_dt, tz="America/Detroit")
# daily_encounter.tbl$fa_to_dt <- fastPOSIXct(daily_encounter.tbl$fa_to_dt, tz="America/Detroit")
# daily_encounter.tbl$fa_from_dt <- fastPOSIXct(daily_encounter.tbl$fa_from_dt, tz="America/Detroit")
# daily_encounter.tbl$fe_ingestion_dt <- fastPOSIXct(daily_encounter.tbl$fe_ingestion_dt, tz="America/Detroit")
# dischord.tbl$dischord_expected_disch_dt <- fastPOSIXct(dischord.tbl$dischord_expected_disch_dt, tz="America/Detroit")
# dischord.tbl$dischord_ord_dt <- fastPOSIXct(dischord.tbl$dischord_ord_dt, tz="America/Detroit")
# 
# enc$e_appt_confirmed_dttm <- fastPOSIXct(enc$e_appt_confirmed_dttm, tz="America/Detroit")
# enc$e_appt_sched_dttm <- fastPOSIXct(enc$e_appt_sched_dttm, tz="America/Detroit")
# enc$e_ed_arrival_dttm <- fastPOSIXct(enc$e_ed_arrival_dttm, tz="America/Detroit")
# enc$e_admission_dttm <- fastPOSIXct(enc$e_admission_dttm, tz="America/Detroit")
# enc$e_ed_departure_dttm <- fastPOSIXct(enc$e_ed_departure_dttm, tz="America/Detroit")
# enc$e_inpatient_admit_dttm <- fastPOSIXct(enc$e_inpatient_admit_dttm, tz="America/Detroit")
# enc$e_downgraded_from_inp_dttm <- fastPOSIXct(enc$e_downgraded_from_inp_dttm, tz="America/Detroit")
# enc$e_discharge_dttm <- fastPOSIXct(enc$e_discharge_dttm, tz="America/Detroit")
# enc$e_discharge_kickoff_dttm <- fastPOSIXct(enc$e_discharge_kickoff_dttm, tz="America/Detroit")
# enc$e_expected_admit_dttm <- fastPOSIXct(enc$e_expected_admit_dttm, tz="America/Detroit")
# enc$e_coding_dttm <- fastPOSIXct(enc$e_coding_dttm, tz="America/Detroit")
# enc$e_vitals_taken_dttm <- fastPOSIXct(enc$e_vitals_taken_dttm, tz="America/Detroit")
# enc$e_expected_disch_dt <- fastPOSIXct(enc$e_expected_disch_dt, tz="America/Detroit")
# 
# temp_time <- enc$e_expected_disch_tm
# temp_time[which(temp_time!="")] <- paste("2000-01-01",enc$e_expected_disch_tm[which(enc$e_expected_disch_tm!="")],sep="")
# temp_time <- fastPOSIXct(temp_time, tz="America/Detroit")
# enc$e_expected_disch_tm <- as.numeric(format(fastPOSIXct(temp_time, tz="America/Detroit"), format="%H"))
# temp_time <- NULL
# 
# daily_encounter.tbl$LengthOfStay <- as.numeric((daily_encounter.tbl$discharge_dt - daily_encounter.tbl$inpatient_admit_dt), units="days")
# 
# daily_encounter.tbl.sorted <- daily_encounter.tbl[order(encounter_id, fa_from_dt, fa_to_dt, fa_ordinal),] 
# #TODO: enforce exactly one record in the table for each visit-day
# head(daily_encounter.tbl)
# head(daily_encounter.tbl.sorted)
# length(which(daily_encounter.tbl.sorted$fa_id != daily_encounter.tbl$fa_id))
# daily_encounter.tbl <- NULL
```

#data preprocessing

Pull the provider_id and the encounter_id from a given row into a new column in the row before it.

```{r pull_up_ids, cache=FALSE, warning=FALSE, message=FALSE}
#https://rdrr.io/cran/dplyr/man/lead-lag.html
library(dplyr)
atnd.tbl.sorted[, to_prov := shift(provider_id, n=1L, type="lead")]
atnd.tbl.sorted[, from_prov := shift(provider_id, n=1L, type="lag")]
atnd.tbl.sorted[, next_enc := shift(encounter_id, n=1L, type="lead")]
atnd.tbl.sorted[, prev_enc := shift(encounter_id, n=1L, type="lag")]
atnd.tbl.sorted[, next_from_dt := shift(attending_from_date, n=1L, type="lead")]
atnd.tbl.sorted[, next_ordinal := shift(ordinal_day, n=1L, type="lead")]
#daily_encounter.tbl.sorted$next_from_dt <- fastPOSIXct(daily_encounter.tbl.sorted$next_from_dt, tz="America/Chicago")
```

##select primary discharge order when there are multiple on a visit

```{r disch_ord_cancel_reasons, cache=FALSE, warning=FALSE, message=FALSE}
unique_cancel <- data.table(table(dischord.tbl$dischord_cancel_reason)); 
colnames(unique_cancel) <- c("Cancel Reason","Count")
unique_cancel[order(-Count)]
# Cancel Reason  Count
# NULL 41520			
# Patient Discharge	210			
# Patient Transfer	122			
# As Per Protocol	114			
# Cancelled by MD	24			
# Other	20			
# Treatment Completed	16			
# Patient Condition Changed	10			
# Duplicate Order	6			
# Order Expired	6	
# Changed Order	2			
# Contact Move Due To Patient Overlay	2			
# Duplicate	2			
# Patient Transferred from Unit	2	
```

```{r disch_ord_cancel_reasons_unique, cache=FALSE, warning=FALSE, message=FALSE}
require(dplyr)
dischord.tbl.sorted <- dischord.tbl[order(dischord_encounter_id, -dischord_ord_dt)]
dischord.tbl.sorted.naive_unique <- distinct(dischord.tbl.sorted, dischord_encounter_id, .keep_all= TRUE)

unique_cancel <- data.table(table(dischord.tbl.sorted.naive_unique$dischord_cancel_reason)); 
colnames(unique_cancel) <- c("Cancel Reason","Count")
unique_cancel[order(-Count)]    
```

```{r disch_ord_cancel_reasons_2, cache=FALSE, warning=FALSE, message=FALSE}
dim(dischord.tbl.sorted) #sentara 2019: 42056, TGH: 56775
uniqueN(as.data.frame(dischord.tbl.sorted)[c('dischord_encounter_id')], 
        by=c('dischord_encounter_id')) #sentara 2019: 16328, TGH: 23463
latest_w_correct_reason <- dischord.tbl.sorted[which(dischord.tbl.sorted$dischord_cancel_reason == "Patient Discharge")] %>% 
  distinct(dischord_encounter_id, .keep_all= TRUE)
dischord.tbl.sorted[!(dischord.tbl.sorted$dischord_encounter_id %in% latest_w_correct_reason$dischord_encounter_id),]
dischord.tbl.sorted[(dischord.tbl.sorted$dischord_encounter_id %in% latest_w_correct_reason$dischord_encounter_id),]
```

```{r disch_ord_cancel_reasons_3, cache=FALSE, warning=FALSE, message=FALSE}
remaining_dischord <- dischord.tbl.sorted[!(dischord.tbl.sorted$dischord_encounter_id %in% 
                                              latest_w_correct_reason$dischord_encounter_id),]
dim(remaining_dischord)
last_from_remaining <- remaining_dischord %>% distinct(dischord_encounter_id, .keep_all= TRUE)
dim(latest_w_correct_reason)
dim(last_from_remaining)
head(last_from_remaining)
disch_ord <- rbind(latest_w_correct_reason, last_from_remaining)
dim(disch_ord)
head(disch_ord,50)
#Sentara
#[1] 41746     7
#[1] 103   7
#[1] 16225     7
#[1] 16328     7

#TGH
#[1] 328   7
#[1] 23357     7
#[1] 106   7
#[1] 23463     7
```

```{r viz_discharge_order_dttm, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=disch_ord[which(disch_ord$dischord_ord_dt > as.POSIXct('2019-01-01'))], aes(strftime(dischord_ord_dt, format="%H", tz="America/Detroit"))) +
  geom_histogram(alpha = .5, stat="count", bins = 120, fill="slateblue") +
  xlab("Discharge Order Hour") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

interpreting the above as: Primary discharge decision time: 10:00 AM EST for TGH. Nearly all discharge orders are placed after 7 AM.

```{r viz_discharge_time_dttm, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=enc[which(enc$patient_class=='101^Inpatient'),], 
            aes(strftime(discharge_dttm, format="%H", tz="America/Detroit"))) +
  geom_histogram(alpha = .5, stat="count", bins = 120, fill="slateblue") +
  xlab("Discharge Hour") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_discharge_time_dttm, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=enc[which(enc$patient_class=='101^Inpatient'),], 
            aes(strftime(discharge_kickoff_dttm, format="%H", tz="America/Detroit"))) +
  geom_histogram(alpha = .5, stat="count", bins = 120, fill="slateblue") +
  xlab("Discharge Kickoff Hour") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

## join daily attending data and discharge orders onto encounters

```{r encfull_join_atnd_disch_ord, cache=FALSE, warning=FALSE, message=FALSE}
atnd.tbl.sorted$visit <- as.character(atnd.tbl.sorted$visit)

dim(atnd.tbl.sorted) #TGH: 284933     56; 284440 (was 284933) 54
atnd.tbl.sorted.uniquevis <- distinct(atnd.tbl.sorted, encounter_id, .keep_all=TRUE)
atnd.tbl.sorted.uniquevis$admission_type <- NULL
atnd.tbl.sorted.uniquevis$har_id <- NULL
atnd.tbl.sorted.uniquevis$pat_zip_at_disch <- NULL
atnd.tbl.sorted.uniquevis$patient_class <- NULL
atnd.tbl.sorted.uniquevis$acuity_level <- NULL
atnd.tbl.sorted.uniquevis$total_charges <- NULL
atnd.tbl.sorted.uniquevis$admission_source <- NULL
dim(atnd.tbl.sorted.uniquevis) #TGH: 44339x49; 44253 (was 44339)    55

enc.tbl <- data.table(enc)
enc.tbl$visit_id <- as.character(enc.tbl$visit_id)
enc_ord <- enc.tbl %>% 
  left_join(atnd.tbl.sorted.uniquevis, by=c('visit_id'='visit'), suffix=c(".x",".y"))

dim(enc_ord) #TGH: 840368    188; 47189   198
enc_ord <- enc_ord %>% 
  left_join(disch_ord, by=c('encounter_id'='dischord_encounter_id'), suffix=c(".x",".y"))
dim(enc_ord) #TGH: 840368    194, 47189   204

#TODO: impute these providers into the attending data...
dim(enc_ord[which(is.na(enc_ord$encounter_id)),]) #TGH: 796030 194, 2979 (was 2967) 205
dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$discharging_ser_id == ""),]) #753603    194, 2890  206
dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$har_admitting_ser_id == ""),]) #593628    194, 131 206
dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$admitting_ser_id == ""),]) #604167    194, 224 206
dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$bill_atnd_ser_id == ""),]) #321710    194, 115 206
dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$har_atnd_ser_id == ""),]) #115927    194, 0 206

#remove encounters that were not found in the attending data (these could have been visits not touched by hospitalist)
enc_ord <- enc_ord[which(!is.na(enc_ord$encounter_id)),]
dim(enc_ord) #TGH: 44338   194, 44210 (was 44222)   205

#disch_ord_fe <- disch_ord[daily_encounter.tbl.sorted, on=.(dischord_encounter_id=encounter_id), nomatch=0]
#disch_ord_fe <- disch_ord %>% 
#  inner_join(daily_encounter.tbl.sorted.uniquevis, by=c('dischord_encounter_id'='encounter_id'), suffix=c(".x",".y"))
#disch_ord_fe$visit_id <- as.character(disch_ord_fe$visit_id)
#head(disch_ord_fe$discharge_dt[which(!is.na(disch_ord_fe$discharge_dt))])
```

```{r join_atnd_disch_ord, cache=FALSE, warning=FALSE, message=FALSE}
# atnd.tbl.sorted$visit <- as.character(atnd.tbl.sorted$visit)
# 
# dim(atnd.tbl.sorted) #TGH: 284440 (was 284933) 54
# atnd.tbl.sorted.uniquevis <- distinct(atnd.tbl.sorted, encounter_id, .keep_all=TRUE)
# dim(atnd.tbl.sorted.uniquevis) #TGH: 44253 (was 44339)    55
# 
# enc.tbl <- data.table(enc)
# enc.tbl$e_visit_id <- as.character(enc.tbl$e_visit_id)
# enc_ord <- enc.tbl %>% 
#   left_join(atnd.tbl.sorted.uniquevis, by=c('e_visit_id'='visit'), suffix=c(".x",".y"))
# 
# dim(enc_ord) #TGH: 47189   198
# enc_ord <- enc_ord %>% 
#   left_join(disch_ord, by=c('encounter_id'='dischord_encounter_id'), suffix=c(".x",".y"))
# dim(enc_ord) #TGH: 47189   204
# 
# #TODO: impute these proviers into the attending data...
# dim(enc_ord[which(is.na(enc_ord$encounter_id)),]) #TGH: 2979 (was 2967) 205
# dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$e_discharging_ser_id == ""),]) #2890  206
# dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$e_har_admitting_ser_id == ""),]) #131 206
# dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$e_admitting_ser_id == ""),]) #224 206
# dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$e_bill_atnd_ser_id == ""),]) #115 206
# dim(enc_ord[which(is.na(enc_ord$encounter_id) & enc_ord$e_har_atnd_ser_id == ""),]) #0 206
# 
# #remove encounters that were not found in the attending data (these could have been visits not touched by hospitalist)
# enc_ord <- enc_ord[which(!is.na(enc_ord$encounter_id)),]
# dim(enc_ord) #TGH: 44210 (was 44222)   205
# 
# #disch_ord_fe <- disch_ord[daily_encounter.tbl.sorted, on=.(dischord_encounter_id=encounter_id), nomatch=0]
# #disch_ord_fe <- disch_ord %>% 
# #  inner_join(daily_encounter.tbl.sorted.uniquevis, by=c('dischord_encounter_id'='encounter_id'), suffix=c(".x",".y"))
# #disch_ord_fe$visit_id <- as.character(disch_ord_fe$visit_id)
# #head(disch_ord_fe$discharge_dt[which(!is.na(disch_ord_fe$discharge_dt))])
```

```{r analyze_disch_order_timing_encfull, cache=FALSE, warning=FALSE, message=FALSE}
enc_ord$discord_to_disch <- as.numeric(as.POSIXct(enc_ord$discharge_dttm) - 
                                         as.numeric(as.POSIXct(enc_ord$dischord_ord_dt))) / (60) #mins
enc_ord$dischkickoff_to_discord <- as.numeric(as.POSIXct(enc_ord$dischord_ord_dt) - 
                                                as.numeric(as.POSIXct(enc_ord$discharge_kickoff_dttm))) / (60) #mins
head(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
length(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
min(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
max(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
mean(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch) & 
                                      enc_ord$discord_to_disch > -5000 & enc_ord$discord_to_disch < 5000)])
head(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
length(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
max(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
min(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
mean(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord) & 
                                             enc_ord$dischkickoff_to_discord > -5000 & 
                                             enc_ord$dischkickoff_to_discord < 5000)])
```
```{r analyze_disch_order_timing, cache=FALSE, warning=FALSE, message=FALSE}
# enc_ord$discord_to_disch <- as.numeric(as.POSIXct(enc_ord$e_discharge_dttm) - 
#                                          as.numeric(as.POSIXct(enc_ord$dischord_ord_dt))) / (60) #mins
# enc_ord$dischkickoff_to_discord <- as.numeric(as.POSIXct(enc_ord$dischord_ord_dt) - 
#                                                 as.numeric(as.POSIXct(enc_ord$e_discharge_kickoff_dttm))) / (60) #mins
# head(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
# length(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
# min(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
# max(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch))])
# mean(enc_ord$discord_to_disch[which(!is.na(enc_ord$discord_to_disch) & 
#                                       enc_ord$discord_to_disch > -5000 & enc_ord$discord_to_disch < 5000)])
# head(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
# length(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
# max(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
# min(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord))])
# mean(enc_ord$dischkickoff_to_discord[which(!is.na(enc_ord$dischkickoff_to_discord) & 
#                                              enc_ord$dischkickoff_to_discord > -5000 & 
#                                              enc_ord$dischkickoff_to_discord < 5000)])
# #below was output when joining encounters onto disch orders...
# #[1]  -48  415  -17   39 -269  161
# #[1] 16320
# #[1] -325656
# #[1] 64697
# #[1] 57.30786
# #[1]   -0.08333333   -0.98333333   -0.43333333   -0.10000000 1279.91666667   -0.96666667
# #[1] 16218
# #[1] 325497.5
# #[1] -1.016667
# #[1] 694.8891
# 
# # TGH:
# # [1] 1712  387  430  321 2202  161
# # [1] 23202
# # [1] -5399
# # [1] 213651
# # [1] 415.5002
# # [1] -300.2333 -300.0667 -300.8167 -300.7500 -300.3000 -300.0833
# # [1] 23158
# # [1] 306931.6
# # [1] -7579.083
# # [1] -194.5991
```

```{r viz_dischord_to_disch_hist, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=enc_ord[which(enc_ord$discord_to_disch > -5000 & enc_ord$discord_to_disch < 5000)], aes(discord_to_disch)) +
  geom_histogram(alpha = .5, binwidth=60, fill="slateblue") +
  xlab("Discharge Order to Discharge Minutes") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```
```{r viz_dischord_to_disch_box, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=enc_ord[which(enc_ord$discord_to_disch > -5000 & enc_ord$discord_to_disch < 5000)], aes(discord_to_disch)) +
  geom_boxplot(alpha = .5, fill="slateblue") +
  xlab("Discharge Order to Discharge Minutes") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```
```{r viz_dischkickoff_to_dischord_hist, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=enc_ord[which(enc_ord$dischkickoff_to_discord > 0
                               & enc_ord$dischkickoff_to_discord < 7.5*1440+1)], 
            aes(dischkickoff_to_discord)) +
  geom_histogram(alpha = .5, binwidth=60, fill="slateblue") +
  xlab("Discharge Order to Discharge Kickoff Minutes") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal") +
  scale_x_continuous(breaks=seq(0,7*1440+1,1440), labels=seq(0,7*1440+1,1440), limits=c(-1,7.5*1440+1))
a
```

##Length of stay assessment

```{r viz_dischkickoff_to_dischord_hist, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
length(enc_ord$inpatient_admit_dttm[which(is.na(enc_ord$inpatient_admit_dttm))]) #sentara 2019: 4634
length(enc_ord$inpatient_admit_dttm[which(is.na(enc_ord$inpatient_admit_dttm)
                                            & is.na(enc_ord$admission_dttm))]) #sentara 2019: 0
length(enc_ord$inpatient_admit_dttm[which(is.na(enc_ord$inpatient_admit_dttm)
                                            & is.na(enc_ord$encounter_id))]) #sentara 2019: 3839

enc_ord$LengthOfStay <- as.numeric(as.POSIXct(enc_ord$discharge_dttm) -
                                     as.numeric(as.POSIXct(enc_ord$inpatient_admit_dttm))) / (60*60*24) #days

missing_inp_admit <- enc_ord[which(is.na(enc_ord$inpatient_admit_dttm))]

missing_inp_admit$LengthOfStay <- 
  as.numeric(as.POSIXct(missing_inp_admit$discharge_dttm) -
               as.numeric(as.POSIXct(missing_inp_admit$inpatient_admit_dttm))) / (60*60*24) #days

head(missing_inp_admit$LengthOfStay)
mean(missing_inp_admit$LengthOfStay)
max(missing_inp_admit$LengthOfStay)
min(missing_inp_admit$LengthOfStay)

head(enc_ord$LengthOfStay)
mean(enc_ord[which(!is.na(enc_ord$LengthOfStay)),]$LengthOfStay)
mean(enc_ord[which(!is.na(enc_ord$LengthOfStay) & !is.na(enc_ord$encounter_id)),]$LengthOfStay)
max(enc_ord[which(!is.na(enc_ord$LengthOfStay)),]$LengthOfStay)
min(enc_ord[which(!is.na(enc_ord$LengthOfStay)),]$LengthOfStay)
min(enc_ord[which(!is.na(enc_ord$LengthOfStay) & !is.na(enc_ord$encounter_id)),]$LengthOfStay)

length(enc_ord$discharge_dttm[which(is.na(enc_ord$discharge_dttm))])
head(enc_ord$LengthOfStay)
length(enc_ord$LengthOfStay[which(is.na(enc_ord$LengthOfStay))])
max(enc_ord$LengthOfStay[which(!is.na(enc_ord$LengthOfStay))])
```

[1] 4634
[1] 0
[1] 3839
[1] 0.9340278 1.6736111 2.1368056 4.3229167 0.9701389 0.8236111
[1] 4.181297
[1] 216.134
[1] 0.002083333
[1]  3.903472  3.142361  3.311111  6.315278  2.201389 14.781250
[1] 4.543658
[1] 5.452656
[1] 384.8882
[1] -2.636806
[1] 0.003472222
[1] 0
[1]  3.903472  3.142361  3.311111  6.315278  2.201389 14.781250
[1] 4634
[1] NA

After limiting to only hospital-user associated visits...
[1] 795
[1] 0
[1] 0
[1]  9.241667  5.075694 21.759722 18.883333  3.338194  1.436806
[1] 4.602089
[1] 216.134
[1] 0.1263889
[1] 5.7138889 8.9541667 1.2930556 1.2194444 0.9395833 2.6618056
[1] 5.506182
[1] 5.506182
[1] 384.8882
[1] 0.003472222
[1] 0.003472222
[1] 0
[1] 5.7138889 8.9541667 1.2930556 1.2194444 0.9395833 2.6618056
[1] 795
[1] NA

```{r filter_to_dischord, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
#below doesn't filter anything out anymore since this was 
enc_ord.hosp <- enc_ord[which(!is.na(enc_ord$encounter_id)),]
dim(enc_ord)
dim(enc_ord.hosp)
#[1] 44338   194
#[1] 44338   194
#joining facts_encounters onto disch orders: 16320
#joining facts_encounters onto view_encounters: 17112
```

```{r filter_to_dischord, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
# length(enc_ord.hosp$e_inpatient_admit_dttm[which(is.na(enc_ord.hosp$e_inpatient_admit_dttm))]) #sentara 2019: 4634
# length(enc_ord.hosp$e_inpatient_admit_dttm[which(is.na(enc_ord.hosp$e_inpatient_admit_dttm)
#                                             & is.na(enc_ord.hosp$e_admission_dttm))]) #sentara 2019: 0
# length(enc_ord.hosp$e_inpatient_admit_dttm[which(is.na(enc_ord.hosp$e_inpatient_admit_dttm)
#                                             & is.na(enc_ord.hosp$encounter_id))]) #sentara 2019: 3839
# enc_ord.hosp$LengthOfStay <-
#   as.numeric(as.POSIXct(enc_ord.hosp$e_discharge_dttm) -
#                as.numeric(as.POSIXct(enc_ord.hosp$e_inpatient_admit_dttm))) / (60*60*24) #days
# 
# missing_inp_admit <- enc_ord.hosp[which(is.na(enc_ord.hosp$e_inpatient_admit_dttm))]
# missing_inp_admit$LengthOfStay <- 
#   as.numeric(as.POSIXct(missing_inp_admit$e_discharge_dttm) -
#                as.numeric(as.POSIXct(missing_inp_admit$e_inpatient_admit_dttm))) / (60*60*24) #days
# head(missing_inp_admit$LengthOfStay)
# mean(missing_inp_admit$LengthOfStay)
# max(missing_inp_admit$LengthOfStay)
# min(missing_inp_admit$LengthOfStay)
# 
# head(enc_ord.hosp$LengthOfStay)
# mean(enc_ord.hosp[which(!is.na(enc_ord.hosp$LengthOfStay)),]$LengthOfStay)
# mean(enc_ord.hosp[which(!is.na(enc_ord.hosp$LengthOfStay) & !is.na(enc_ord.hosp$encounter_id)),]$LengthOfStay)
# max(enc_ord.hosp[which(!is.na(enc_ord.hosp$LengthOfStay)),]$LengthOfStay)
# min(enc_ord.hosp[which(!is.na(enc_ord.hosp$LengthOfStay)),]$LengthOfStay)
# min(enc_ord.hosp[which(!is.na(enc_ord.hosp$LengthOfStay) & !is.na(enc_ord.hosp$encounter_id)),]$LengthOfStay)
# 
# length(enc_ord.hosp$e_discharge_dttm[which(is.na(enc_ord.hosp$e_discharge_dttm))])
# head(enc_ord.hosp$LengthOfStay)
# length(enc_ord.hosp$LengthOfStay[which(is.na(enc_ord.hosp$LengthOfStay))])
# max(enc_ord.hosp$LengthOfStay[which(!is.na(enc_ord.hosp$LengthOfStay))])
# 
# mean(enc_ord.hosp$LengthOfStay[which(enc_ord.hosp$LengthOfStay > 0)]) #5.452668
# sd(enc_ord.hosp$LengthOfStay[which(enc_ord.hosp$LengthOfStay > 0)]) # 7.935311
# 
# enc_ord.hosp$log_LOS <- log(enc_ord.hosp$LengthOfStay)
# mean(enc_ord.hosp$log_LOS[which(enc_ord.hosp$LengthOfStay > 0)]) #1.245529
# sd(enc_ord.hosp$log_LOS[which(enc_ord.hosp$LengthOfStay > 0)]) #0.9248916
# exp(mean(enc_ord.hosp$log_LOS[which(enc_ord.hosp$LengthOfStay > 0)])) #3.474774
# exp(sd(enc_ord.hosp$log_LOS[which(enc_ord.hosp$LengthOfStay > 0)])) #2.521595
# 
# #require(EnvStats)
# #geoSD(enc_ord.hosp$LengthOfStay[which(enc_ord.hosp$LengthOfStay > 0)], na.rm=TRUE) #2.521595
```

#Make daily dataframe

```{r peek_enc_ord, eval=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
colnames(enc_ord.hosp)
summary(enc_ord.hosp)
```

```{r filter_to_dischord_encfull, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
days_list <- matrix(0:400, nrow=401,ncol=1)
stayday <- expand.grid(day_ordinal=days_list, visit_id = enc_ord.hosp$visit_id)

enc_join_data = data.frame(visit_id=enc_ord.hosp$visit_id,
                           ept_id=enc_ord.hosp$ept_id,
                           LengthOfStay=enc_ord.hosp$LengthOfStay,
                           admit_dttm=enc_ord.hosp$admission_dttm,
                           inp_admit_dttm=enc_ord.hosp$inpatient_admit_dttm,
                           disch_dttm=enc_ord.hosp$discharge_dttm,
                           disch_kickoff_dttm=enc_ord.hosp$discharge_kickoff_dttm,
                           expected_admit_dttm=enc_ord.hosp$expected_admit_dttm,
                           expected_disch_dttm=enc_ord.hosp$expected_disch_dt,
                           expected_disch_hour=enc_ord.hosp$expected_disch_tm,
                           expected_time_of_disch=as.factor(enc_ord.hosp$expected_time_of_disch),
                           means_of_arrival=as.factor(enc_ord.hosp$means_of_arrival),
                           patient_class=as.factor(enc_ord.hosp$patient_class),
                           #har_patient_class=as.factor(enc_ord.hosp$har_patient_class), #not meaningfully different for Sentara
                           patient_escorted_by=as.factor(enc_ord.hosp$patient_escorted_by),
                           #labor_status=as.factor(enc_ord.hosp$labor_status), #always null
                           patient_status=as.factor(enc_ord.hosp$patient_status),
                           disch_disposition=as.factor(enc_ord.hosp$discharge_disposition),
                           disch_destination=as.factor(enc_ord.hosp$discharge_destination),
                           means_of_depart=as.factor(enc_ord.hosp$means_of_departure),
                           dept_name=as.factor(enc_ord.hosp$dept_name),
                           room_type=as.factor(enc_ord.hosp$room_type),
                           room_reason=as.factor(enc_ord.hosp$room_reason),
                           #har_drg_qualifier=as.factor(enc_ord.hosp$har_drg_qualifier), #not meaningfully different for Sentara
                           drg_qualifier=as.factor(enc_ord.hosp$drg_qualifier),
                           mdc_code=as.factor(enc_ord.hosp$drg_mdc_code),
                           drg_length_of_stay=enc_ord.hosp$drg_length_of_stay,
                           drg_name=as.factor(enc_ord.hosp$drg_name),
                           drg_amlos=enc_ord.hosp$drg_amlos,
                           drg_gmlos=enc_ord.hosp$drg_gmlos,
                           drg_weight=enc_ord.hosp$drg_weight,
                           drg_SOI=as.factor(enc_ord.hosp$drg_severity_of_illness),
                           drg_ROM=as.factor(enc_ord.hosp$drg_risk_of_mortality),
                           admit_type=as.factor(enc_ord.hosp$admission_type),
                           acuity_level=as.factor(enc_ord.hosp$acuity_level),
                           admit_source=as.factor(enc_ord.hosp$admission_source),
                           admit_for_surg_yn=as.factor(enc_ord.hosp$admit_for_surg_yn),
                           surgical_service=as.factor(enc_ord.hosp$surgical_service),
                           har_hospital_service=as.factor(enc_ord.hosp$har_hospital_service),
                           visit_service=as.factor(enc_ord.hosp$visit_service),
                           dept_specialty=as.factor(enc_ord.hosp$dept_specialty),
                           revenue_location=as.factor(enc_ord.hosp$revenue_location),
                           har_admitting_ser_id=as.factor(enc_ord.hosp$har_admitting_ser_id),
                           discharge_kickoff_user_id=as.factor(enc_ord.hosp$discharge_kickoff_user_id),
                           discharging_ser_id=as.factor(enc_ord.hosp$discharging_ser_id),
                           har_atnd_ser_id=as.factor(enc_ord.hosp$har_atnd_ser_id),
                           har_financial_class=as.factor(enc_ord.hosp$har_financial_class),
                           selfpay_yn=as.factor(enc_ord.hosp$selfpay_yn),
                           total_charges=enc_ord.hosp$total_charges,
                           num_charges=enc_ord.hosp$num_charges,
                           infection_list=enc_ord.hosp$infection_list,
                           isolation_list=enc_ord.hosp$isolation_list,
                           incident_date_list=enc_ord.hosp$incident_date_list,
                           visit_dx_count=enc_ord.hosp$visit_dx_count,
                           #pain_score=enc_ord.hosp$pain_score, #removing because this is the most recent vitals on the visit
                           bmi=enc_ord.hosp$bmi,
                           expected_length_of_stay=enc_ord.hosp$expected_length_of_stay,
                           sequential_visit_yn=as.factor(enc_ord.hosp$sequential_visit_yn),
                           #num_charges=enc_ord.hosp$num_charges, #already in the discharge order data
                           interface_comment=enc_ord.hosp$interface_comment,
                           ed_disposition=as.factor(enc_ord.hosp$ed_disposition),
                           next_prov=as.factor(enc_ord.hosp$to_prov),
                           bed_type=as.factor(enc_ord.hosp$bed_type),
                           room_accommodation=as.factor(enc_ord.hosp$room_accommodation),
                           #use these to represent whether patient was (especially into ICU) after admit
                           inp_admit_accommodation=as.factor(enc_ord.hosp$inp_admit_accommodation),
                           inp_admit_level_of_care=as.factor(enc_ord.hosp$inp_admit_level_of_care),
                           inp_admit_dept_specialty=as.factor(enc_ord.hosp$inp_admit_dept_specialty),
                           inp_admit_dept=enc_ord.hosp$inp_admit_dept,
                           #day_date=enc_ord.hosp$date
                           max_ordinal_day=enc_ord.hosp$max_ordinal_day
                          )
days_list <-  NULL
```

```{r filter_to_dischord, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
# days_list <- matrix(0:400, nrow=401,ncol=1)
# stayday <- expand.grid(day_ordinal=days_list, visit_id = enc_ord.hosp$e_visit_id)
# 
# enc_join_data = data.frame(e_visit_id=enc_ord.hosp$e_visit_id,
#                            ept_id=enc_ord.hosp$e_ept_id,
#                            LengthOfStay=enc_ord.hosp$LengthOfStay,
#                            admit_dttm=enc_ord.hosp$e_admission_dttm,
#                            inp_admit_dttm=enc_ord.hosp$e_inpatient_admit_dttm,
#                            disch_dttm=enc_ord.hosp$e_discharge_dttm,
#                            disch_kickoff_dttm=enc_ord.hosp$e_discharge_kickoff_dttm,
#                            expected_admit_dttm=enc_ord.hosp$e_expected_admit_dttm,
#                            expected_disch_dttm=enc_ord.hosp$e_expected_disch_dt,
#                            expected_disch_hour=enc_ord.hosp$e_expected_disch_tm,
#                            expected_time_of_disch=as.factor(enc_ord.hosp$e_expected_time_of_disch),
#                            means_of_arrival=as.factor(enc_ord.hosp$e_means_of_arrival),
#                            patient_class=as.factor(enc_ord.hosp$e_patient_class),
#                            #har_patient_class=as.factor(enc_ord.hosp$e_har_patient_class), #not meaningfully different for Sentara
#                            patient_escorted_by=as.factor(enc_ord.hosp$e_patient_escorted_by),
#                            #labor_status=as.factor(enc_ord.hosp$e_labor_status), #always null
#                            patient_status=as.factor(enc_ord.hosp$e_patient_status),
#                            disch_disposition=as.factor(enc_ord.hosp$e_discharge_disposition),
#                            disch_destination=as.factor(enc_ord.hosp$e_discharge_destination),
#                            means_of_depart=as.factor(enc_ord.hosp$e_means_of_departure),
#                            dept_name=as.factor(enc_ord.hosp$e_dept_name),
#                            room_type=as.factor(enc_ord.hosp$e_room_type),
#                            room_reason=as.factor(enc_ord.hosp$e_room_reason),
#                            #har_drg_qualifier=as.factor(enc_ord.hosp$e_har_drg_qualifier), #not meaningfully different for Sentara
#                            drg_qualifier=as.factor(enc_ord.hosp$e_drg_qualifier),
#                            mdc_code=as.factor(enc_ord.hosp$e_drg_mdc_code),
#                            drg_length_of_stay=enc_ord.hosp$e_drg_length_of_stay,
#                            drg_name=as.factor(enc_ord.hosp$e_drg_name),
#                            drg_amlos=enc_ord.hosp$e_drg_amlos,
#                            drg_gmlos=enc_ord.hosp$e_drg_gmlos,
#                            drg_weight=enc_ord.hosp$e_drg_weight,
#                            drg_SOI=as.factor(enc_ord.hosp$e_drg_severity_of_illness),
#                            drg_ROM=as.factor(enc_ord.hosp$e_drg_risk_of_mortality),
#                            admit_type=as.factor(enc_ord.hosp$e_admission_type),
#                            acuity_level=as.factor(enc_ord.hosp$e_acuity_level),
#                            admit_source=as.factor(enc_ord.hosp$e_admission_source),
#                            admit_for_surg_yn=as.factor(enc_ord.hosp$e_admit_for_surg_yn),
#                            surgical_service=as.factor(enc_ord.hosp$e_surgical_service),
#                            har_hospital_service=as.factor(enc_ord.hosp$e_har_hospital_service),
#                            visit_service=as.factor(enc_ord.hosp$e_visit_service),
#                            dept_specialty=as.factor(enc_ord.hosp$e_dept_specialty),
#                            revenue_location=as.factor(enc_ord.hosp$e_revenue_location),
#                            har_admitting_ser_id=as.factor(enc_ord.hosp$e_har_admitting_ser_id),
#                            discharge_kickoff_user_id=as.factor(enc_ord.hosp$e_discharge_kickoff_user_id),
#                            discharging_ser_id=as.factor(enc_ord.hosp$e_discharging_ser_id),
#                            har_atnd_ser_id=as.factor(enc_ord.hosp$e_har_atnd_ser_id),
#                            har_financial_class=as.factor(enc_ord.hosp$e_har_financial_class),
#                            selfpay_yn=as.factor(enc_ord.hosp$e_selfpay_yn),
#                            total_charges=enc_ord.hosp$e_total_charges,
#                            num_charges=enc_ord.hosp$e_num_charges,
#                            infection_list=enc_ord.hosp$e_infection_list,
#                            isolation_list=enc_ord.hosp$e_isolation_list,
#                            incident_date_list=enc_ord.hosp$e_incident_date_list,
#                            visit_dx_count=enc_ord.hosp$e_visit_dx_count,
#                            #pain_score=enc_ord.hosp$e_pain_score, #removing because this is the most recent vitals on the visit
#                            bmi=enc_ord.hosp$e_bmi,
#                            expected_length_of_stay=enc_ord.hosp$e_expected_length_of_stay,
#                            sequential_visit_yn=as.factor(enc_ord.hosp$e_sequential_visit_yn),
#                            #num_charges=enc_ord.hosp$e_num_charges, #already in the discharge order data
#                            interface_comment=enc_ord.hosp$e_interface_comment,
#                            ed_disposition=as.factor(enc_ord.hosp$ed_disposition),
#                            next_prov=as.factor(enc_ord.hosp$to_prov),
#                            bed_type=as.factor(enc_ord.hosp$e_bed_type),
#                            room_accommodation=as.factor(enc_ord.hosp$e_room_accommodation),
#                            #use these to represent whether patient was (especially into ICU) after admit
#                            inp_admit_accommodation=as.factor(enc_ord.hosp$e_inp_admit_accommodation),
#                            inp_admit_level_of_care=as.factor(enc_ord.hosp$e_inp_admit_level_of_care),
#                            inp_admit_dept_specialty=as.factor(enc_ord.hosp$e_inp_admit_dept_specialty),
#                            inp_admit_dept=enc_ord.hosp$e_inp_admit_dept,
#                            #day_date=enc_ord.hosp$date
#                            max_ordinal_day=enc_ord.hosp$max_ordinal_day
#                           )
```

TODO: flesh this out for my data...clean up factors with small amounts of sample

####Handle ordered categorical variables

Looks like there are many differing opinions on how to do this, as exemplified by [this post](http://andrewgelman.com/2009/10/06/coding_ordinal/) and [this post](https://stats.stackexchange.com/questions/33413/continuous-dependent-variable-with-ordinal-independent-variable) and [this extremely exhaustive post](https://stats.idre.ucla.edu/r/library/r-library-contrast-coding-systems-for-categorical-variables/).

>On the other hand, if you have tons of data,

...I do...

>...you could code them as binary and you???d be fine. You can also do a compromise, such as coding the main effects as binary predictors (for flexibility) but then use the continuous coding if you???re including the variables as interactions. You can even use the estimated coefficients from the main effects to inform your continuous coding.

The technique I am using for the actual ordered factor encoding is borrowed from [here](https://www.dummies.com/programming/r/how-to-work-with-ordered-factors-in-r/).

```{r ordered_factor_example, eval=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
#First, create an ordered factor...
ny.kaggle$Age.Group <- factor(ny.kaggle$Age.Group, 
                              levels=c("0 to 17",
                                       "18 to 29",
                                       "30 to 49",
                                       "50 to 69",
                                       "70 or Older"), 
                              ordered=TRUE)
head(ny.kaggle$Age.Group)
#Then create a numeric age group variable...
Age.Group.disc <- rep(NA, dim(ny.kaggle)[1])
Age.Group.disc[which(ny.kaggle$Age.Group == "0 to 17")] <- 1 #8.5 1
Age.Group.disc[which(ny.kaggle$Age.Group == "18 to 29")] <- 2 #23.5 2
Age.Group.disc[which(ny.kaggle$Age.Group == "30 to 49")] <- 4 #39.5 4
Age.Group.disc[which(ny.kaggle$Age.Group == "50 to 69")] <- 6 #59.5 6 
Age.Group.disc[which(ny.kaggle$Age.Group == "70 or Older")] <- 8 #79.5 8
ny.kaggle$Age.Group.disc <- as.numeric(Age.Group.disc)

#not needed for this analysis, but if we ever include births, this might be a good idea...
#ny.kaggle$Age.Group.disc[which(ny.kaggle$Birth.Weight == 0),] <- 0
Age.Group.disc <- NULL
summary(ny.kaggle$Age.Group.disc)
```

####ROM and SOI

Take a look at risk of mortality (ROM)...

looks like the NULL values are most similar to "2^Moderate", but higher sd and usually a little bit higher value. I think leaving them as their own category makes sense...

```{r assess_ROM_SOI, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
d <- data.frame(drg_ROM = summary(enc_join_data$drg_ROM))
d$drg_SOI <-  summary(enc_join_data$drg_SOI); d
d <- data.frame(mdc_code=summary(enc_join_data$mdc_code))
d$mdc_code_null_ROM <- summary(enc_join_data[which(enc_join_data$drg_ROM==""),]$mdc_code); d
require(psych)
enc_join_data %>%
  group_by(mdc_code,drg_ROM) %>%
  summarize(los = describe(LengthOfStay))
enc_join_data %>%
  group_by(mdc_code,drg_SOI) %>%
  summarize(los = describe(LengthOfStay))
d <- NULL
```

Create an ordered factor...

```{r assess_ROM_ordered, eval=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
ny.kaggle$APR.RoM <- factor(ny.kaggle$APR.RoM, 
                            levels=c("",
                                     "Minor",
                                     "Moderate",
                                     "Major",
                                     "Extreme"), 
                            ordered=TRUE)
summary(ny.kaggle$APR.RoM)
head(ny.kaggle$APR.RoM)
```

Encode as continous, discrete values selected based on adaptation of [this post](https://stats.idre.ucla.edu/r/library/r-library-contrast-coding-systems-for-categorical-variables/).

```{r assess_ROM_ordered_2, eval=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
APR.Risk.of.Mortality <- rep(NA, dim(ny.kaggle)[1])
APR.Risk.of.Mortality[which(ny.kaggle$APR.RoM=="")] <- -2
APR.Risk.of.Mortality[which(ny.kaggle$APR.RoM=="Minor")] <- -1
APR.Risk.of.Mortality[which(ny.kaggle$APR.RoM=="Moderate")] <- 0
APR.Risk.of.Mortality[which(ny.kaggle$APR.RoM=="Major")] <- 1
APR.Risk.of.Mortality[which(ny.kaggle$APR.RoM=="Extreme")] <- 2
ny.kaggle$APR.RoM.code <- as.numeric(APR.Risk.of.Mortality)
APR.Risk.of.Mortality <- NULL
summary(ny.kaggle$APR.RoM.code)
```

After clean-up, our dataset will have `r dim(ny.kaggle)[1]` rows and `r dim(ny.kaggle)[2]` columns.

> summary(enc_join_data)
  e_visit_id         LengthOfStay      inp_admit_dttm                  disch_dttm                 
 Length:17112       Min.   :  0.0035   Min.   :2018-10-02 13:16:00   Min.   :2019-01-01 00:15:00  
 Class :character   1st Qu.:  2.3194   1st Qu.:2019-03-18 08:39:00   1st Qu.:2019-03-23 10:16:45  
 Mode  :character   Median :  3.8535   Median :2019-06-11 20:02:00   Median :2019-06-18 06:20:00  
                    Mean   :  5.5063   Mean   :2019-06-17 11:59:45   Mean   :2019-06-23 07:09:38  
                    3rd Qu.:  6.6201   3rd Qu.:2019-09-14 10:07:00   3rd Qu.:2019-09-21 06:13:15  
                    Max.   :384.8882   Max.   :2019-12-30 06:20:00   Max.   :2019-12-31 08:23:00  
                    NA's   :795        NA's   :795                                                
 disch_kickoff_dttm            expected_admit_dttm           expected_disch_dt             expected_disch_hour
 Min.   :2018-11-21 00:39:56   Min.   :2018-02-05 03:00:00   Min.   :2018-12-23 14:00:00   Min.   : 0.000     
 1st Qu.:2019-03-24 08:27:34   1st Qu.:2019-04-30 22:46:15   1st Qu.:2019-03-23 16:00:00   1st Qu.: 3.000     
 Median :2019-06-19 05:50:23   Median :2019-07-02 08:37:00   Median :2019-06-17 16:00:00   Median : 6.000     
 Mean   :2019-06-22 23:44:54   Mean   :2019-07-06 23:06:21   Mean   :2019-06-22 14:19:47   Mean   : 6.929     
 3rd Qu.:2019-09-25 05:23:57   3rd Qu.:2019-10-02 16:00:00   3rd Qu.:2019-09-20 16:00:00   3rd Qu.: 8.000     
 Max.   :2019-12-30 10:33:00   Max.   :2019-12-29 23:45:00   Max.   :2019-12-30 14:00:00   Max.   :23.000     
 NA's   :482                   NA's   :15218                 NA's   :223                   NA's   :17084      
  expected_time_of_disch                means_of_arrival      patient_class        patient_escorted_by
             :16316      12^Ambulatory/Carried  :7425    14^Inpatient:17112                  :17051   
 10^Morning  :  260      2^Public Rescue        :6603                         1^Family Member:   17   
 20^Midday   :  168                             :1960                         1001^Self      :   34   
 30^Afternoon:  331      17^Transport/Nurse Home: 671                         1002^Spouse    :    6   
 40^Evening  :   37      4^Wheelchair/Stretcher : 415                         2^Friend       :    4   
                         3^Police               :  19                                                 
                         (Other)                :  19                                                 
                                                                                 patient_status
 01^Discharged to Home or Self Care (Routine Discharge)                                 :7457  
 06^Discharged/transferred to Home Under Care of Organized Home Health Service Org      :3075  
                                                                                        :2580  
 03^Discharged/transferred to Skilled Nursing Facility (SNF) with Medicare Certification:2237  
 02^Discharged/transferred to a Short-Term General Hospital for Inpatient Care          : 317  
 50^Hospice - Home                                                                      : 306  
 (Other)                                                                                :1140  
                         disch_disposition        disch_destination                means_of_depart 
 01^Home / Assisted Living        :8452                    :    8                          :16651  
 06^Home Health                   :3580    1^Home          :13215   1004^Wheelchair        :  139  
 03^Skilled Nursing Facility (SNF):2656    2^Other         : 3556   1^Car                  :  108  
 205^Home for Hospice             : 440    3^Organ Donation:    1   3^Ambulance            :  100  
 02^Any Acute Hospital            : 372    4^Expired       :  332   1001^Hospital Transport:   71  
 20^Expired                       : 350                             5^Walk-out             :   26  
 (Other)                          :1262                             (Other)                :   17  
              dept_name                       room_type                   room_reason            drg_qualifier  
 SNVMC CARDIAC TELE:1528                           :17086                       :17104                  :16970  
 SNVMC MED         :1398   Intensive Care[10003]   :    9   Medical necessity[2]:    8   2^Analyzed DRG :  141  
 SNVMC ONC         :1234   Private[1]              :    7                                5^Admission DRG:    1  
 SNVMC IMC-3       :1049   Intermediate Care[10053]:    5                                                       
 SVBGH SOU ONC     :1020   CCU[10006]              :    1                                                       
 SVBGH 2EA         : 957   CV ICU[10008]           :    1                                                       
 (Other)           :9926   (Other)                 :    3                                                       
    mdc_code     drg_length_of_stay                           drg_name       drg_amlos        drg_gmlos     
 5      : 1391   Min.   :  1.000    SEPTICEMIA OR SEVERE SEPSIS W/: 1571   Min.   : 1.500   Min.   : 1.300  
 4      :  730   1st Qu.:  2.000    HEART FAILURE & SHOCK W MCC   : 1013   1st Qu.: 3.500   1st Qu.: 2.900  
 18     :  727   Median :  4.000    CARDIAC ARRHYTHMIA & CONDUCTIO:  589   Median : 4.500   Median : 3.600  
 1      :  678   Mean   :  5.586    INTRACRANIAL HEMORRHAGE OR CER:  563   Mean   : 4.964   Mean   : 3.911  
 11     :  610   3rd Qu.:  7.000    CHRONIC OBSTRUCTIVE PULMONARY :  561   3rd Qu.: 5.900   3rd Qu.: 4.500  
 (Other): 2234   Max.   :385.000    KIDNEY & URINARY TRACT INFECTI:  451   Max.   :37.500   Max.   :29.100  
 NA's   :10742   NA's   :10742      (Other)                       :12364                                    
   drg_weight      drg_SOI  drg_ROM         admit_type     acuity_level  
 Min.   : 0.4803   :17112   :17112   1^Emergency :15286          : 1909  
 1st Qu.: 0.8973                     2^Urgent    : 1430   1^ESI 1:  599  
 Median : 1.2215                     3^Elective  :  390   2^ESI 2:10132  
 Mean   : 1.5690                     5^DO NOT USE:    6   3^ESI 3: 4406  
 3rd Qu.: 1.8564                                          4^ESI 4:   64  
 Max.   :26.4106                                          5^ESI 5:    2
                            admit_source   admit_for_surg_yn         surgical_service
 1^Patient/Self                   :11645       :13502                        :16853  
 2^Physician/Clinic               : 3357   true: 3610        250^Orthopedics :  182  
 18^Transfer from SNF             :  847                     410^Urology     :   14  
 17^Transfer from Hospital        :  607                     110^General     :   13  
 19^Transfer from Another Facility:  592                     420^Vascular    :   12  
 23^Transfer from Same Facility   :   45                     100^Endoscopy GI:    9  
 (Other)                          :   19                     (Other)         :   29  
                  har_hospital_service                    visit_service                dept_specialty 
                            :6107      901^SNVMC GENERAL MEDICINE:6406                        :    5  
 Hospitalist[2058]          :4023      2058^Hospitalist          :4030   45^Emergency Medicine:   38  
 SVBGH GENERAL MEDICINE[231]:1797      231^SVBGH GENERAL MEDICINE:2208   50^Medical/Surgical  :16604  
 Internal Medicine[2021]    :1694      2021^Internal Medicine    :1692   88^Intensive Care    :  465  
 SNVMC GENERAL MEDICINE[901]:1468      232^SCPH GENERAL MEDICINE :1220                                
 SCPH GENERAL MEDICINE[232] : 991      230^SNGH GENERAL MEDICINE : 354                                
 (Other)                    :1032      (Other)                   :1202                                
 revenue_location har_admitting_ser_id discharge_kickoff_user_id discharging_ser_id har_atnd_ser_id
 20301000:7900    7668   : 608         KXHOUDSO:  882            901021 :  608      934668 : 530   
 20501000:6584    7436   : 371                 :  482            903682 :  571      7588   : 504   
 20151000:1252    6659   : 337         SXBHAJU :  433            934668 :  545      910357 : 469   
 20201000: 419    7854   : 320         NXLARAKI:  420            7588   :  541      937049 : 433   
 20251000: 389    7588   : 313         ASTORRAL:  387            910305 :  537      6949   : 347   
 20451000: 174    (Other):9056         MXGEBREM:  345            (Other):14296      (Other):8739   
 (Other) : 394    NA's   :6107         (Other) :14163            NA's   :   14      NA's   :6090   
               har_financial_class selfpay_yn    total_charges      num_charges       infection_list    
 2^Medicare              :10557         : 2893   Min.   :   1580   Min.   :     5.0   Length:17112      
 1^Commercial            : 1059    false:13782   1st Qu.:  18952   1st Qu.:   116.0   Class :character  
 115^Medicare Replacement:  964    true :  437   Median :  29701   Median :   197.0   Mode  :character  
 4^Self-pay              :  941                  Mean   :  45559   Mean   :   401.4                     
 100^Blue Cross          :  913                  3rd Qu.:  51761   3rd Qu.:   371.0                     
 3^Medicaid              :  565                  Max.   :1493266   Max.   :101043.0                     
 (Other)                 : 2113                  NA's   :10743     NA's   :10743                        
 isolation_list     incident_date_list visit_dx_count        bmi          expected_length_of_stay
 Length:17112       Length:17112       Min.   : 1.000   Min.   :   6.14   Min.   :  0.000        
 Class :character   Class :character   1st Qu.: 2.000   1st Qu.:  23.65   1st Qu.:  3.000        
 Mode  :character   Mode  :character   Median : 3.000   Median :  27.69   Median :  4.000        
                                       Mean   : 2.941   Mean   :  29.23   Mean   :  6.005        
                                       3rd Qu.: 4.000   3rd Qu.:  32.84   3rd Qu.:  7.000        
                                       Max.   :42.000   Max.   :2926.40   Max.   :580.000        
                                       NA's   :1304     NA's   :44        NA's   :3742           
 sequential_visit_yn num_charges.1      interface_comment 
      :17055         Min.   :     5.0   Length:17112      
 false:   57         1st Qu.:   116.0   Class :character  
                     Median :   197.0   Mode  :character  
                     Mean   :   401.4                     
                     3rd Qu.:   371.0                     
                     Max.   :101043.0                     
                     NA's   :10743 

> head(enc_join_data$infection_list[which(enc_join_data$infection_list!="")])
[1] "C. difficile[5]^ONSET=2019-06-12T00:00:00^ADD=2019-06-13T09:16:00^ADD_EMP=806^SPC_TYPE_C=Stool[54]^SPC_SOURCE_C=Stool[637]"
[2] "C. difficile[5]^ONSET=2018-12-26T00:00:00^ADD=2018-12-27T03:13:00^RESOLVED=2019-01-23T08:07:00^CMT=Patient has C.difficile infection.  Use antibiotics with caution and/or use Contact Enteric Precautions.^ADD_EMP=MDTILLET^RESOLVED_EMP=EBAUTREY^SPC_TYPE_C=Stool[54]^SPC_SOURCE_C=Stool[637]~C. difficile[5]^ADD=2019-01-23T08:10:00^ADD_EMP=EBAUTREY"
[3] "C. difficile[5]^ONSET=2018-12-21T00:00:00^ADD=2018-12-22T03:14:00^SPC_TYPE_C=Stool[54]^SPC_SOURCE_C=Stool[637]"
[4] "C. difficile[5]^ONSET=2018-12-30T00:00:00^ADD=2018-12-31T04:03:00^CMT=Patient has history of C.difficile infection.  Use antibiotics with caution and/or use Contact Enteric Precautions if diarrhea develops.^SPC_TYPE_C=Stool[54]^SPC_SOURCE_C=Stool[637]"
[5] "C. difficile[5]^ONSET=2018-12-25T00:00:00^ADD=2018-12-26T02:01:00^RESOLVED=2019-01-09T08:01:00^CMT=Patient has history of C.difficile infection.  Use antibiotics with caution and/or use Contact Enteric Precautions if diarrhea develops.^RESOLVED_EMP=KXZASTRO^SPC_TYPE_C=Stool[54]^SPC_SOURCE_C=Stool[637]~Influenza[3]^ONSET=2019-02-16T00:00:00^ADD=2019-02-16T08:11:00^RESOLVED=2019-02-22T11:03:00^RESOLVED_EMP=KXZASTRO^SPC_TYPE_C=Various culture specimens[81]^SPC_SOURCE_C=Nasopharyngeal Swab[441]"
[6] "C. difficile[5]^ONSET=2018-12-15T00:00:00^ADD=2018-12-16T03:34:00^SPC_TYPE_C=Stool[54]^SPC_SOURCE_C=Stool[637]"

> head(enc_join_data$isolation_list[which(enc_join_data$isolation_list!="")])
[1] "Droplet Precautions[3]^ADD=2019-02-10T21:17:00^REMOVED=2019-02-16T16:40:00^CMT=Present on arrival^ADD_USER=TMPASCAL^REMOVED_USER=761^ORD_ID=657345075"
[2] "Contact Precautions[1]^ADD=2019-06-11T05:58:00^REMOVED=2019-06-19T21:03:00^CMT=(+) MRSA wound 6/7/2019^ADD_USER=AGCRONAN^REMOVED_USER=761^ORD_ID=688628119~14^ADD=2019-06-12T10:01:00^REMOVED=2019-06-19T21:03:00^ADD_USER=LHVAN^REMOVED_USER=761^ORD_ID=689017939"
[3] "Contact Enteric Precautions[14]^ADD=2018-12-09T00:59:00^REMOVED=2018-12-09T04:27:00^ADD_USER=SFEPLING^REMOVED_USER=SMCALLAH^ORD_ID=642795717~14^ADD=2018-12-12T10:22:00^REMOVED=2018-12-14T13:54:00^ADD_USER=NBRETTEN^REMOVED_USER=JAARROYO^ORD_ID=643566661~14^ADD=2018-12-12T12:56:00^REMOVED=2018-12-14T01:29:00^ADD_USER=MEGRIDL1^REMOVED_USER=KTWASHIN^ORD_ID=643623778"
[4] "Contact Enteric Precautions[14]^ADD=2018-12-19T03:55:00^REMOVED=2018-12-19T17:53:00^ADD_USER=DXKACHNO^REMOVED_USER=MGBABSK1^ORD_ID=645130506~14^ADD=2018-12-19T03:55:00^REMOVED=2018-12-19T17:53:00^ADD_USER=DXKACHNO^REMOVED_USER=MGBABSK1^ORD_ID=645130508"
[5] "Contact Enteric Precautions[14]^ADD=2018-12-17T04:51:00^REMOVED=2018-12-17T11:44:00^ADD_USER=EJNOEL^REMOVED_USER=SWMINOR^ORD_ID=644549887~14^ADD=2018-12-17T11:44:00^REMOVED=2018-12-18T04:28:00^ADD_USER=SWMINOR^REMOVED_USER=BTNEECE^ORD_ID=644667202"
[6] "Contact Precautions[1]^ADD=2018-12-10T04:14:00^REMOVED=2019-01-15T18:13:00^ADD_USER=JEMORRIS^REMOVED_USER=761^ORD_ID=642911750"

> head(enc_join_data$incident_date_list[which(enc_join_data$incident_date_list!="")])
[1] "47^2019-04-27^NA" "55^2019-04-10^NA" "04^2019-04-01^NA" "04^2019-04-10^NA" "04^2019-04-17^NA" "55^2019-04-28^NA"

##join enc data onto frame of each day for stay...

```{r join_enc_stayday, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
length(enc_ord.hosp$visit_id) * length(days_list)
stayday <- stayday %>% 
  left_join(enc_join_data, by=c('visit_id'='visit_id'), suffix=c(".x",".y"))
#stayday$day_date <- as.Date(as.POSIXct(as.numeric(as.POSIXct(stayday$inp_admit_dttm)) + 
#                                         (stayday$day_ordinal*86400), origin = "1970-01-01")) #seconds in a day
#starting from admit_date rather than inp_admit_date because atnd data includes ED/Obs
stayday$day_date <- as.Date(stayday$admit_dttm) + stayday$day_ordinal
dim(stayday)
#stayday <- stayday[which(stayday$day_ordinal < stayday$LengthOfStay),] 

#stopped using above because the atnd data doesn't line up due to admissions that aren't inp_admits. 
#size increased from 263,140 to 291,743
stayday <- stayday[which(stayday$day_ordinal <= stayday$max_ordinal_day),]
dim(stayday) #was 263140 length, now: 291743, now: 292367

length(enc_ord.hosp$visit_id) * length(days_list) #17779538
#enc_ord.hosp$e_visit_id
#testvis <- c("123","2345","13415","663456")
#visit_list <- matrix(testvis, nrow=length(testvis),ncol=1); visit_list
#rep(visit_list, length(days_list))
#rep(days_list, length(visit_list))
cols.names <- c("inp_admit_dttm","disch_dttm","day_date","admission_date","discharge_date","encounter_day",
                "inpatient_admit_date", "date","day_ordinal")
cols <- which(colnames(stayday) %in% cols.names)
head(stayday[,cols],10)
```

```{r calc_days_elapsed, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
#TODO: compare this with the temp one to make sure it checks out...
stayday$elapsed_inpt_days <- as.Date(stayday$day_date) - as.Date(stayday$inp_admit_dttm)
stayday$y.days_until_disch <- as.Date(stayday$disch_dttm) - as.Date(stayday$day_date)
# stopped using this when day_ordinal stopped lining up with LOS due to ED/Obs time
# stayday$y.days_until_disch <- as.integer(floor(stayday$LengthOfStay - stayday$day_ordinal))
# stayday$y.disch[which(stayday$y.days_until_disch == 0)] <- 1 
stayday$y.disch <- as.factor(stayday$day_ordinal == stayday$max_ordinal_day)

stayday$y.disch.2 <- stayday$day_ordinal == (stayday$max_ordinal_day - 1)
stayday$y.disch.2[which(stayday$day_ordinal > stayday$max_ordinal_day - 1)] <- NA
stayday$y.disch.2 <- as.factor(stayday$y.disch.2)

stayday$y.disch.3 <- as.factor(stayday$day_ordinal == (stayday$max_ordinal_day - 2))
stayday$y.disch.3[which(stayday$day_ordinal > stayday$max_ordinal_day - 2)] <- NA
stayday$y.disch.3 <- as.factor(stayday$y.disch.3)

stayday$y.disch.4 <- as.factor(stayday$day_ordinal == (stayday$max_ordinal_day - 3))
stayday$y.disch.4[which(stayday$day_ordinal > stayday$max_ordinal_day - 3)] <- NA
stayday$y.disch.4 <- as.factor(stayday$y.disch.4)

stayday$y.disch.5 <- as.factor(stayday$day_ordinal == (stayday$max_ordinal_day - 4))
stayday$y.disch.5[which(stayday$day_ordinal > stayday$max_ordinal_day - 4)] <- NA
stayday$y.disch.5 <- as.factor(stayday$y.disch.5)

summary(stayday$y.days_until_disch)
summary(stayday$y.disch)
length(stayday$y.days_until_disch[which(is.na(stayday$y.days_until_disch))])
cols.names <- c("inp_admit_dttm","disch_dttm","day_date","admission_date","discharge_date","encounter_day",
                "inpatient_admit_date", "date","day_ordinal","y.days_until_disch","elapsed_inpt_days","max_ordinal_day","y.disch","y.disch.2","y.disch.3","y.disch.4")
cols <- which(colnames(stayday) %in% cols.names)
head(stayday[1000:2000,cols],50)

summary(stayday$y.disch)
# FALSE   TRUE 
#248029  44338
#0.1787614
summary(stayday$y.disch.2)
# FALSE   TRUE   NA's 
#204374  43655  44338 
#0.2136035
summary(stayday$y.disch.3)
#FALSE   TRUE   NA's 
#165881  38493  87993
#0.2320519
summary(stayday$y.disch.4)
#FALSE   TRUE   NA's 
#136471  29410 126486 
#0.2155037
summary(stayday$y.disch.5)
#FALSE   TRUE   NA's 
#114596  21875 155896 
#0.190888
```

```{r calc_days_elapsed, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
stayday$day_of_week <- as.factor(weekdays(stayday$day_date))
summary(stayday$day_of_week)
require(tis)
stayday$day_holiday <- isHoliday(stayday$day_date)
stayday$day_next_holiday <- isHoliday(as.Date(stayday$day_date) + 1)
stayday$day_prev_holiday <- isHoliday(as.Date(stayday$day_date) - 1)
#   Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#    42688     41693     39419     38592     43087     43004     43260
#   Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#    42764     41802     39498     38679     43145     43107     43372 
```

```{r}
summary(stayday$day_holiday) #TGH FALSE:284328  TRUE:7415
summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0)])
#   Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#     7800      5939      5376      4335      6931      6758      7083
length(stayday$day_holiday[which(stayday$day_holiday == TRUE)]) / length(stayday$day_holiday) #TGH: rate of holidays = 0.02541621
length(stayday$day_holiday[which(stayday$day_holiday == TRUE & stayday$y.days_until_disch == 0)]) /
  length(stayday$day_holiday[which(stayday$y.days_until_disch == 0)]) #TGH: rate of holiday discharges = 0.0224775

length(stayday$day_next_holiday[which(stayday$day_next_holiday == TRUE)]) / length(stayday$day_next_holiday) #TGH: rate of next day holidays = 0.02545048
length(stayday$day_next_holiday[which(stayday$day_next_holiday == TRUE & stayday$y.days_until_disch == 0)]) /
  length(stayday$day_next_holiday[which(stayday$y.days_until_disch == 0)]) #TGH: rate of next day holiday discharges = 0.02406042

length(stayday$day_prev_holiday[which(stayday$day_prev_holiday == TRUE)])/length(stayday$day_prev_holiday) #TGH: rate of previous day holidays = 0.02663646
length(stayday$day_prev_holiday[which(stayday$day_prev_holiday == TRUE & stayday$y.days_until_disch == 0)]) / 
  length(stayday$day_prev_holiday[which(stayday$y.days_until_disch == 0)]) #TGH: rate of previous day holiday discharges = 0.02562073
```

For sentara:
tentatively looks like discharge rates are lower on holidays...
next day being a holiday might increase discharge rates...need to validate with larger sample
previous day discharge seems to be erratic in influence, need more sample

For TGH:
tentatively looks like discharge rates are lower on holidays...
tentatively looks like discharge rates are lower when next day is a holiday...need to validate with larger sample
previous day discharge seems to be erratic in influence, need more sample

```{r}
summary(stayday$day_of_week)
#   Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
 #   42688     41693     39419     38592     43087     43004     43260 
summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0)])
#   Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#     7800      5939      5376      4335      6931      6758      7083
mapply("/",
       summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0)]),
       summary(stayday$day_of_week),
       SIMPLIFY = FALSE)
# $Friday [1] 0.1827211
# $Monday [1] 0.142446
# $Saturday [1] 0.1363809
# $Sunday [1] 0.112329
# $Thursday [1] 0.1608606
# $Tuesday [1] 0.1571482
# $Wednesday [1] 0.1637309
summary(stayday$day_of_week[which(stayday$day_holiday == TRUE)])
#   Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#        0      4641         0         0      1435       954       385 
summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0 & stayday$day_holiday == TRUE)])
#      Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#        0       638         0         0       198        82        76 
mapply("/",
       summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0 & stayday$day_holiday == TRUE)]),
       summary(stayday$day_of_week[which(stayday$day_holiday == TRUE)]),
       SIMPLIFY = FALSE)
# $Friday[1] NaN
# $Monday[1] 0.1374704
# $Saturday[1] NaN
# $Sunday[1] NaN
# $Thursday[1] 0.1379791
# $Tuesday[1] 0.08595388
# $Wednesday[1] 0.1974026
summary(stayday$day_of_week[which(stayday$day_next_holiday == TRUE)])
#    Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#        0       837         0      4445         0       578      1565 
summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0 & stayday$day_next_holiday == TRUE)])
#     Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#        0         0         0       522         0       264       278
mapply("/",
       summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0 & stayday$day_next_holiday == TRUE)]),
       summary(stayday$day_of_week[which(stayday$day_next_holiday == TRUE)]),
       SIMPLIFY = FALSE)
# $Friday[1] NaN
# $Monday[1] 0
# $Saturday[1] NaN
# $Sunday[1] 0.1174353
# $Thursday[1] NaN
# $Tuesday[1] 0.4567474
# $Wednesday[1] 0.1776358
summary(stayday$day_of_week[which(stayday$day_prev_holiday == TRUE)])
#  Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#     1461         0         0         0       385      4875      1050 
summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0 & stayday$day_prev_holiday == TRUE)])
#      Friday    Monday  Saturday    Sunday  Thursday   Tuesday Wednesday 
#      249         0         0         0        76       690       118 
mapply("/",
       summary(stayday$day_of_week[which(stayday$y.days_until_disch == 0 & stayday$day_prev_holiday == TRUE)]),
       summary(stayday$day_of_week[which(stayday$day_prev_holiday == TRUE)]),
       SIMPLIFY = FALSE)
# $Friday [1] 0.1704312
# $Monday [1] NaN
# $Saturday [1] NaN
# $Sunday [1] NaN
# $Thursday [1] 0.1974026
# $Tuesday[1] 0.1415385
# $Wednesday[1] 0.112381
```

```{r}
stayday %>%
  group_by(day_of_week) %>%
  summarize(disch_rate = mean(day_holiday, na.rm = TRUE))
```
 selfpay_yn    visit_dx_count        bmi          sequential_visit_yn    day_of_week   
                      :   14   20301000:45844   2^Medicare              :62096         :16864   Min.   : 1.000   Min.   :   6.14        :97125         Friday   :13550  
 45^Emergency Medicine:   40   20501000:30481   115^Medicare Replacement: 6654    false:77531   1st Qu.: 2.000   1st Qu.:  23.28   false:  254         Monday   :14520  
 50^Medical/Surgical  :93849   20151000: 8003   1^Commercial            : 5422    true : 2984   Median : 3.000   Median :  27.40                       Saturday :13223  
 88^Intensive Care    : 3476   20251000: 5384   4^Self-pay              : 4524                  Mean   : 3.284   Mean   :  29.38                       Sunday   :13815  
                               20201000: 3186   100^Blue Cross          : 4409                  3rd Qu.: 4.000   3rd Qu.:  32.88                       Thursday :13883  
                               20252000: 1518   3^Medicaid              : 3563                  Max.   :42.000   Max.   :2926.40                       Tuesday  :14391  
                               (Other) : 2963   (Other)                 :10711                  NA's   :7179     NA's   :129                           Wednesday:13997  
 day_holiday     day_next_holiday day_prev_holiday y.disch  
 Mode :logical   Mode :logical    Mode :logical    0:81083  
 FALSE:94563     FALSE:94603      FALSE:94554      1:16296  
 TRUE :2816      TRUE :2776       TRUE :2825   
```{r}
#TODO: bill drg isn't known, can this be done with a working DRG or by calculating/predicting DRG?
#TODO: expected_disch_dt is probably updated throughout the stay...
stayday$post_amlos <- stayday$elapsed_inpt_days - stayday$drg_amlos
stayday$post_gmlos <- stayday$elapsed_inpt_days - stayday$drg_gmlos
stayday$post_expect_los <-  as.numeric(as.character(as.Date(stayday$inp_admit_dttm) + stayday$elapsed_inpt_days - as.Date(stayday$expected_disch_dttm)))
stayday$post_expect_los_flag <- as.Date(stayday$inp_admit_dttm) + stayday$elapsed_inpt_days >= as.Date(stayday$expected_disch_dttm)
summary(stayday$post_amlos)
summary(stayday$post_gmlos)
summary(stayday$post_expect_los_flag)
summary(stayday$post_expect_los)
summary(stayday$post_amlos[which(stayday$y.days_until_disch == 0 )])
summary(stayday$post_gmlos[which(stayday$y.days_until_disch == 0 )])
summary(stayday$post_expect_los[which(stayday$y.days_until_disch == 0 )])

cols.names <- c("post_amlos","post_gmlos","day_date","post_expect_los","post_expect_los_flag","encounter_day","inpatient_admit_date", "date","day_ordinal","y.days_until_disch","elapsed_inpt_days","y.disch")
cols <- which(colnames(stayday) %in% cols.names)
head(stayday[,cols],10)
```

##join on the atnd daily data

```{r}
dim(stayday) #291743
atnd.tbl.sorted[,LengthOfStay:=NULL]            #equal to LengthOfStay calculated here
atnd.tbl.sorted[,date:=NULL]                    #equal to day_date (calculated here)
atnd.tbl.sorted[,patient_class:=NULL]           #equal to pat_class from view_encounters
atnd.tbl.sorted[,acuity_level:=NULL]            #equal to acuity_level from view_encounters
atnd.tbl.sorted[,max_ordinal_day:=NULL]         #already pulled in when joined the unique'd version of this table earlier
atnd.tbl.sorted[,total_charges:=NULL]           #equal to total_charges from view_encounters
atnd.tbl.sorted[,ed_disposition:=NULL]          #equal to ed_disposition from view_encounters
atnd.tbl.sorted[,inpatient_admit_date:=NULL]    #equal to inp_admit_dttm from view_encounters
atnd.tbl.sorted[,admission_source:=NULL]        #equal to admit_source from view_encounters
atnd.tbl.sorted[,financial_class:=NULL]         #prefer har_financial_class from view_encounters
atnd.tbl.sorted[,service:=NULL]                 #service is very similar to view_encounters.har_hospital_service, but not exactly the same...less nulls in har_hospital_service
atnd.tbl.sorted[,admission_type:=NULL]

atnd.tbl.sorted$provider_id <- as.factor(atnd.tbl.sorted$provider_id)
atnd.tbl.sorted$facility_id <- as.factor(atnd.tbl.sorted$facility_id)
atnd.tbl.sorted$location_id <- as.factor(atnd.tbl.sorted$location_id)

#df3[, c("foo","bar"):=NULL]  # remove two columns

stayday.temp <- data.table(stayday %>% 
  left_join(atnd.tbl.sorted, by=c('visit_id'='visit','day_ordinal' = 'ordinal_day'), suffix=c(".x",".y")))
dim(stayday.temp) #292367x123 old:291743

#todo: check if this is due to not filtering on users or something else...
stayday.temp <- stayday.temp[which(!is.na(stayday.temp$encounter_id)),]
dim(stayday.temp) #284924x123 old: 284320, was 284210
stayday.temp <- stayday.temp[which(stayday.temp$disch_disposition != "20^Expired" 
                                   & stayday.temp$disch_disposition != "7^Left Against Medical Advice"
                                   & stayday.temp$ed_disposition != "AMA" 
                                   & stayday.temp$ed_disposition != "Chart.Made.in.Error"),]
stayday.temp$disch_disposition <- droplevels(stayday.temp$disch_disposition)  #drop the levels for expired and LAMA
dim(stayday.temp) #284912x123, old: 284308
# summary(stayday.temp$disch_disposition)
# 20^Expired: 3
# 7^Left Against Medical Advice: 9
# AMA: 
# Chart.Made.in.Error: 
```

```{r}
#atnd.tbl.sorted <- atnd.tbl.sorted[,c(1:10)]
colnames(atnd.tbl.sorted)
colnames(stayday.temp)
```

##inspecting difference between date and day_date

looks like this is due to agathos modifying the last row of atnd data based on signer of discharge note, but incorrectly re-assigning the date (in 24 cases out of 290k). Day ordinal matches in all of the 290k cases (makes sense since we joined on it...)
```{r}
cols.names <- c("inp_admit_dttm","disch_dttm","day_date","admission_date","discharge_date","encounter_day","inpatient_admit_date", "date","day_ordinal")
cols <- which(colnames(stayday.temp) %in% cols.names)

stayday.temp <- as.data.frame(stayday.temp)

head(stayday.temp[which(stayday.temp$date != stayday.temp$day_date), cols])
dim(stayday.temp[which(stayday.temp$date != stayday.temp$day_date), cols])[1]
```

## day ordinal matches in all of the 290k cases (makes sense since we joined on it...)

```{r}
# library(lubridate)
# cols.names <- c("inp_admit_dttm","disch_dttm","day_date","admission_date","discharge_date","encounter_day","inpatient_admit_date", "ed_disposition.x","ed_disposition.y")
# cols <- which(colnames(stayday.temp) %in% cols.names)
# 
# foo <- data.frame(do.call('rbind', strsplit(as.character(stayday.temp$ed_disposition.x),split="^",fixed=TRUE)))
# foo$temp <-stayday.temp[which(stayday.temp$ed_disposition.x != ""),]$ed_disposition.y
# 
# head(stayday.temp[which((as.character(foo$temp) != as.character(foo$X2)) & (foo$temp != "")), cols])
# dim(stayday.temp[which((foo$temp != foo$X2) & (foo$temp != "")), cols])[1]
```

###planned readmits

```{r}
require(data.table)
require(dplyr)

unique(stayday.temp$patient_status[stayday.temp$patient_status %like% "Readmission"])
unique(stayday.temp$disch_disposition[stayday.temp$disch_disposition %like% "Readmission"])

stayday.temp$readmit_planned <- if_else((stayday.temp$disch_disposition %like% "Readmission") 
                                        | (stayday.temp$patient_status %like% "Readmission"),1,0,missing=0)

# | "87^Disch/Trans to Court/Law Enforcement w/a Planned Readmission"
# | "81^Disch to Home or Self-care w/a Planned Readmission"
# | "82^Disch/Trans to a Short-Term Gen Hosp for Inpt care w/a Planned Readmission"
# | "90^Disch/Trans to an Inpt Rehab Facility/Unit w/a Planned Readmission"
# | "94^Disch/Trans to a CAH Hospital with a Planned Readmission"
# | "93^Disch/Trans to a Psych Hosp/Unit w/a Planned Readmission"
# | "95^Disch/Trans to HC entity not defined elsewhere in this list w/a Planned Readmission"
# | "85^Disch/Trans to a Designated Cancer Ctr or Children's Hosp w/a Planned Readmission"
# | "83^Disch/Trans to a SNF w/Mcare certification w/a Planned Readmission"
# | "86^Disch/Trans to Home under care of Organized HHS Org w/a Planned Readmission"

sum(stayday.temp$readmit_planned)

```

##identify handoffs

```{r calc_handoff_data, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
library(dplyr)
#TODO: interaction between inp_admit_accommodation * inp_admit_level_of_care * room_accommodation * bed_type

# day_handoff means that yesterday the patient wwas in house and the primary attending was different from today
# TODO: need to predict whether day should be a handoff, then use that in predictive model...

stayday.temp$day_handoff <- ((stayday.temp$from_prov != stayday.temp$provider_id) | 
                               is.na(stayday.temp$from_prov)) & 
    #  (stayday.temp$from_enc == stayday.temp$encounter_id) #this is no good when atnd data was null
    (stayday.temp$day_ordinal > 0)

stayday.temp[which(stayday.temp$day_ordinal == 0),]$day_handoff <- NA

stayday.temp$next_day_handoff <- ((stayday.temp$to_prov != stayday.temp$provider_id) | 
                               is.na(stayday.temp$to_prov)) & 
  (stayday.temp$y.days_until_disch > 0)
stayday.temp[which(stayday.temp$y.days_until_disch == 0),]$next_day_handoff <- NA

stayday.temp <- data.table(stayday.temp)

stayday.temp[, prev_day_handoff := shift(day_handoff, n=1L, type="lag")]
stayday.temp[which(stayday.temp$day_ordinal == 0),]$prev_day_handoff <- NA
```

```{r assess_handoff_data, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
stayday.temp <- as.data.frame(stayday.temp)

stayday.temp %>%
  group_by(day_of_week) %>%
  summarize(handoff_rate = mean(day_handoff, na.rm = TRUE))

# stayday.temp %>%
#   group_by(day_of_week) %>%
#   summarize(handoff_rate = mean(next_day_handoff, na.rm = TRUE))
# 
stayday.temp %>%
  group_by(day_of_week) %>%
  summarize(handoff_rate = mean(prev_day_handoff, na.rm = TRUE))

stayday.temp[which(stayday.temp$attending_class != 1),] %>%
  group_by(discharge_summary_class,day_handoff,attending_class) %>%
  summarize(disch_rate_handoff = describe(as.numeric(y.disch)-1))

stayday.temp %>%
  group_by(day_handoff) %>%
  summarize(disch_rate_handoff = describe(as.numeric(y.disch)-1))
# stayday.temp %>%
#   group_by(day_of_week,next_day_handoff) %>%
#   summarize(disch_rate_next_Day_handoff = describe(as.numeric(y.disch)-1, na.rm = TRUE)) %>%
#   unpack(cols = disch_rate_next_Day_handoff)
# 
# stayday.temp %>%
#   group_by(day_of_week,prev_day_handoff) %>%
#   summarize(disch_rate_prev_Day_handoff = describe(as.numeric(y.disch)-1, na.rm = TRUE)) %>%
#   unpack(cols = disch_rate_prev_Day_handoff)

stayday.temp %>%
  group_by(y.disch) %>%
  summarize(disch_rate = describe(as.numeric(attending_class)))

stayday.temp[which(stayday.temp$attending_class == 1),] %>%
  group_by(day_handoff,attending_class) %>%
  summarize(disch_rate_handoff = describe(as.numeric(y.disch)-1))# %>%
  #unpack(cols = disch_rate_handoff)

stayday.temp[which(stayday.temp$attending_class != 1),] %>%
  group_by(day_handoff,attending_class) %>%
  summarize(disch_rate_handoff = describe(as.numeric(y.disch)-1))
```
```{r}
stayday.temp$day_handoff <- as.factor(stayday.temp$day_handoff)
stayday.temp$next_day_handoff <- as.factor(stayday.temp$next_day_handoff)
stayday.temp$prev_day_handoff <- as.factor(stayday.temp$prev_day_handoff)
stayday.temp$post_expect_los_flag <- as.factor(stayday.temp$post_expect_los_flag)
```


```{r viz_post_amlos, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=stayday[which(stayday$post_amlos > -10 & stayday$post_amlos < 10),], aes(post_amlos)) +
  geom_density(aes(y=..count../10), alpha=0.9, fill = "gray", color=NA) + 
  geom_histogram(alpha = .4, binwidth=.1, fill="slateblue") +
  xlab("Days past DRG AMLoS") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
a <- NULL
```

```{r viz_post_amlos_at_disch, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=stayday[which(stayday$post_amlos > -10 & stayday$post_amlos < 10 & stayday$y.days_until_disch == 0),], aes(post_amlos)) +
  geom_histogram(alpha = .5, binwidth=.1, fill="slateblue") +
  geom_density(aes(y=..count../10), alpha=0.3) + 
  xlab("Days past DRG AMLoS at Discharge") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_post_gmlos, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
require(ggplot2)
require(viridis)
theme_set(theme_gray())

#strftime(discharge_dt, format="%H"))
a <- ggplot(data=stayday[which(stayday$post_gmlos > -10 & stayday$post_gmlos < 10),], aes(post_gmlos)) +
  geom_histogram(alpha = .5, binwidth=.1, fill="slateblue") +
  geom_density(aes(y=..count../10), alpha=0.3) + 
  scale_fill_viridis(discrete=TRUE, option="viridis", begin = .3, end = .85, direction = 1, guide = guide_legend(direction="horizontal")) +
  xlab("Days past DRG GMLoS") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_post_gmlos_at_disch, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=stayday[which(stayday$post_gmlos > -10 & stayday$post_gmlos < 10 & stayday$y.days_until_disch == 0),], aes(post_gmlos)) +
  geom_density(aes(y=..count../10), alpha=0.9, fill = "gray", color=NA) + 
  geom_histogram(alpha = .4, binwidth=.1, fill="slateblue") +
  xlab("Days past DRG GMLoS at Discharge") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_post_exp_disch, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=stayday[which(stayday$post_expect_los > -10 & stayday$post_expect_los < 10),], aes(post_expect_los)) +
  geom_density(aes(y=..count../10), alpha=0.9, fill = "gray", color=NA) + 
  geom_histogram(alpha = .4, binwidth=.1, fill="slateblue") +
  xlab("Days past Expected Discharge Date") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_post_exp_disch_at_disch, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=stayday[which(stayday$post_expect_los > -2.5 & stayday$post_expect_los < 3 & stayday$y.days_until_disch == 0 & !is.na(stayday$post_expect_los)),], aes(post_expect_los)) +
  geom_density(aes(y=..count../10), alpha=0.9, fill = "gray", color=NA) + 
  geom_histogram(alpha = .4, binwidth=1, fill="slateblue") +
  xlab("Days past Expected Discharge Datetime at Discharge") +
  theme(legend.position="top?", 
      legend.background = element_blank(), 
      legend.box = "horizontal") + 
  scale_x_continuous(breaks=seq(-4,4,1), labels=seq(-4,4,1), limits=c(-4,4))
a
```

```{r viz_exp_disch_hour, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
a <- ggplot(data=stayday[which(stayday$post_expect_los > -2.5 
                               & stayday$post_expect_los < 3 
                               & stayday$y.days_until_disch == 0),], 
            aes(strftime(expected_disch_dttm, format="%H", tz="America/Detroit")))+
  geom_histogram(alpha = .5, stat="count", binwdith=1, fill="slateblue") +
  xlab("Hour of expected Discharge at Discharge") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_day_of_week_disc, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
a <- ggplot(data=stayday[which(stayday$y.days_until_disch == 0),], aes(day_of_week))+
  geom_histogram(alpha = .5, stat="count", binwdith=1, fill="slateblue") +
  xlab("Day of Week at Discharge") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_day_holiday, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
a <- ggplot(data=stayday[which(stayday$y.days_until_disch == 0),], aes(day_holiday))+
  geom_histogram(alpha = .5, stat="count", binwdith=1, fill="slateblue") +
  xlab("Day is Holiday at Discharge") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

---------

Drop any cases with negative, 0, NULL, or small LoS. Note that this is Inpatient LoS, so we are inherently dropping non inpatient stays, such as ED and Observation. This will make comparisons easier for now, but we could use admit_date when there is no inp_admit_date and assess Obs/ED (observation and emergency department).

Dropping from `r dim(handoffs)[1]` handoff records to `r dim(handoffs[which((handoffs$LengthOfStay > 0.1) & !is.na(handoffs$LengthOfStay) & !is.na(handoffs$AdjLengthOfStay)),])[1]` "clean" and "valid" handoff records.

```{r filter_by_los_notebookonly, cache=FALSE, eval=FALSE, warning=FALSE, message=FALSE}

dim(stayday.temp)[1] #TGH: 284912, old: 284308
#dim(stayday[which((stayday$LengthOfStay > 0.1) & !is.na(stayday$LengthOfStay)),])[1]
stayday.temp <- stayday.temp[which((stayday.temp$LengthOfStay > .999) & !is.na(stayday.temp$LengthOfStay)),]
dim(stayday.temp) #TGH: 279140, old: 284210    123, 278567, 133
#284252
#284154    124
uniqueN(stayday.temp, by="visit_id") #41165, 44132, 41064, 41073
```

handle some NAs...

```{r}
dim(stayday.temp[which(is.na(stayday.temp$visit_dx_count)),])
if(dim(stayday.temp[which(is.na(stayday.temp$visit_dx_count)),])[1] > 0) {
  stayday.temp[which(is.na(stayday.temp$visit_dx_count)),]$visit_dx_count <- 0
}
#impute mean bmi...
length(stayday.temp[which(is.na(stayday.temp$bmi)),]$bmi)
if(length(stayday.temp[which(is.na(stayday.temp$bmi)),]$bmi) > 0) {
  avg_bmi <- mean(stayday.temp[which(!is.na(stayday.temp$bmi)),]$bmi); avg_bmi
  stayday.temp[which(is.na(stayday.temp$bmi)),]$bmi <- avg_bmi
}
```

##format/prune list data

###format/prune incident data

Note that there is a manually created list of incidents that are not clinically relevant and are excluded. Also exclude and incidents with onset date > day_date.

```{r}
library(dplyr)
library(tidyr)

foo.names <-data.frame(do.call('rbind',strsplit(as.character(stayday.temp$incident_date_list),split="~",fixed=TRUE)))
# not using above directly because it remvoves rows that are blank
foo <-  data.frame(incident_list=stayday.temp$incident_date_list) %>%
  separate(incident_list, colnames(foo.names), sep="~", fill="right")
foo.names <- NULL
output <- rep("",length(foo$incident_list))

for (i in names(foo)) {
  bar <- data.frame(foo[[i]])
  names(bar) <- i

  bar <- bar %>%
    separate(i, c("code","title","onset"), sep="\\^", fill="right",remove=FALSE)

  #bar <- data.frame(do.call('rbind', strsplit(as.character(foo[[i]]),split="^",fixed=TRUE)))
  
  rows_to_clean <- which(
    (as.Date(bar$onset) > as.Date(stayday.temp$day_date)) |
       (bar$title == "Last Menstrual Period") |
       (bar$title == "Assessment Date") |
       (bar$title == "Date Cost Outlier Status Begins") |
       (bar$title == "Date of First Test for Pre-Admission Testing") |
       (bar$title == "Scheduled Date of Admission")
     )
  
  if (length(colnames(bar)) > 4) {
    #error
  } else if (length(rows_to_clean) > 0) {
      bar[rows_to_clean,]$code <- NA
      bar[rows_to_clean,]$onset <- NA
      bar[rows_to_clean,]$title <- NA
  }
  coltemp <- paste("clean", i, sep="", collapse=NULL)
  
  #bar %>% unite(as.character(coltemp),code:title,sep="^",na.rm = TRUE, remove = FALSE)
  
  foo[[coltemp]] <- paste(bar$code,bar$title,sep="^",collapse=NULL)
  foo[which(foo[[coltemp]]=="NA^NA" | foo[[coltemp]]=="^NA"), coltemp] <- NA
  
  output[which(!is.na(foo[[coltemp]]))] <- paste(output[which(!is.na(foo[[coltemp]]))],foo[which(!is.na(foo[[coltemp]])),coltemp], sep="~",collapse=NULL)
  
}

stayday.temp$incident <- as.factor(substring(output, 4))

# check that the date exclusion worked...
dim(foo[which(!is.na(foo$cleanX2) & !is.na(foo$cleanX1)),])
dim(foo[which(!is.na(foo$cleanX2)),])
head(stayday.temp[which(!is.na(stayday.temp$incident_date_list) & is.na(stayday.temp$incident)),])
summary(stayday.temp$incident)

foo <- NULL
bar <- NULL
coltemp <- NULL
output <- NULL
```

### format/prune infection_list data

```{r}
#https://stackoverflow.com/questions/17499013/how-do-i-make-a-list-of-data-frames
foo.colcount <-data.frame(do.call('rbind',strsplit(as.character(stayday.temp$infection_list),split="~",fixed=TRUE)))
# # not using above directly because it removes rows that are blank

foo <-  data.frame(infection_list=stayday.temp$infection_list) %>%
  separate(infection_list, colnames(foo.colcount), sep="~", fill="right")
foo.colcount <- NULL
```

```{r}
library(stringr)

#a <- "14594 Rhinovirus[21]^ADD=2018-12-26T15:36:46^RESOLVED=2019-01-11T14:38:04^ADD_EMP=16092^RESOLVED_EMP=13206"
#res <- str_match(a, "\\^RESOLVED=\\s*(.*?)\\s*\\^")[,2]

#get resolved date
f1 = function(x) {
  as.character(as.Date(strftime(str_match(x, "\\^RESOLVED=\\s*(.*?)\\s*\\^")[,2],
           tz="America/Detroit", format="%Y-%m-%dT%H:%M:%S")))
}
#infection type
f2 = function(x) {
  str_match(x, "^.*?(?=\\^)")
}
#get add date
f3 = function(x) {
  as.character(as.Date(strftime(str_match(x, "\\^ADD=\\s*(.*?)\\s*\\^")[,2],
           tz="America/Detroit", format="%Y-%m-%dT%H:%M:%S")))
}
resolve_dates <- data.frame(apply(X=foo,MARGIN=2,FUN=f1))
infects <- data.frame(apply(X=foo,MARGIN=2,FUN=f2))
add_dates <- data.frame(apply(X=foo,MARGIN=2,FUN=f3))

for (i in names(infects)) {
  infects[which(add_dates[[i]] > stayday.temp$day_date
                     | resolve_dates[[i]] < stayday.temp$day_date),i] <- NA
}
require(fastDummies)


paste_noNA <- function(x,sep="|") {
gsub("|" ,sep, toString(x[!is.na(x) & x!="" & x!="NA"] ) ) }

infects$infct <- apply(infects,1, paste_noNA , sep="")
head(infects$infct[which(!is.na(infects$X3))])

infect_dummies <- 
  dummy_cols(infects, ignore_na=TRUE, select_columns="infct", split=", ")#,remove_first_dummy=TRUE, )
stayday.temp <- data.frame(stayday.temp,infect_dummies[,4:length(names(infect_dummies))])
stayday.temp$infct <- ifelse((!is.na(stayday.temp$infct) & (stayday.temp$infct != "")),TRUE,FALSE)
foo <- infect_dummies <- infects <- add_dates <- resolve_dates <- NULL
```

```{r}
stayday.temp$day_handoff <- as.character(stayday.temp$day_handoff)
stayday.temp[(which(is.na(stayday.temp$day_handoff))),]$day_handoff <- "not_applicable"
stayday.temp$day_handoff <- as.factor(stayday.temp$day_handoff)

stayday.temp$prev_day_handoff <- as.character(stayday.temp$prev_day_handoff)
stayday.temp[(which(is.na(stayday.temp$prev_day_handoff))),]$prev_day_handoff <- "not_applicable"
stayday.temp$prev_day_handoff <- as.factor(stayday.temp$prev_day_handoff)

stayday.temp$incident <- as.character(stayday.temp$incident)
stayday.temp[(which(is.na(stayday.temp$incident))),]$incident <- "not_applicable"
stayday.temp$incident <- as.factor(stayday.temp$incident)

stayday.temp$expected_admit <- NULL
stayday.temp$expected_admit <- 0
stayday.temp[which(!is.na(stayday.temp$expected_admit_dttm) & (stayday.temp$expected_admit_dttm != "")),]$expected_admit <- 1
stayday.temp$expected_admit <- as.factor(stayday.temp$expected_admit)

# stayday.temp$infection <- NULL
# stayday.temp$infection <- 0
# stayday.temp[which(!is.na(stayday.temp$infection_list) & (stayday.temp$infection_list != "")),]$infection <- 1
# stayday.temp$infection <- as.factor(stayday.temp$infection)

stayday.temp$interface <- NULL
stayday.temp$interface <- 0
stayday.temp[which(!is.na(stayday.temp$interface_comment) & (stayday.temp$interface_comment != "")),]$interface <- 1
stayday.temp$interface <- as.factor(stayday.temp$interface)

stayday.temp$isolation <- NULL
stayday.temp$isolation <- 0
stayday.temp[which(!is.na(stayday.temp$isolation_list) & (stayday.temp$isolation_list != "")),]$isolation <- 1
stayday.temp$isolation <- as.factor(stayday.temp$isolation)

stayday.temp$DRG_sepsis <- NULL
stayday.temp$DRG_sepsis <- 0
stayday.temp[which((stayday.temp$drg_name == "SEPTICEMIA OR SEVERE SEPSIS W/O MV >96 HOURS W MCC") |
                        (stayday.temp$drg_name == "SEPTICEMIA & DISSEMINATED INFECTIONS") |
                        (stayday.temp$drg_name == "SEPTICEMIA OR SEVERE SEPSIS W MV >96 HOURS OR PERIPHERAL EXTRACORPOREAL MEMBRANE OXYGENATION (ECMO)") |
                        (stayday.temp$drg_name == "SEPTICEMIA OR SEVERE SEPSIS W/O MV >96 HOURS W/O MCC") |
                        (stayday.temp$drg_name == "SEPTICEMIA OR SEVERE SEPSIS W MV >96 HOURS") |
                        (stayday.temp$drg_name == "SEPTICEMIA OR SEVERE SEPSIS WITHOUT MV >96 HOURS WITH MCC") |
                        (stayday.temp$drg_name == "SEPTICEMIA OR SEVERE SEPSIS WITHOUT MV >96 HOURS WITHOUT MCC") |
                        (stayday.temp$drg_name == "SEPTICEMIA AND DISSEMINATED INFECTIONS") |
                        (stayday.temp$drg_name == "SEPTICEMIA OR SEVERE SEPSIS WITH MV >96 HOURS")
                      ),]$DRG_sepsis <- 1
stayday.temp$DRG_sepsis <- as.factor(stayday.temp$DRG_sepsis)

stayday.temp$DRG_parasite <- NULL
stayday.temp$DRG_parasite <- 0
stayday.temp[which((stayday.temp$drg_name == "INFECTIOUS & PARASITIC DISEASES W O.R. PROCEDURE W MCC") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS & PARASITIC DISEASES") |
                        (stayday.temp$drg_name == "INFECTIOUS & PARASITIC DISEASES W O.R. PROCEDURE W CC") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS & PARASITIC DISEASES DIAGNOSES W MCC") |
                        (stayday.temp$drg_name == "INFECTIOUS & PARASITIC DISEASES W O.R. PROCEDURE W/O CC/MCC") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS & PARASITIC DISEASES DIAGNOSES W CC") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS & PARASITIC DISEASES DIAGNOSES W/O CC/MCC") |
                        (stayday.temp$drg_name == "INFECTIOUS & PARASITIC DISEASES INCLUDING HIV W O.R. PROCEDURE") |
                        (stayday.temp$drg_name == "INFECTIOUS AND PARASITIC DISEASES WITH O.R. PROCEDURES WITH MCC") |
                        (stayday.temp$drg_name == "INFECTIOUS AND PARASITIC DISEASES WITH O.R. PROCEDURES WITH CC") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS AND PARASITIC DISEASES DIAGNOSES WITH CC") |
                        (stayday.temp$drg_name == "INFECTIOUS AND PARASITIC DISEASES INCLUDING HIV WITH O.R. PROCEDURE") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS AND PARASITIC DISEASES") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS AND PARASITIC DISEASES DIAGNOSES WITH MCC") |
                        (stayday.temp$drg_name == "OTHER INFECTIOUS AND PARASITIC DISEASES DIAGNOSES WITHOUT CC/MCC")
                      ),]$DRG_parasite <- 1
stayday.temp$DRG_parasite <- as.factor(stayday.temp$DRG_parasite)

stayday.temp$DRG_chest_pain <- NULL
stayday.temp$DRG_chest_pain <- 0
stayday.temp[which((stayday.temp$drg_name == "CHEST PAIN")
                      ),]$DRG_chest_pain <- 1
stayday.temp$DRG_chest_pain <- as.factor(stayday.temp$DRG_chest_pain)

stayday.temp$DRG_arrhythmia <- NULL
stayday.temp$DRG_arrhythmia <- 0
stayday.temp[which((stayday.temp$drg_name == "CARDIAC ARRHYTHMIA & CONDUCTION DISORDERS W MCC") |
                        (stayday.temp$drg_name == "CARDIAC ARRHYTHMIA & CONDUCTION DISORDERS W/O CC/MCC") |
                        (stayday.temp$drg_name == "CARDIAC ARRHYTHMIA & CONDUCTION DISORDERS W CC") |
                        (stayday.temp$drg_name == "CARDIAC ARRHYTHMIA & CONDUCTION DISORDERS") |
                        (stayday.temp$drg_name == "CARDIAC ARRHYTHMIA AND CONDUCTION DISORDERS WITH CC") |
                        (stayday.temp$drg_name == "CARDIAC ARRHYTHMIA AND CONDUCTION DISORDERS WITH MCC") |
                        (stayday.temp$drg_name == "CARDIAC ARRHYTHMIA AND CONDUCTION DISORDERS WITHOUT CC/MCC") |
                        (stayday.temp$drg_name == "CARDIAC ARRHYTHMIA AND CONDUCTION DISORDERS")
                      ),]$DRG_arrhythmia <- 1
stayday.temp$DRG_arrhythmia <- as.factor(stayday.temp$DRG_arrhythmia)

#unique(stayday.temp[drg_name %like% "SEPS"]$drg_name)
#unique(stayday.temp[drg_name %like% "SEPTICEMIA"]$drg_name)

#TODO: add MDC/other higher than DRG level groupings...
#check why drg_SOI and drg_ROM are blank...
#figure out how to add har_hospital_service, visit_service, dept and drg back in (more than 53 levels)
#"dept_name" 
#inp_admit not ICU, but in the icu...
summary(distinct(stayday.temp, visit_id, .keep_all = TRUE))
```

#Patient Level Data

```{r}
require(data.table)
dim(pat.raw) #83373   170
pat.raw <- pat.raw %>% distinct(ept_id, .keep_all = TRUE)
dim(pat.raw) #81263   170
#this won't be need when this is done in the correct order...remove
#pat_id_list <- enc_ord.hosp[stayday.limited$visit_id),]$e_ept_id
#length(pat_id_list) #44144
pat <- pat.raw %>%
  filter(ept_id %in% stayday.temp$ept_id)
dim(pat) #31512   170

pat$medicaid_yn <- FALSE
pat$medicaid_yn[which(!is.na(pat$medicaid_num))] <- TRUE

col.names <- c("ept_id","date_of_birth_dttm","patient_sex","address_zip","marital_status","ethnic_group","race_list","spoken_language","pref_pcp_language","needs_interpreter_yn","religion","employment_status","years_education","alcohol_use","alcohol_oz_per_wk","tobacco_use","tobacco_pack_per_day","tobacco_used_years","smokeless_tobacco","smoking_tobacco","cigarettes_yn","pipes_yn","cigars_yn","snuff_yn","chew_yn","illicit_drug_use","illicit_drug_per_wk","iv_drug_user_yn","alcohol_use","transplant_patient_yn","adv_directive_yn","power_of_attorney_yn","alive_or_deceased","registration_dt","pat_lvl_event_dt","completed_appt_count","patient_type_list","medicaid_yn")
cols <- which(colnames(pat) %in% col.names)
pat <- pat[,cols]
pat$patient_sex <- as.factor(pat$patient_sex)
pat$address_zip <- as.factor(pat$address_zip)
pat$marital_status <- as.factor(pat$marital_status)
pat$ethnic_group <- as.factor(pat$ethnic_group)
pat$race_list <- as.factor(pat$race_list)
pat$spoken_language <- as.factor(pat$spoken_language)
pat$pref_pcp_language <- as.factor(pat$pref_pcp_language)
pat$needs_interpreter_yn <- as.factor(pat$needs_interpreter_yn)
pat$religion <- as.factor(pat$religion)
pat$employment_status <- as.factor(pat$employment_status)
#pat$other_demographics <- as.factor(pat$other_demographics)
pat$smokeless_tobacco <- as.factor(pat$smokeless_tobacco)
pat$tobacco_use <- as.factor(pat$tobacco_use)
pat$alcohol_use <- as.factor(pat$alcohol_use)
pat$smoking_tobacco <- as.factor(pat$smoking_tobacco)
pat$cigarettes_yn <- as.factor(pat$cigarettes_yn)
pat$pipes_yn <- as.factor(pat$pipes_yn)
pat$cigars_yn <- as.factor(pat$cigars_yn)
pat$snuff_yn <- as.factor(pat$snuff_yn)
pat$chew_yn <- as.factor(pat$chew_yn)
pat$illicit_drug_use <- as.factor(pat$illicit_drug_use)
pat$iv_drug_user_yn <- as.factor(pat$iv_drug_user_yn)
pat$transplant_patient_yn <- as.factor(pat$transplant_patient_yn)
pat$adv_directive_yn <- as.factor(pat$adv_directive_yn)
pat$power_of_attorney_yn <- as.factor(pat$power_of_attorney_yn)
pat$alive_or_deceased <- as.factor(pat$alive_or_deceased)
pat$patient_type_list <- as.factor(pat$patient_type_list)

pat$alcohol_oz_per_wk <- as.numeric(pat$alcohol_oz_per_wk)
pat$tobacco_pack_per_day <- as.numeric(pat$tobacco_pack_per_day)
pat$tobacco_used_years <- as.numeric(pat$tobacco_used_years)
pat$illicit_drug_per_wk <- as.numeric(pat$illicit_drug_per_wk)

pat$completed_appt_count[which(pat$completed_appt_count == "")] <- 0
pat$completed_appt_count <- as.numeric(pat$completed_appt_count)

require(stringr)
pat$years_education <- as.character(toupper(str_replace_all(pat$years_education, "[^[:alnum:]]", " ")))
pat$years_education[which(pat$years_education %in% c("NONE"))] <- 0
pat$years_education[which(pat$years_education %in% c("4 TO 5"))] <- 4.5
pat$years_education[which(pat$years_education %in% c("5TH"))] <- 5
pat$years_education[which(pat$years_education %in% c("7TH","7TH GRADE"))] <- 7
pat$years_education[which(pat$years_education %in% c("MIDDLE SCHOOL"))] <- 8
pat$years_education[which(pat$years_education %in% c("9TH","9TH GRADE","9TH WITH GED AND CULINARY","DIDN'T FINISH HIGHSCHOOL","DIDN T FINISH HIGHSCHOOL"))] <- 9
pat$years_education[which(pat$years_education %in% c("11 GRADE","11TH","11TH GRADE","GED","SON IN ARMY AND DAUGHTER"))] <- 11
pat$years_education[which(pat$years_education %in% c("12 YEARS","GED WITH SOME COLLEGE","H.S. GRAD","H S  GRAD","HIGH SCHOOL",
                            "HIGH SCHOOL OR GED","HIGHSCHOOL","HS"))] <- 12
pat$years_education[which(pat$years_education %in% c("12+","1 YEAR COLLEGE","1 YEAR JUNIOR COLLEGE","1 YR COLLEGE","IN COLLEGE",
                            "ONE YEAR OF COLLEGE","SOME COLLEGE","TECH SCH","TECH SCHOOL","TECHNICAL COLLEGE",
                            "TECHNICAL SCHOOL","TRADE SCHOOL","13 5"))] <- 13
pat$years_education[which(pat$years_education %in% c("14 ASSOCIATE DEGREE","14TH","2 YEARS COLLEGE","2 YRS OF COLLEGE","AA",
                            "AA COLLEGE","AS","AS IN COLLEGE AND TRADE","ASSC","ASSCOCIATES","ASSOCIATE",
                            "ASSOCIATES","LPN","14 5"))] <- 14
pat$years_education[which(pat$years_education %in% c("4 YEARS OF COLLEGE","BA","BACH","BACHELOR","BACHELORS","BACHELORS DEGREE","HS, COLLEGE","HS  COLLEGE",
                            "BACHLOR","BNS","BS","BSN","COLLEGE","NURSING","NURSING SCHOOL","POST GRADUATE DEGREE"))] <- 16
pat$years_education[which(pat$years_education %in% c("POST GRADUATED"))] <- 17
pat$years_education[which(pat$years_education %in% c("GRAD SCH","GRAD SCHOOL","GRADUATE SCHOOL","MASTER","MASTERS","MSN-MENTAL HEALTH","MSN MENTAL HEALTH"))] <- 18
pat$years_education[which(pat$years_education %in% c("DOCTORATE OF JURIS PRUDEN","PHD"))] <- 20
levels(as.factor(toupper(pat$years_education[which(is.na(as.numeric(pat$years_education)))])))
median_edu <- median(as.numeric(pat$years_education[which(pat$years_education != "")]))
pat[which((as.numeric(pat$years_education) > 99)
                          | (as.numeric(pat$years_education) < 0)
                          | (pat$years_education == "")),]$years_education <- median_edu
pat$years_education <- as.numeric(pat$years_education)

pat$date_of_birth_dttm <- as.Date(pat$date_of_birth_dttm)
pat$pat_lvl_event_dt <- as.Date(pat$pat_lvl_event_dt)
pat$registration_dt[which(pat$registration_dt == "")] <- NA
pat$registration_dt <- as.Date(pat$registration_dt)
min_reg_dt <- min(pat$registration_dt[which(!is.na(pat$registration_dt))])
pat$registration_dt[which(is.na(pat$registration_dt))] <- min_reg_dt

#calc age
pat$age_years <- as.numeric(as.Date("2019-12-31") - pat$date_of_birth_dttm)/365.25 #quick and dirty leap year handling
summary(pat)

#income data by zipcode:
#irs.gov/statistics/soi-tax-stats-individual-income-tax-statistics-2018-zip-code-data-soi

```

```{r}
for (i in names(pat[,sapply(pat, is.factor) ])) {
  #print(i)
  #print(levels(pat[[i]]))
  pat[[i]] <- droplevels(pat[[i]])
  #print(levels(pat[[i]]))
  #print(length(levels(pat[[i]])))
}
#for (i in names(pat[,sapply(pat, is.factor) ])) {
# print(i)
#  pat[[i]] <- factor(pat[[i]], labels = make.names(levels(pat[[i]])))
#  print(levels(pat[[i]]))
#}
```

```{r}
pat_visits <- pat %>%
  left_join(enc[,c("visit_id","ept_id","admission_dttm","inpatient_admit_dttm","visit_type","appt_type"
                   ,"discharge_dttm","ed_departure_dttm","ed_arrival_dttm","admission_source"
                   ,"admission_type","level_of_care","acuity_level","har_base_class"
                   ,"har_patient_class","patient_class","admit_for_surg_yn"
                   ,"har_hospital_service","patient_status","discharge_disposition"
                   ,"discharge_destination","dept_name","dept_specialty","har_financial_class"
                   ,"selfpay_yn","selfpay_satus","total_charges","num_charges","har_drg_code"
                   ,"msdrg_family_c","drg_mdc_code","drg_name","patient_status_for_drg"
                   ,"drg_severity_of_illness","drg_risk_of_mortality","infection_list"
                   ,"isolation_list","incident_date_list","visit_dx_count","pain_score"
                   ,"temperature","pulse","spo2","bp","bp_systolic","bp_diastolic"
                   ,"respirations","peak_lung_flow","height","weight","bmi","bsa"
                   ,"tobacco_use_yn","created_by_or_yn","sequential_visit_yn","drg_amlos","bed_type")], by=c("ept_id"="ept_id"), suffix=c(".x",".y"))
dim(pat_visits) # 249054     93
#pat_visits <- pat_visits[(pat_visits$visit_id %in% stayday.temp$visit_id),]
#dim(pat_visits)
length(which(is.na(pat_visits$date_of_birth_dttm)))
length(which(is.na(pat_visits$years_education)))
min(pat_visits$admission_dttm)
pat_visits <- pat_visits[which(!is.na(pat_visits$admission_dttm)),]

pat_visits$har_base_class <- as.factor(pat_visits$har_base_class)
pat_visits$visit_type <- as.factor(pat_visits$visit_type)
pat_visits$appt_type <- as.factor(pat_visits$appt_type)
pat_visits$admission_source <- as.factor(pat_visits$admission_source)
pat_visits$level_of_care <- as.factor(pat_visits$level_of_care)
pat_visits$acuity_level <- as.factor(pat_visits$acuity_level)
pat_visits$har_patient_class <- as.factor(pat_visits$har_patient_class)
pat_visits$patient_class <- as.factor(pat_visits$patient_class)
pat_visits$admit_for_surg_yn <- as.factor(pat_visits$admit_for_surg_yn)
pat_visits$har_hospital_service <- as.factor(pat_visits$har_hospital_service)
pat_visits$patient_status <- as.factor(pat_visits$patient_status)
pat_visits$discharge_disposition <- as.factor(pat_visits$discharge_disposition)
pat_visits$discharge_destination <- as.factor(pat_visits$discharge_destination)
pat_visits$dept_name <- as.factor(pat_visits$dept_name)
pat_visits$dept_specialty <- as.factor(pat_visits$dept_specialty)
pat_visits$har_financial_class <- as.factor(pat_visits$har_financial_class)
pat_visits$selfpay_yn <- as.factor(pat_visits$selfpay_yn)
pat_visits$selfpay_satus <- as.factor(pat_visits$selfpay_satus)
pat_visits$har_drg_code <- as.factor(pat_visits$har_drg_code)
pat_visits$msdrg_family_c <- as.factor(pat_visits$msdrg_family_c)
pat_visits$drg_mdc_code <- as.factor(pat_visits$drg_mdc_code)
pat_visits$drg_name <- as.factor(pat_visits$drg_name)
pat_visits$patient_status_for_drg <- as.factor(pat_visits$patient_status_for_drg)
pat_visits$drg_severity_of_illness <- as.factor(pat_visits$drg_severity_of_illness)
pat_visits$drg_risk_of_mortality <- as.factor(pat_visits$drg_risk_of_mortality)
pat_visits$created_by_or_yn <- as.factor(pat_visits$created_by_or_yn)
pat_visits$sequential_visit_yn <- as.factor(pat_visits$sequential_visit_yn)
pat_visits$admission_type <- as.factor(pat_visits$admission_type)

pat_visits$acuity_level[which(pat_visits$acuity_level=="")] <- NA
pat_visits$acuity_level <- droplevels(pat_visits$acuity_level)

pat_visits$admit_for_surg_yn <- if_else((pat_visits$admit_for_surg_yn == "" 
                                         | pat_visits$admit_for_surg_yn == "N" 
                                         | pat_visits$admit_for_surg_yn == FALSE 
                                         | pat_visits$admit_for_surg_yn == "false" 
                                         | pat_visits$admit_for_surg_yn == 0)
                                        ,0,1,missing=0)
```

```{r}
#these LOS calcs are focused on disease burden approximation rather than accuracy...

pat_visits$LengthOfStay <-  (as.numeric(as.POSIXct(pat_visits$discharge_dttm)) - as.numeric(as.POSIXct(pat_visits$admission_dttm))) / (60*60*24)
pat_visits$LengthOfStay[which(pat_visits$LengthOfStay < 0.25)] <- 0.25
pat_visits$LengthOfStay[which(pat_visits$LengthOfStay < 0.5 
                              & (pat_visits$har_base_class == "3^Emergency"
                                 | pat_visits$har_patient_class == "103^Emergency"
                                 | pat_visits$patient_class == "103^Emergency"
                                 | pat_visits$har_hospital_service == "105^Emergency Medicine"))] <- 0.5
pat_visits$LengthOfStay[which(pat_visits$LengthOfStay < 0.75 
                              & (pat_visits$har_patient_class == "104^Observation"
                                 | pat_visits$patient_class == "104^Observation"))] <- 0.75
#I think these are actually all concurrent visits...
pat_visits$LengthOfStay[which((pat_visits$visit_type == "51^Surgery")
                        & !is.na(pat_visits$LengthOfStay)
                        & (pat_visits$LengthOfStay > 1))] <- NA

#note: its ok to assume things based on the har for emergency and observation. the issue with multiple visits on a har mostly only apply to pre/post op visits
pat_visits$log_los <- log(pat_visits$LengthOfStay)

pat_visits$InpLengthOfStay <-  (as.numeric(as.POSIXct(pat_visits$discharge_dttm)) - as.numeric(as.POSIXct(pat_visits$inpatient_admit_dttm))) / (60*60*24)
length(pat_visits$InpLengthOfStay[which((pat_visits$har_base_class=="1^Inpatient") | (pat_visits$har_patient_class=="101^Inpatient"))]) #60301
pat_visits$InpLengthOfStay[which((pat_visits$har_base_class!="1^Inpatient") 
                                 & (pat_visits$har_patient_class!="101^Inpatient") 
                                 & (pat_visits$har_patient_class!="104^Observation")
                                 & (pat_visits$patient_class!="101^Inpatient")
                                 & (pat_visits$patient_class!="104^Observation"))] <- NA

pat_visits$InpLengthOfStay <- if_else((pat_visits$InpLengthOfStay < 1) 
                                 & !is.na(pat_visits$InpLengthOfStay) 
                                 & !is.na(pat_visits$drg_amlos)
                                 & ((pat_visits$patient_class=="101^Inpatient")
                                    | (pat_visits$patient_class=="104^Observation"))
                                 ,pat_visits$drg_amlos,pat_visits$InpLengthOfStay)

pat_visits$InpLengthOfStay <- if_else((pat_visits$InpLengthOfStay < 1) 
                                 & !is.na(pat_visits$InpLengthOfStay) 
                                 & (pat_visits$har_base_class!="2^Outpatient")
                                 & (pat_visits$har_patient_class!="102^Outpatient")
                                 & ((pat_visits$patient_class!="102^Outpatient")
                                    | is.na(pat_visits$appt_type)
                                    | (pat_visits$appt_type==""))
                                 ,1,pat_visits$InpLengthOfStay)

pat_visits$InpLengthOfStay[which(!is.na(pat_visits$appt_type) 
                                 & (pat_visits$appt_type!="") 
                                 & (pat_visits$InpLengthOfStay < 0))] <- NA

#TODO: our consolidate logic for multiple visits on a har is broken....
head(pat_visits[which((pat_visits$InpLengthOfStay < 1) & !is.na(pat_visits$InpLengthOfStay)),c(40:44,50:53,66,88:96)])
#head(pat_visits[which(pat_visits$ept_id=="Z1151358"),c(40:44,50:53,66,88:96)],550) 
```

```{r}
summary(pat_visits)
```

```{r viz_patlos_density, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=pat_visits[which((pat_visits$LengthOfStay > 0) & (pat_visits$LengthOfStay < 3)),], aes(LengthOfStay)) +
  geom_density(aes(y=..count..), alpha=0.5, fill = "slateblue", color=NA) + 
  #geom_histogram(alpha = .4, binwidth=.5, fill="slateblue") +
  xlab("Length of Stay (days)") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_log_patlos_density, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=pat_visits[which((pat_visits$LengthOfStay > 0) & (pat_visits$LengthOfStay < 12)),], aes(log_los)) +
  geom_density(aes(y=..count..), alpha=0.5, fill = "slateblue", color=NA) + 
  #geom_histogram(alpha = .4, binwidth=.5, fill="slateblue") +
  xlab("Log Length of Stay (days)") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_patinplos_density, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=pat_visits[which(pat_visits$InpLengthOfStay < 50),], aes(InpLengthOfStay)) +
  geom_density(aes(y=..count..), alpha=0.5, fill = "slateblue", color=NA) + 
  #geom_histogram(alpha = .4, binwidth=.5, fill="slateblue") +
  xlab("Length of Inp Stay (days)") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```

```{r viz_log_patinplos_density, echo=FALSE, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(gridExtra)
theme_set(theme_gray())
#strftime(discharge_dt, format="%H"))
a <- ggplot(data=pat_visits[which(pat_visits$InpLengthOfStay < 200),], aes(log(InpLengthOfStay))) +
  geom_density(aes(y=..count..), alpha=0.5, fill = "slateblue", color=NA) + 
  #geom_histogram(alpha = .4, binwidth=.5, fill="slateblue") +
  xlab("Log Length of Inp Stay (days)") +
  theme(legend.position="top", 
      legend.background = element_blank(), 
      legend.box = "horizontal")
a
```
###MDC crosswalk

0	Pre-MDC	001 - 017
1	Diseases and Disorders of the Nervous System	020 - 103
2	Diseases and Disorders of the Eye	113 - 125
3	Diseases and Disorders of the Ear, Nose, Mouth And Throat	129 - 159
4	Diseases and Disorders of the Respiratory System	163 - 208
5	Diseases and Disorders of the Circulatory System	215 - 316
6	Diseases and Disorders of the Digestive System	326 - 395
7	Diseases and Disorders of the Hepatobiliary System And Pancreas	405 - 446
8	Diseases and Disorders of the Musculoskeletal System And Connective Tissue	453 - 566
9	Diseases and Disorders of the Skin, Subcutaneous Tissue And Breast	573 - 607
10	Diseases and Disorders of the Endocrine, Nutritional And Metabolic System	614 - 645
11	Diseases and Disorders of the Kidney And Urinary Tract	652 - 700
12	Diseases and Disorders of the Male Reproductive System	707 - 730
13	Diseases and Disorders of the Female Reproductive System	734 - 761
14	Pregnancy, Childbirth And Puerperium	765 - 782
15	Newborn And Other Neonates (Perinatal Period)	789 - 795
16	Diseases and Disorders of the Blood and Blood Forming Organs and Immunological Disorders	799 - 816
17	Myeloproliferative DDs (Poorly Differentiated Neoplasms)	820 - 849
18	Infectious and Parasitic DDs (Systemic or unspecified sites)	853 - 872
19	Mental Diseases and Disorders	876 - 887
20	Alcohol/Drug Use or Induced Mental Disorders	894 - 897
21	Injuries, Poison And Toxic Effect of Drugs	901 - 923
22	Burns	927 - 935
23	Factors Influencing Health Status and Other Contacts with Health Services	939 - 951
24	Multiple Significant Trauma	955 - 965
25	Human Immunodeficiency Virus Infection	969 - 977
MDC Category Missing	981 - 989; 998,999


```{r}
#TODO: for prediction, this should be calculating cum LOS up to the time of the visit.
# Dirty work around to subtract the current visit LOS? still would include future LOS...
pat_visits <- data.table(pat_visits)
pat_visits.sorted <- pat_visits[order(ept_id,admission_dttm),]; dim(pat_visits.sorted) #249053     96

#make sure the date align with the train sample...
max(pat_visits.sorted$discharge_dttm) #"2020-01-31 23:59:00"
pat_visits.sorted <- pat_visits.sorted[which(pat_visits.sorted$discharge_dttm <= as.Date('2019-12-31'))]
max(pat_visits.sorted$discharge_dttm) #"2019-12-31 23:59:00"
dim(pat_visits.sorted) #240141     96, 247813     96

# drop the most recent visit, can't rightfully use that one for history...
pat_visits.sorted[, next_ept_id := shift(ept_id, n=1L, type="lead")]
pat_visits.sorted <- pat_visits.sorted[which(pat_visits.sorted$ept_id == pat_visits.sorted$next_ept_id)]
pat_visits.sorted$next_ept_id <- NULL
dim(pat_visits.sorted) #208650     96, 216322     96

pat_hist <- pat_visits.sorted %>%
  group_by(ept_id) %>% tally() #31,512 x 2
length(which(pat_hist$n==1)) #6324, 6258
pat_hist <- pat_hist[which(pat_hist$n > 1),] #if only one visit, not fair to use it
dim(pat_hist) #19702, 19837     2

#pat_visits.sorted$weight <- as.numeric(pat_visits.sorted$weight)
pat_visits.sorted$weight[which(pat_visits.sorted$weight < 1 | pat_visits.sorted$weight > 16000)] <- NA
pat_visits.sorted[, prev_weight := shift(weight, n=1L, type="lag")]
pat_visits.sorted[, prev_prev_weight := shift(prev_weight, n=1L, type="lag")]
pat_visits.sorted[, prev_ept_id := shift(ept_id, n=1L, type="lag")]
pat_visits.sorted[, prev_prev_ept_id := shift(prev_ept_id, n=1L, type="lag")]
col.names <- c("ept_id","prev_ept_id","prev_prev_ept_id","next_ept_id","weight","prev_weight","prev_prev_weight","weight_loss","weight_loss_pct")
cols <- which(colnames(pat_visits.sorted) %in% col.names)

pat_visits.sorted$prev_weight[which(pat_visits.sorted$prev_ept_id != pat_visits.sorted$ept_id)] <- NA
pat_visits.sorted$prev_prev_weight[which(pat_visits.sorted$prev_prev_ept_id != pat_visits.sorted$ept_id)] <- NA

#try a pull forward in case a visit skipped documentation...
pat_visits.sorted$prev_weight <- if_else(is.na(pat_visits.sorted$prev_weight)
                                    & !is.na(pat_visits.sorted$prev_prev_weight)
                                    ,pat_visits.sorted$prev_prev_weight,pat_visits.sorted$prev_weight)

pat_visits.sorted$weight_loss <- pat_visits.sorted$prev_weight - pat_visits.sorted$weight

pat_visits.sorted$weight_loss_pct <- (pat_visits.sorted$weight_loss) / pat_visits.sorted$prev_weight

#TODO: these are only looking at hospital visit level data. could augment with Dxs and Pxs...(maybe meds?)
pat_visits.sorted$SNF <- if_else((pat_visits.sorted$admission_source == "5^Skilled Nursing Facility, Assisted Living Facility, Intermediate Care Facility")
                          | (pat_visits.sorted$discharge_disposition  =="91^Disch/Trans to a MCARE Certified LTC with a Planned Readmission")
                          | (pat_visits.sorted$discharge_disposition  =="83^Disch/Trans to a SNF with MCARE Certification with a Planned Readmission")
                          | (pat_visits.sorted$discharge_disposition  =="3^Skilled Nursing Facility")
                          | (pat_visits.sorted$discharge_disposition  =="4^Intermediate Care Facility")
                          | (pat_visits.sorted$discharge_disposition  =="92^Disch/Trans to a Nrsg Fac Cert Under MCARE but not MCAID with a Planned Readmission")
                          | (pat_visits.sorted$discharge_disposition  =="90^Disch/Trans to an Inpt Rehab Facility/Unit with a Planned Readmission")
                          | (pat_visits.sorted$discharge_disposition  =="84^Disch/Trans to a Custodial or Supportive Care Facility with a Planned Readmission Readmission")
                          | (pat_visits.sorted$discharge_disposition  =="63^LTAC - Long Term Care")
                          | (pat_visits.sorted$discharge_disposition  =="206^Inpatient Rehab Facility")
                          | (pat_visits.sorted$discharge_disposition  =="62^Rehab Facility")
                          | (pat_visits.sorted$patient_status == "03^Discharged/transferred to Skilled Nursing Facility (SNF) with Medicare Certification")
                          | (pat_visits.sorted$patient_status == "04^Discharged/transferred to a Facility that Provides Custodial or Supportive Care")
                          | (pat_visits.sorted$patient_status == "62^Discharged/transferred to an Inpatient Rehab Facility (IRF)")
                          | (pat_visits.sorted$patient_status == "63^Discharged/transferred to a Medicare Certified Long Term Care Hospital (LTCH)")
                          | (pat_visits.sorted$patient_status == "83^Disch/Trans to a SNF w/Mcare certification w/a Planned Readmission")
                          | (pat_visits.sorted$patient_status == "84^Disch/Trans to a Custodial or Supportive Care Facility w/a Planned Readmission")
                          | (pat_visits.sorted$patient_status == "90^Disch/Trans to an Inpt Rehab Facility/Unit w/a Planned Readmission")
                          | (pat_visits.sorted$patient_status == "91^Disch/Trans to a Mcare Certified LTC w/a Planned Readmission")
                          | (pat_visits.sorted$patient_status == "92^Disch/Trans to a Nrsg Fac under Mcare but not Mcaid w/a Planned Readmission")
                          | (pat_visits.sorted$level_of_care == "3^ICF")
                          | (pat_visits.sorted$level_of_care == "20^Rehab"),
                          1,0)
pat_visits.sorted$psych <- if_else((pat_visits.sorted$discharge_disposition == "93^Disch/Trans to a Psych Hospital/Unit with a Planned Readmission")
                          | (pat_visits.sorted$discharge_disposition == "65^Psychiatric Hospital")
                          | (pat_visits.sorted$discharge_destination == "3^Behavioral Health")
                          | (pat_visits.sorted$drg_mdc_code == "19") # Mental Diseases and Disorders
                          | (pat_visits.sorted$drg_mdc_code == "20") #	Alcohol/Drug Use or Induced Mental Disorders
                          | (pat_visits.sorted$patient_status == "65^Discharged/transferred to a Psychiatric Hospital or Psychiatric Hospital Unit")
                          | (pat_visits.sorted$patient_status == "93^Disch/Trans to a Psych Hosp/Unit w/a Planned Readmission")
                          | (pat_visits.sorted$level_of_care == "21^Psych")
                          | pat_visits.sorted$appt_type == "117001002^PSYCHOLOGICAL F/U"
                          | pat_visits.sorted$appt_type == "11700546^PSYCHOLOGICAL EVALUATION"                                          
                          | pat_visits.sorted$appt_type == "11700546H^PSYCHOLOGICAL EVALUATION"
                          | pat_visits.sorted$appt_type == "11700546L^PSYCHOLOGICAL EVALUATION"                                         
                          | pat_visits.sorted$appt_type == "11700546L2^PSYCHOLOGICAL EVALUATION"
                          | pat_visits.sorted$appt_type == "11700546LU^PSYCHOLOGICAL EVALUATION"  
                          | pat_visits.sorted$appt_type == "1171000100^Psychotherapy",
                          1,0,missing=0) #can get nulls because MDC is numeric
pat_visits.sorted$court <- if_else((pat_visits.sorted$admission_source == "8^Court/Law Enforcement")
                          | (pat_visits.sorted$discharge_disposition == "87^Disch/Trans to Court/Law Enforcement with a Planned Readmission")
                          | (pat_visits.sorted$discharge_disposition == "202^Court/Law Enforcement")
                          | (pat_visits.sorted$patient_status == "21^Discharged/transferred to Court/Law Enforcement")
                          | (pat_visits.sorted$patient_status == "87^Disch/Trans to Court/Law Enforcement w/a Planned Readmission"),  
                          1,0)
pat_visits.sorted$hospice <- if_else((pat_visits.sorted$admission_source == "24^Hospice")
                          | (pat_visits.sorted$discharge_disposition == "51^Hospice/Medical Facility")
                          | (pat_visits.sorted$discharge_disposition == "50^Hospice/Home")
                          | (pat_visits.sorted$patient_status == "50^Hospice - Home")
                          | (pat_visits.sorted$patient_status == "51^Hospice - Medical Facility (Certified) Providing Hospice Level of Care")
                          | (pat_visits.sorted$level_of_care == "7^Hospice")
                          | (pat_visits.sorted$bed_type == "20^Palliative Care/Comfort Measures")
                          , 1,0)
pat_visits.sorted$ICU <- if_else((pat_visits.sorted$level_of_care == "14^Critical Care")
                          | (pat_visits.sorted$level_of_care == "6^ICU")
                           | (pat_visits.sorted$bed_type == "10^Intensive Care Unit (ICU)")
                           | (pat_visits.sorted$bed_type == "16^Surgical ICU")
                           | (pat_visits.sorted$bed_type == "7^Trauma ICU")
                           | (pat_visits.sorted$bed_type == "18^Vascular ICU")
                           | (pat_visits.sorted$bed_type == "19^Burn ICU")
                          ,1,0)
pat_visits.sorted$stepdown_tele <- if_else((pat_visits.sorted$level_of_care == "17^Medical Telemetry")
                          | (pat_visits.sorted$level_of_care == "5^Telemetry")
                          | (pat_visits.sorted$level_of_care == "15^Stepdown")
                          | (pat_visits.sorted$level_of_care == "16^Cardiac Telemetry")
                          | (pat_visits.sorted$bed_type == "5^Telemetry")
                          | (pat_visits.sorted$bed_type == "6^Close Obs")
                          | (pat_visits.sorted$bed_type == "7^Cardiac Telemetry")
                          | (pat_visits.sorted$bed_type == "8^Medical Telemetry")
                          | (pat_visits.sorted$bed_type == "12^Step down Unit")
                          ,1,0)
pat_visits.sorted$outlier <- if_else((pat_visits.sorted$patient_status_for_drg == "3^Cost Outlier")
                                     | (pat_visits.sorted$patient_status_for_drg == "5^Transfer/Cost Outlier")
                                     | (pat_visits.sorted$patient_status_for_drg == "8^Post Acute Care Transfer/Cos")
                                     ,1,0)
pat_visits.sorted$infection <- if_else((pat_visits.sorted$infection_list == "" 
                                        | is.na(pat_visits.sorted$infection_list))
                                     ,0,1)
pat_visits.sorted$isolation <- if_else((pat_visits.sorted$isolation_list == "" 
                                        | is.na(pat_visits.sorted$isolation_list))
                                     ,0,1)

pat_visits.sorted$selfpay <- if_else((pat_visits.sorted$selfpay_yn == "true" 
                                      | pat_visits.sorted$selfpay_yn == TRUE 
                                      | pat_visits.sorted$har_financial_class=="4^Self-pay")
                                     ,1,0)
pat_visits.sorted$bad_debt <- if_else((pat_visits.sorted$selfpay_satus == "5^Bad Debt")
                                     ,1,0)

#lots of other places to get this info...problems, for instance
pat_visits.sorted$cancer <- if_else((pat_visits.sorted$appt_type =="11701138^INFUSION"
                                      | pat_visits.sorted$appt_type =="11701137^CHEMOTHERAPY"
                                      | pat_visits.sorted$appt_type =="11701135^CHEMOTHERAPY"
                                      | pat_visits.sorted$appt_type =="11701134^CHEMOTHERAPY"
                                      | pat_visits.sorted$appt_type =="11701140^INFUSION"
                                      | pat_visits.sorted$appt_type =="11701139^INFUSION"
                                      | pat_visits.sorted$appt_type =="11701133^CHEMOTHERAPY"
                                      | pat_visits.sorted$appt_type =="11701136^CHEMOTHERAPY"
                                      | pat_visits.sorted$appt_type =="11700413^INFUSION"
                                      | pat_visits.sorted$appt_type =="11701141^INFUSION"
                                      | pat_visits.sorted$appt_type =="11700412^CHEMOTHERAPY"
                                      | pat_visits.sorted$appt_type =="11701142^INFUSION"
                                      | pat_visits.sorted$appt_type =="11700097^INFUSION"
                                      | pat_visits.sorted$appt_type =="11700647^PEDIATRIC DAY HOSPITAL INFUSION"
                                      | pat_visits.sorted$appt_type =="11700648^PEDIATRIC DAY HOSPITAL CHEMO" 
                                      | pat_visits.sorted$appt_type =="11701084^PEDIATRIC DAY HOSPITAL CHEMO"
                                      | pat_visits.sorted$appt_type =="11701085^PEDIATRIC DAY HOSPITAL CHEMO"),1,0,missing=0)
#unique(pat_visits.sorted$appt_type[pat_visits.sorted$appt_type %like% "DIALYSIS"])
pat_visits.sorted$dialysis <- if_else((pat_visits.sorted$appt_type =="11700508^NEW PATIENT KIDNEY EVAL (SX)"
                                      | pat_visits.sorted$appt_type == "11700368^INITIAL VISIT KIDNEY"
                                      | pat_visits.sorted$appt_type == "11700079^DIALYSIS"
                                      | pat_visits.sorted$appt_type == "11700080^DIALYSIS"
                                      | pat_visits.sorted$appt_type == "11700081^DIALYSIS"
                                      | pat_visits.sorted$appt_type == "11700082^DIALYSIS"                                                           
                                      | pat_visits.sorted$appt_type == "11700419^DIALYSIS"
                                      | pat_visits.sorted$appt_type == "11700420^DIALYSIS 2 HOURS"                                                  
                                      | pat_visits.sorted$appt_type == "11700421^DIALYSIS"
                                      | pat_visits.sorted$appt_type == "11700424^DIALYSIS" 
                                      | pat_visits.sorted$appt_type == "11700854^PERITONEAL DIALYSIS"
                                      | pat_visits.sorted$appt_type == "15600068^US DOPP DIALYSIS"
                                      | pat_visits.sorted$appt_type == "11701224^DIALYSIS"),1,0,missing=0)
pat_visits.sorted$diabetes <- if_else((pat_visits.sorted$appt_type == "11700951^Endo Diabetic Visit"),1,0,missing=0)
pat_visits.sorted$anti_coag <- if_else((pat_visits.sorted$appt_type == "11700366^ANTI COAG VISIT"),1,0,missing=0)
pat_aggs <- pat_visits.sorted %>%
  group_by(ept_id) %>%
  summarize(n=sum(!is.na(visit_id)),
            n_inpatient=sum((InpLengthOfStay > 0) & (!is.na(InpLengthOfStay))),
            cum_InpLOS = sum(InpLengthOfStay,na.rm=TRUE),
            cum_LOS = sum(LengthOfStay,na.rm=TRUE),
            cum_charges = sum(total_charges,na.rm=TRUE), #make sure these are zero when null....
            cum_dx = sum(visit_dx_count,na.rm=TRUE),
            cum_pain = sum(pain_score,na.rm=TRUE),
            cum_num_charges = sum(num_charges,na.rm=TRUE),
            cum_SNF = sum(SNF),
            cum_psych = sum(psych),
            cum_court = sum(court),
            cum_hospice = sum(hospice),
            cum_outlier = sum(outlier),
            cum_weight_loss = sum(weight_loss,na.rm=TRUE),
            cum_weight_loss_pct = sum(weight_loss_pct,na.rm=TRUE),
            cum_surg = sum(admit_for_surg_yn),
            cum_infect = sum(infection),
            cum_isolation = sum(isolation),
            cum_selfpay = sum(selfpay),
            cum_bad_debt = sum(bad_debt),
            cum_cancer = sum(cancer),
            cum_dialysis = sum(dialysis),
            cum_diabetes = sum(diabetes),
            cum_anti_coag = sum(anti_coag),
            max_ROM = max(as.character(drg_risk_of_mortality)),#null sorts first/lowest
            max_SOI = max(as.character(drg_severity_of_illness)),#null sorts first/lowest
            max_acuity = min(as.character(acuity_level)),
            median_bmi = median(bmi,na.rm=TRUE),
            median_bsa = median(bsa,na.rm=TRUE),
            median_bp_systolic = median(bp_systolic,na.rm=TRUE),
            median_bp_diastolic = median(bp_diastolic,na.rm=TRUE),
            median_respirations = median(respirations,na.rm=TRUE),
            mean_peak_lung_flow = mean(peak_lung_flow,na.rm=TRUE), #these are all "99"...strange...
            #median_height = median(height,na.rm=TRUE), #not numeric, would need parsing
            median_weight = median(weight,na.rm=TRUE),
            median_pulse = median(pulse,na.rm=TRUE),
            median_spo2 = median(spo2,na.rm=TRUE),
            median_temperature = median(temperature,na.rm=TRUE),
            median_pain_score = median(pain_score,na.rm=TRUE)); pat_hist; pat_aggs

pat_aggs$max_ROM <- as.factor(pat_aggs$max_ROM)
pat_aggs$max_SOI <- as.factor(pat_aggs$max_SOI)
pat_aggs$max_acuity <- as.factor(pat_aggs$max_acuity)

dim(pat_aggs) #26,026 x 39
```

###combine over time and statis patient data

```{r}
uniqueN(pat, by="ept_id") #31512
dim(pat) #31512    38
pat.full <- pat %>%
  left_join(pat_aggs, by=c('ept_id'='ept_id'), suffix=c(".x",".y"))
#impute_cols <- c("median_bmi","median_bsa","median_bp_systolic","median_bp_diastolic"
#                 ,"median_respirations","mean_peak_lung_flow","median_weight"
#                 ,"median_pulse","median_spo2","median_temperature","median_pain_score")
pat.full <- data.table(pat.full)
setkey(pat.full, patient_sex)
pat.full[,median_bmi := ifelse(is.na(median_bmi), median(median_bmi, na.rm=TRUE), median_bmi), by=patient_sex]
pat.full[,median_bsa := ifelse(is.na(median_bsa), median(median_bsa, na.rm=TRUE), median_bsa), by=patient_sex]
pat.full[,median_bp_systolic := ifelse(is.na(median_bp_systolic), median(median_bp_systolic, na.rm=TRUE), median_bp_systolic), by=patient_sex]
pat.full[,median_bp_diastolic := ifelse(is.na(median_bp_diastolic), median(median_bp_diastolic, na.rm=TRUE), median_bp_diastolic), by=patient_sex]
pat.full[,median_respirations := ifelse(is.na(median_respirations), median(median_respirations, na.rm=TRUE), median_respirations), by=patient_sex]
pat.full[,mean_peak_lung_flow := ifelse(is.na(mean_peak_lung_flow), median(mean_peak_lung_flow, na.rm=TRUE), mean_peak_lung_flow), by=patient_sex]
pat.full[,median_weight := ifelse(is.na(median_weight), median(median_weight, na.rm=TRUE), median_weight), by=patient_sex]
pat.full[,median_pulse := ifelse(is.na(median_pulse), median(median_pulse, na.rm=TRUE), median_pulse), by=patient_sex]
pat.full[,median_spo2 := ifelse(is.na(median_spo2), median(median_spo2, na.rm=TRUE), median_spo2), by=patient_sex]
pat.full[,median_temperature := ifelse(is.na(median_temperature), median(median_temperature, na.rm=TRUE), median_temperature), by=patient_sex]
pat.full[,median_pain_score := ifelse(is.na(median_pain_score), median(median_pain_score, na.rm=TRUE), median_pain_score), by=patient_sex]

#TODO: could make imputation a little smarter using registration date to identify new patients vs patients who actively didnt have care...
length(which(is.na(pat$registration_dt))) # 0

pat.full <- pat.full %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0))
```

##make a full dataframe for training

```{r}
dim(stayday.temp)
stayday.full <- stayday.temp %>%
  left_join(pat.full[,-c("date_of_birth_dttm","address_zip","mean_peak_lung_flow"
                         ,"pat_lvl_event_dt","registration_dt","alive_or_deceased"
                         ,"pref_pcp_language")]
            , by=c('ept_id'='ept_id')
            , suffix=c(".x",".y"))#,copy=TRUE)
head(stayday.full, 50)
dim(stayday.temp)

dim(stayday.full)
length(which(is.na(stayday.full$day_ordinal)))

uniqueN(stayday.temp, by="ept_id")
uniqueN(pat.full, by="ept_id")
uniqueN(stayday.temp[which(stayday.temp$ept_id %in% pat.full$ept_id),],by="ept_id")
```

##make a full dataframe for training

```{r filter_by_los, cache=FALSE, warning=FALSE, message=FALSE}
dim(stayday.full)
stayday.limited <- stayday.full[which((stayday.full$LengthOfStay > 0.999) 
                                 & !is.na(stayday.full$LengthOfStay)),] 
#head(stayday[order(stayday),])
dim(stayday.limited) # 279140    223, 278567
```

```{r eval=FALSE}
colnames(stayday.limited)
```

```{r}
dim(stayday.limited) # 279140    223
cols.names <- 
c("day_ordinal","expected_admit","expected_time_of_disch","means_of_arrival","patient_escorted_by","patient_status"
  ,"disch_disposition","disch_destination","means_of_depart","room_type","room_reason","drg_qualifier","mdc_code"
  ,"drg_SOI","drg_ROM","admit_type","acuity_level","admit_source","admit_for_surg_yn","dept_specialty"
  ,"revenue_location","har_financial_class","selfpay_yn","incident","visit_dx_count","bmi","sequential_visit_yn"
  ,"interface","ed_disposition","bed_type","room_accommodation","elapsed_inpt_days","day_of_week","day_holiday"
  ,"day_next_holiday","day_prev_holiday","day_handoff","prev_day_handoff","post_amlos"#,"ept_id"
#,"post_gmlos"  #this has null values, need to look into why
#,"post_expect_los","post_expect_los_flag","expected_disch_hour"
#,"next_day_handoff" <- leaks info that patient was still in-house next day
#,"facility_id","location_id"
,"admission_type"        
,"har_hospital_service"
#,"drg_name" #there are 1754 different DRGs at TGH. probably because they aren't all MSDRG, maybe just named variations. just going to use the ones that looked most promising on initial review.
#,"provider_id" #need to handle providers, there are too many to treat as categories...
#TODO: add provider specialty, flag whether provider is hospitalist, whether provider is agathos user
,"DRG_arrhythmia","DRG_chest_pain","DRG_parasite","DRG_sepsis"
,"infct_Adenovirus.22.","infct_Human.Metapneumovirus.20.","infct_Parainfluenza.19."                                    
,"infct_Rhinovirus.21.","infct_r.o.Tuberculosis.5.","infct_Respiratory.Syncitial.Virus.18."
,"infct_Disseminated.Shingles.54.","infct_Shingles.32.","infct_Enteroviral.Infection.for.Diapered.or.Incontinent.45."
,"infct_Haemophilus.influenzae.13.","infct_Head.or.Body.Lice.16.","infct_Influenza.23.","infct_MDR.Klebsiella.28."                                   
,"infct_Meningococcemia.6.","infct_Mycoplasma.12.","infct_Parvovirus.B.19.8.","infct_Pertussis.9."                                         
,"infct_Scabies.17.","infct_Streptococcus.Group.A.11." 
#,"surgical_service"
#,"visit_service"
#,"pat_zip_at_disch" #need to convert this into something more continuous, too many categories
,"infct","incident","DRG_sepsis","DRG_parasite","DRG_chest_pain","DRG_arrhythmia"               
,"isolation"
,"inp_admit_accommodation"      
,"inp_admit_level_of_care"
,"readmit_planned"
,"y.days_until_disch"
,"y.disch","y.disch.2","y.disch.3","y.disch.4","y.disch.5"
, names(pat.full[,-c("ept_id","date_of_birth_dttm","address_zip","mean_peak_lung_flow"
                         ,"pat_lvl_event_dt","registration_dt","alive_or_deceased"
                         ,"pref_pcp_language")])
)
cols <- which(colnames(stayday.limited) %in% cols.names)

#stayday.limited <- stayday.limited[,c(1,10,11,13,14,15,16,17,19,20,22,24,28,29,30,31,32,33,34,35,37,38,43,44,50,51,53,58,59,60,61,63)]
stayday.limited <- data.frame(stayday.limited)
stayday.limited <- stayday.limited[,cols]
summary(stayday.limited)

dim(stayday.limited) #with pat.full: 279140    142, prior to pat.full: 279140     74, old: 284154     52
```
###Create dummies

We might need to make variables into dummies for a few reasons, either for linear modeling or because the randomForest package implementation in R has a 32 level limit per factor variable. [This post](https://stackoverflow.com/questions/33219001/in-rs-randomforest-package-do-factors-have-to-be-explicitly-labeled-as-factors) discusses solutions...

>If you want to use a factor variable you should specify it as such and not leave it as a numeric.
For categorical data ([this](https://stats.stackexchange.com/questions/49243/rs-randomforest-can-not-handle-more-than-32-levels-what-is-workaround) is actually a very good answer on CrossValidated):
A split on a factor with N levels is actually a selection of one of the (2^N)???2 possible combinations. So, the algorithm will check all the possible combinations and choose the one that produces the better split
For numerical data (as seen [here](https://stats.stackexchange.com/questions/76590/how-to-choose-the-split-in-random-forest-for-categorical-predictors-features)):
Numerical predictors are sorted then for every value Gini impurity or entropy is calculated and a threshold is chosen which gives the best split.
So yeah it makes a difference whether you will add it as a factor or as a numeric variable. How much of a difference depends on the actual data.

Let's find out which variables have more than 32 levels...

```{r}
for (i in 1:dim(stayday.limited)[2]) {
  levels.i <- length(levels(stayday.limited[,i]))
  if (levels.i > 32) print(paste("i: ",i, "colname: ", colnames(stayday.limited)[i], "levels: ", levels.i))
}
```

For factors with more 32 levels, we will explicitly split the data into separate dataframes of dummies. Other Dummies will be handled automatically in the randomForest and glmnet packages respectively.

* **Note:** I don't really love this method, and I'd like to circleback and test out other solutions, as well as benchmark performance. Suggestions welcome.

```{r results='hide', warning=FALSE, message=FALSE, error=FALSE}
#need to handle these
stayday.limited$lang <- as.character(stayday.limited$spoken_language)
stayday.limited$lang[which(stayday.limited$lang == "99^swa^Swahili; Kiswahili"
                           | stayday.limited$lang == "93^som^Somali"
                           | stayday.limited$lang == "5^amh^Amharic"
                           | stayday.limited$lang == "4^afr^Afrikaans"
                           )] <- "oth_african"
stayday.limited$lang[which(stayday.limited$lang == "98^srp^Serbian"
                          | stayday.limited$lang == "68^pol^Polish"
                          | stayday.limited$lang == "83^rus^Russian"
                          | stayday.limited$lang == "50^lav^Latvian"
                          | stayday.limited$lang == "126^swe^Swedish"
                          | stayday.limited$lang == "20^deu^German"
                          | stayday.limited$lang == "21^ell^Greek"
                          | stayday.limited$lang == "39^ita^Italian"
                          | stayday.limited$lang == "33^hrv^Croatian"
                          | stayday.limited$lang == "34^hun^Hungarian"
                           )] <- "oth_european"
stayday.limited$lang[which(stayday.limited$lang == "25^fas^Farsi; Persian"
                          | stayday.limited$lang == "111^tur^Turkish"
                          | stayday.limited$lang == "30^heb^Hebrew"
                           )] <- "oth_middle_east"
stayday.limited$lang[which(stayday.limited$lang == "59^nep^Nepali"
                          | stayday.limited$lang == "48^lao^Laotian"
                          | stayday.limited$lang == "47^kor^Korean"
                          | stayday.limited$lang == "37^ind^Indonesian"
                          | stayday.limited$lang == "40^jpn^Japanese"
                          | stayday.limited$lang == "104^tha^Thai"
                          | stayday.limited$lang == "115^vie^Vietnamese"
                          | stayday.limited$lang == "122^zho^Chinese (Mandarin"
                          | stayday.limited$lang == "67^phi^Philippine (Other)"
                          | stayday.limited$lang == "72^qca^Chinese, Cantonese"
                          | stayday.limited$lang == "73^qch^Chinese (Other)"  
                           )] <- "oth_se_asia"
stayday.limited$lang[which(stayday.limited$lang == "114^urd^Urdu Pakistan"
                          | stayday.limited$lang == "28^guj^Gujarati"
                          | stayday.limited$lang == "31^hin^Hindi"
                           )] <- "oth_indian"
stayday.limited$lang <- as.factor(stayday.limited$lang)

stayday.factors <- data.frame(har_hospital_service=stayday.limited$har_hospital_service)
stayday.limited$har_hospital_service <- NULL
#stayday.factors$drg_name <- stayday.limited$drg_name
#stayday.limited$drg_name <- NULL
```

Here is where we will actually create the dummies...

```{r results='hide', warning=FALSE, message=FALSE, error=FALSE}
#https://cran.r-project.org/web/packages/fastDummies/vignettes/making-dummy-variables.html
require(fastDummies)
har_hospital_service.dummies <- dummy_cols(stayday.factors, select_columns="har_hospital_service")
har_hospital_service.dummies$har_hospital_service <- NULL
#drg_name.dummies <- dummy_cols(stayday.factors, select_columns="drg_name")
#drg_name.dummies$drg_name <- NULL
```

```{r}
summary(har_hospital_service.dummies)
#summary(drg_name.dummies)
```

```{r}
race_list <- data.frame(races=stayday.limited$race_list)
race_dummies <- 
  dummy_cols(race_list, ignore_na=TRUE, select_columns="races", split="~")

race_dummies[which(race_dummies["races_20^Puerto Rican ("] == 1
             | race_dummies["races_20^Puerto"] == 1
             | race_dummies["races_20^Puerto Rican (Mainland"] == 1)
             ,"races_20^Puerto Rican"] <- 1
race_dummies[["races_20^Puerto Rican ("]] <- NULL
race_dummies[["races_20^Puerto"]] <- NULL
race_dummies[["races_20^Puerto Rican (Mainland"]] <- NULL

race_dummies[which(race_dummies["races_42^Puerto Rican ("] == 1
             | race_dummies["races_42^Puerto Rican"] == 1
             | race_dummies["races_42^Puerto Rica"] == 1)
             ,"races_42^Puerto Rican (Island)"] <- 1
race_dummies[["races_42^Puerto Rican ("]] <- NULL
race_dummies[["races_42^Puerto Rican"]] <- NULL
race_dummies[["races_42^Puerto Rica"]] <- NULL

race_dummies[which(race_dummies["races_24^European Desc"] == 1
             | race_dummies["races_24^European Desce"] == 1)
             ,"races_24^European Descent"] <- 1
race_dummies[["races_24^European Desce"]] <- NULL
race_dummies[["races_24^European Desc"]] <- NULL

race_dummies[which(race_dummies["races_2^Black or Africa"] == 1
             | race_dummies["races_2^Black or Afri"] == 1
             | race_dummies["races_2^Black or Afr"] == 1)
             ,"races_2^Black or African Americ"] <- 1
race_dummies[["races_2^Black or Africa"]] <- NULL
race_dummies[["races_2^Black or Afri"]] <- NULL
race_dummies[["races_2^Black or Afr"]] <- NULL

race_dummies[which(race_dummies["races_6^Oth"] == 1)
             ,"races_6^Other"] <- 1
race_dummies[["races_6^Oth"]] <- NULL

race_dummies[which(race_dummies["races_16^African (Conti"] == 1)
             ,"races_16^African (Continental)"] <- 1
race_dummies[["races_16^African (Conti"]] <- NULL

race_dummies[which(race_dummies["races_8^Unk"] == 1
             | race_dummies["races_8^Unknow"] == 1
             | race_dummies["races_7^Patient Refused"] == 1)
             ,"races_8^Unknown"] <- 1
race_dummies[["races_8^Unk"]] <- NULL
race_dummies[["races_8^Unknow"]] <- NULL
race_dummies[["races_7^Patient Refused"]] <- NULL

race_dummies[which(race_dummies["races_1^Whi"] == 1)
             ,"races_1^White"] <- 1
race_dummies[["races_1^Whi"]] <- NULL

race_dummies[which(race_dummies["races_25^Arab or Middle"] == 1
             | race_dummies["races_26^North African (Non-Bla"] == 1
             | race_dummies["races_25^Arab or Midd"] == 1)
             ,"races_25^Arab or Middle Eastern"] <- 1
race_dummies[["races_25^Arab or Middle"]] <- NULL
race_dummies[["races_25^Arab or Midd"]] <- NULL
race_dummies[["races_26^North African (Non-Bla"]] <- NULL

race_dummies[which(race_dummies["races_3^American Indian"] == 1)
             ,"races_3^American Indian or Alas"] <- 1
race_dummies[["races_3^American Indian"]] <- NULL

race_dummies[which(race_dummies["races_31^Asian Indian/I"] == 1)
             ,"races_31^Asian Indian/Indian Su"] <- 1
race_dummies[["races_31^Asian Indian/I"]] <- NULL

race_dummies[which(race_dummies["races_5^Native Hawaiian"] == 1
                   | race_dummies["races_22^Guamanian or Charmorro"] == 1
                   | race_dummies["races_12^Filipino"] == 1)
             ,"races_5^Native Hawaiian or Othe"] <- 1
race_dummies[["races_5^Native Hawaiian"]] <- NULL
race_dummies[["races_22^Guamanian or Charmorro"]] <- NULL
race_dummies[["races_12^Filipino"]] <- NULL

#combine a few...

race_dummies[which(race_dummies["races_11^Chinese"] == 1
             | race_dummies["races_14^Korean"] == 1
             | race_dummies["races_15^Vietnamese"] == 1
             | race_dummies["races_13^Japanese"] == 1)
             ,"races_4^Asian"] <- 1
race_dummies[["races_11^Chinese"]] <- NULL
race_dummies[["races_14^Korean"]] <- NULL
race_dummies[["races_13^Japanese"]] <- NULL
race_dummies[["races_15^Vietnamese"]] <- NULL

race_dummies$races <- NULL
```

```{r}
dim(stayday.limited) #279140    142
stayday.limited$religion <- stayday.limited$race_list <- stayday.limited$spoken_language <- NULL
stayday.limited <- data.frame(stayday.limited,har_hospital_service.dummies,race_dummies)
                              #,drg_name.dummies)
dim(stayday.limited) # 279140    202
```

```{r}
library(purrr)
stayday.limited %>% map(levels) %>% map(length)
```

```{r}
atnd.df <- atnd.tbl <- atnd.tbl.sorted <- atnd.tbl.sorted.uniquevis <- NULL
disch_ord <- dischord <- dischord.tbl <- dischord.tbl.sorted <- dischord.tbl.sorted.naive_unique <- NULL
last_from_remaining <- latest_w_correct_reason <- remaining_dischord <- unique_cancel <- NULL
enc_ord <- enc.tbl <- missing_inp_admit <- NULL
har_hospital_service.dummies <- race_dummies <- race_list <- NULL
pat_aggs <- pat.raw <- pat_hist <- pat_visits <- NULL
stayday.factors <- stayday <- NULL
# keeping: enc, enc.full, enc_ord.hosp, enc_join_data, facts_enc, pat, pat_visits.sorted, pat.full

```


```{r eval=FALSE}
#forest <- rf_cv_caret$finalModel
save(stayday.limited, file = "PHI_data/stayday.limited.rda")
#load("R_data/ny.kaggle.clean.rda")
#ny.kaggle <- ny.kaggle.clean
#ny.kaggle.clean <- NULL
```

#ADT Events Data

##Initial cleaning of data

```{r factor_adt_events, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
adt_events$visit_id <- as.character(adt_events$visit_id)
adt_events$adt_id <- as.character(adt_events$adt_id)
adt_events$event_type <- as.factor(adt_events$event_type)
adt_events$patient_class <- as.factor(adt_events$patient_class)
adt_events$from_base_class <- as.factor(adt_events$from_base_class)
adt_events$to_base_class <- as.factor(adt_events$to_base_class)
adt_events$level_of_care <- as.factor(adt_events$level_of_care)
adt_events$accommodation <- as.factor(adt_events$accommodation)
adt_events$adt_user_id <- as.factor(adt_events$adt_user_id)
adt_events$adt_dept_id <- as.factor(adt_events$adt_dept_id)
adt_events$adt_dttm <- as.POSIXct(strftime(adt_events$adt_dttm, tz="America/Detroit"))
summary(adt_events)

dept$department_id <- as.character(dept$department_id)
dept$dept_specialty <- as.factor(dept$dept_specialty)
dept$rev_loc_id <- as.factor(dept$rev_loc_id)
dept$adt_parent_id <- as.factor(dept$adt_parent_id)
dept$adt_unit_type <- as.factor(dept$adt_unit_type)
dept$or_unit_type <- as.factor(dept$or_unit_type)
dept$is_periop_dep_yn <- as.factor(dept$is_periop_dep_yn)
dept$inpatient_dept_yn <- as.factor(dept$inpatient_dept_yn)
dept$dept_ed_type <- as.factor(dept$dept_ed_type)
dept$icu_dept_yn <- as.factor(dept$icu_dept_yn)
```
```{r adt_timestamp_prep, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
## to make a time, impose month and day based on first obs
event_time <- as.POSIXlt(adt_events$adt_dttm)    # convert to 'POSIX list type'
event_time$mday <- event_time[1]$mday  # and $mon if it differs too
event_time$mon <- event_time[1]$mon  # and $mon if it differs too
event_time$year <- event_time[1]$year  # and $mon if it differs too
event_time <- as.POSIXct(event_time, tz="America/Detroit")   # convert back
adt_events$event_time <- event_time

discharge_decision_tm <- as.POSIXlt(event_time[1])
discharge_decision_tm$hour <- 0
discharge_decision_tm$min <- 0
discharge_decision_tm$sec <- 0

#7 AM was selected for TGH because the first discharge orders start to be written at this time
discharge_decision_tm <- discharge_decision_tm + (60*60*7)

adt_events$event_date <- as.Date(adt_events$adt_dttm, tz="America/Detroit")
#shift event date forward, make it the last 24hrs before discharge decisions
adt_events[which(adt_events$event_time >= discharge_decision_tm),]$event_date <- 
  adt_events[which(adt_events$event_time >= discharge_decision_tm),]$event_date + 1
head(adt_events[,c("adt_dttm","event_time","event_date")],50)
```
```{r join_adt_dept, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
require(dplyr)
cols.names <- 
  c("department_id","external_name","dept_specialty","adt_unit_type","is_periop_dep_yn","icu_dept_yn")
cols <- which(colnames(dept) %in% cols.names)
adt_events <- adt_events %>%
  left_join(dept[,cols], by=c('adt_dept_id'='department_id'), suffix=c(".x",".y")); head(adt_events, 50)
```
```{r join_visit_info_to_adt, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
require(dplyr)

# #temporary until these fields are pulled into stayday
# dim(stayday)
# cols.names <- c("e_visit_id","inp_admit_dept_specialty","inp_admit_dept")
# cols <- which(colnames(enc_join_data) %in% cols.names)
# stayday <- stayday %>%
#   left_join(enc_join_data[,cols],
#             by=c('visit_id'='e_visit_id'), suffix=c(".x",".y"))
# dim(stayday)

dim(adt_events)
cols.names <- c("visit_id","day_date","inp_admit_accommodation","inp_admit_dept","LengthOfStay",
                "inp_admit_level_of_care","inp_admit_dept_specialty","y.disch","y.days_until_disch")
cols <- which(colnames(stayday) %in% cols.names)
adt_events <- adt_events %>%
  left_join(stayday[,cols], 
            by=c('visit_id'='visit_id',"event_date"="day_date"), suffix=c(".x",".y"))
dim(adt_events)

#limit to visits in main attending data (hospitalist users)
adt_events <- adt_events[which(!is.na(adt_events$LengthOfStay) & adt_events$LengthOfStay > 0.1),]
adt_events$dept_specialty <- droplevels(adt_events$dept_specialty)
adt_events$adt_user_id <- droplevels(adt_events$adt_user_id)
adt_events$accommodation <- droplevels(adt_events$accommodation)
adt_events$level_of_care <- droplevels(adt_events$level_of_care)
adt_events$to_base_class <- droplevels(adt_events$to_base_class)
adt_events$from_base_class <- droplevels(adt_events$from_base_class)
adt_events$patient_class <- droplevels(adt_events$patient_class)
adt_events$inp_admit_accommodation <- droplevels(adt_events$inp_admit_accommodation)
adt_events$inp_admit_level_of_care <- droplevels(adt_events$inp_admit_level_of_care)
adt_events$inp_admit_dept_specialty <- droplevels(adt_events$inp_admit_dept_specialty)
adt_events$adt_unit_type <- droplevels(adt_events$adt_unit_type)
adt_events$y.days_until_disch <- as.numeric(adt_events$y.days_until_disch)

head(adt_events, 50)
```
```{r split_adt_accomm, echo=FALSE, cache=FALSE, results='hide', warning=FALSE, message=FALSE}
require(dplyr)
require(tidyr)
foo <- adt_events %>%
  separate(accommodation,c("accomm_code","accomm_title","accomm_reason"),
           sep="\\^",fill="right",remove=FALSE)
adt_events$accomm_clean <- as.factor(paste(foo$accomm_code,"^",foo$accomm_title,sep=""))
adt_events$accomm_reason <- as.factor(foo$accomm_reason)
```

###Visualize variation in y.days_until_disch by a few factors

```{r summarize_icu_periop, fig.asp=.4, fig.width=15, warning=FALSE,message=FALSE,error=FALSE }
adt_events %>%
  group_by(icu_dept_yn) %>%
  summarize(median.days_until_disch = median(y.days_until_disch, na.rm = TRUE), mean.days_until_disch = mean(y.days_until_disch, na.rm = TRUE))
adt_events %>%
  group_by(is_periop_dep_yn) %>%
  summarize(median.days_until_disch = median(y.days_until_disch, na.rm = TRUE), mean.days_until_disch = mean(y.days_until_disch, na.rm = TRUE))
```

```{r viz_adt_accomm_1, results='hide', warning=FALSE, message=FALSE, error=FALSE}
ggplot(adt_events, aes(accomm_clean, y.days_until_disch)) + 
  geom_boxplot(varwidth = TRUE, color="mediumslateblue") + 
  coord_flip() + 
  labs(caption="Fig 6.a", title="y.days_until_disch by accommodation")
```
```{r viz_adt_accomm_2, results='hide', warning=FALSE, message=FALSE, error=FALSE}
theme_set(theme_gray())
n <- ggplot(data=subset(adt_events, LengthOfStay < 300), aes(dept_specialty)) + 
    geom_density(aes(fill=factor(dept_specialty), y=..count..), alpha=0.3) + 
    scale_fill_viridis(discrete=TRUE, option="viridis", 
                       guide = guide_legend(direction="horizontal")) +
    theme(legend.position="none", 
        legend.background = element_blank(),
        axis.text.x = element_blank(),
        legend.box = "horizontal") +
    labs(title="y.days_until_disch by dept_specialty", 
         subtitle="Distribution of y.days_until_disch for each dept_specialty",
         caption="Fig 7.a",
         x="y.days_until_disch",
         fill="dept_specialty")
n
```
```{r viz_adt_dep_speclty, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(EnvStats)
require(gridExtra)
require(viridis)
require(ggplot2)
require(ggridges)
theme_set(theme_gray())
n <- ggplot(data=subset(adt_events, LengthOfStay < 100), 
            aes(x=y.days_until_disch,y=dept_specialty, fill=dept_specialty)) + 
    geom_density_ridges_gradient(rel_min_height = 0.0001, alpha=0.2) + 
    scale_fill_viridis(discrete=TRUE, option="viridis", 
                      direction=1,
                      guide = guide_legend(direction="horizontal"
                                           ,title.position = "top"
                                           ,title.hjust = .5)) +
    theme(legend.position="none", 
        legend.background = element_blank(),
        #axis.text.x = element_blank(),
        legend.box = "horizontal") +
    labs(title="y.days_until_disch by dept_specialty", 
         subtitle="Distribution of y.days_until_disch for each dept_specialty",
         #caption="Fig 7.a",
         x="y.days_until_disch",
         y="dept_specialty",
         fill="dept_specialty")
```
```{r viz_show_adt_dep_speclty, fig.asp=.8, fig.width=10, warning=FALSE,message=FALSE,error=FALSE }
grid.arrange(n, ncol=1)
```

```{r viz_adt_LOC_for_ADT, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(EnvStats)
require(gridExtra)
require(viridis)
require(ggplot2)
require(ggridges)
theme_set(theme_gray())
n <- ggplot(data=subset(adt_events, (LengthOfStay < 100)), aes(x=y.days_until_disch,y=level_of_care, fill=level_of_care)) + 
    geom_density_ridges_gradient(rel_min_height = 0.01, alpha=0.2) + 
    scale_fill_viridis(discrete=TRUE, option="viridis", 
                      direction=1,
                      guide = guide_legend(direction="horizontal"
                                           ,title.position = "top"
                                           ,title.hjust = .5)) +
    theme(legend.position="none", 
        legend.background = element_blank(),
        #axis.text.x = element_blank(),
        legend.box = "horizontal") +
    labs(title="y.days_until_disch by level_of_care", 
         subtitle="Distribution of y.days_until_disch for each level_of_care",
         #caption="Fig 7.a",
         x="y.days_until_disch",
         y="level_of_care",
         fill="level_of_care")
```

```{r viz_show_adt_LOC_for_ADT, fig.asp=.8, fig.width=10, warning=FALSE,message=FALSE,error=FALSE }
grid.arrange(n, ncol=1)
```
```{r viz_accomm_reason, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(EnvStats)
require(gridExtra)
require(viridis)
require(ggplot2)
require(ggridges)
theme_set(theme_gray())
n <- ggplot(data=subset(adt_events, (LengthOfStay < 60) & (accomm_clean == "10019^Intcare/Prog Care/SD")), aes(x=y.days_until_disch,y=accomm_reason, fill=accomm_reason)) + 
    geom_density_ridges_gradient(rel_min_height = 0.01, alpha=0.2) + 
    scale_fill_viridis(discrete=TRUE, option="viridis", 
                      direction=1,
                      guide = guide_legend(direction="horizontal"
                                           ,title.position = "top"
                                           ,title.hjust = .5)) +
    theme(legend.position="none", 
        legend.background = element_blank(),
        #axis.text.x = element_blank(),
        legend.box = "horizontal") +
    labs(title="y.days_until_disch by accommodation", 
         subtitle="Distribution of y.days_until_disch for each accommodation reason when accomm==Progressive Care/Step Down",
         #caption="Fig 7.a",
         x="y.days_until_disch",
         y="accommodation",
         fill="accommodation")
```

```{r viz_show_accomm_reason_for_ADT, fig.asp=.4, fig.width=15, warning=FALSE,message=FALSE,error=FALSE }
grid.arrange(n, ncol=1)
```

```{r viz_pat_class_for_ADT, results='hide', warning=FALSE, message=FALSE, error=FALSE}
require(EnvStats)
require(gridExtra)
require(viridis)
require(ggplot2)
require(ggridges)
theme_set(theme_gray())

#is_periop_dep_yn
#icu_dept_yn
n <- ggplot(data=subset(adt_events, (LengthOfStay < 60)), aes(x=y.days_until_disch,y=icu_dept_yn, fill=icu_dept_yn)) + 
    geom_density_ridges_gradient(rel_min_height = 0.01, alpha=0.2) + 
    scale_fill_viridis(discrete=TRUE, option="viridis", 
                      direction=1,
                      guide = guide_legend(direction="horizontal"
                                           ,title.position = "top"
                                           ,title.hjust = .5)) +
    theme(legend.position="none", 
        legend.background = element_blank(),
        #axis.text.x = element_blank(),
        legend.box = "horizontal") +
    labs(title="y.days_until_disch by patient_class", 
         subtitle="Distribution of y.days_until_disch for each patient_class",
         #caption="Fig 7.a",
         x="y.days_until_disch",
         y="patient_class",
         fill="patient_class")
```

```{r viz_show_pat_class_for_ADT, fig.asp=.4, fig.width=15, warning=FALSE,message=FALSE,error=FALSE }
grid.arrange(n, ncol=1)
```

```{r adt_prepare_dummies, warning=FALSE,message=FALSE,error=FALSE }
#we already have these at the visit level. If we didn't (for a client like Sentara), could grab right now and handle separately
length(which((adt_events$event_type != "1^Admission") & (adt_events$event_type != "2^Discharge")))

for (i in names(adt_events[,sapply(adt_events, is.factor) ])) {
  print(i)
  adt_events[[i]] <- factor(adt_events[[i]], labels = make.names(levels(adt_events[[i]])))
  print(levels(adt_events[[i]]))
}

#https://cran.r-project.org/web/packages/fastDummies/vignettes/making-dummy-variables.html
require(fastDummies)

adt.dummycols <- c("patient_class","level_of_care","accomm_clean","accomm_reason","dept_specialty","adt_unit_type")
admit.dummycols <- c("inp_admit_level_of_care","inp_admit_dept_specialty","inp_admit_accommodation")
adt_events.dummies <- dummy_cols(adt_events, select_columns=adt.dummycols)
admit.dummies <- dummy_cols(adt_events, select_columns=admit.dummycols)

removecols <- c("adt_id","from_base_class","to_base_class","adt_user_id","accommodation","is_periop_dep_yn","icu_dept_yn")
removecols <- c(removecols,adt.dummycols,admit.dummycols)
cols <- which(colnames(adt_events.dummies) %in% removecols)
adt_events.dummies <- adt_events.dummies[,-cols]
cols <- which(colnames(admit.dummies) %in% removecols)
admit.dummies <- admit.dummies[,-cols]

adt_events.dummies$is_periop_dep_yn <- ifelse(adt_events$is_periop_dep_yn == "true", 1, 0)
adt_events.dummies$icu_dept_yn <- ifelse(adt_events$icu_dept_yn == "true", 1, 0)

summary(adt_events.dummies)
head(adt_events.dummies)
dim(adt_events.dummies)
dim(admit.dummies)
```

```{r adt_split_dummies, warning=FALSE,message=FALSE,error=FALSE }
xfer_in_event.dummies <- adt_events.dummies[which(adt_events.dummies$event_type == "X3.Transfer.In"),]; dim(xfer_in_event.dummies)
xfer_out_event.dummies <- adt_events.dummies[which(adt_events.dummies$event_type == "X4.Transfer.Out"),]; dim(xfer_out_event.dummies)
census_event.dummies <- adt_events.dummies[which(adt_events.dummies$event_type == "X6.Census"),]; dim(census_event.dummies)
update_event.dummies <- adt_events.dummies[which(adt_events.dummies$event_type == "X5.Patient.Update"),]; dim(update_event.dummies)
```

```{r adt_group_dummies_by_day, warning=FALSE,message=FALSE,error=FALSE }
adt.xfer_in_events <- xfer_in_event.dummies %>%
  group_by(visit_id,event_date) %>%
  summarize(
    adt_in_event_count = n()
    , adt_in.periop_dep_yn = max(is_periop_dep_yn)
    , adt_in.icu_dept_yn = max(icu_dept_yn)
    , adt_in.patient_class_X = max(patient_class_X)
    , adt_in.patient_class_X101.Inpatient=max(patient_class_X101.Inpatient)
    , adt_in.patient_class_X102.Outpatient=max(patient_class_X102.Outpatient)
    , adt_in.patient_class_X103.Emergency=max(patient_class_X103.Emergency)
    , adt_in.patient_class_X104.Observation=max(patient_class_X104.Observation)
    , adt_in.patient_class_X106.Hospital.Outpatient.Surgery=max(patient_class_X106.Hospital.Outpatient.Surgery)
    , adt_in.patient_class_X107.Newborn=max(patient_class_X107.Newborn)
    , adt_in.patient_class_X108.Surgery.Admit=max(patient_class_X108.Surgery.Admit)
    , adt_in.patient_class_X111.Deceased...Organ.Donor=max(patient_class_X111.Deceased...Organ.Donor)
    , adt_in.patient_class_X116.Infusion.Series=max(patient_class_X116.Infusion.Series)
    , adt_in.patient_class_X122.Inpatient.Psych=max(patient_class_X122.Inpatient.Psych)
    , adt_in.patient_class_X123.Inpatient.Rehab=max(patient_class_X123.Inpatient.Rehab)
    , adt_in.patient_class_X124.Outpatient.in.a.Bed=max(patient_class_X124.Outpatient.in.a.Bed)
    , adt_in.level_of_care_X=max(level_of_care_X)
    , adt_in.level_of_care_X1.Acute=max(level_of_care_X1.Acute)
    , adt_in.level_of_care_X10.Nursery.Continuous.Care=max(level_of_care_X10.Nursery.Continuous.Care)
    , adt_in.level_of_care_X14.Critical.Care=max(level_of_care_X14.Critical.Care)
    , adt_in.level_of_care_X15.Stepdown=max(level_of_care_X15.Stepdown)
    , adt_in.level_of_care_X16.Cardiac.Telemetry=max(level_of_care_X16.Cardiac.Telemetry)
    , adt_in.level_of_care_X17.Medical.Telemetry=max(level_of_care_X17.Medical.Telemetry)
    , adt_in.level_of_care_X18.Med.Surg=max(level_of_care_X18.Med.Surg)
    , adt_in.level_of_care_X19.Procedural=max(level_of_care_X19.Procedural)
    , adt_in.level_of_care_X2.Sub.Acute=max(level_of_care_X2.Sub.Acute)
    , adt_in.level_of_care_X21.Psych=max(level_of_care_X21.Psych)
    , adt_in.level_of_care_X22.Obstetrics=max(level_of_care_X22.Obstetrics)
    , adt_in.level_of_care_X3.ICF=max(level_of_care_X3.ICF)
    , adt_in.level_of_care_X5.Telemetry=max(level_of_care_X5.Telemetry)
    , adt_in.level_of_care_X6.ICU=max(level_of_care_X6.ICU)
    , adt_in.level_of_care_X7.Hospice=max(level_of_care_X7.Hospice)
    , adt_in.level_of_care_X8.Newborn=max(level_of_care_X8.Newborn)
    , adt_in.level_of_care_X9.Nursery.Special.Care=max(level_of_care_X9.Nursery.Special.Care)
    , adt_in.accomm_clean_X.NA=max(accomm_clean_X.NA)
    , adt_in.accomm_clean_X1.Private=max(accomm_clean_X1.Private)
    , adt_in.accomm_clean_X10003.Intensive.Care.Unit=max(accomm_clean_X10003.Intensive.Care.Unit)
    , adt_in.accomm_clean_X10010.Patient.Not.on.Unit=max(accomm_clean_X10010.Patient.Not.on.Unit)
    , adt_in.accomm_clean_X10011.Meets.Discharge.Criteria=max(accomm_clean_X10011.Meets.Discharge.Criteria)
    , adt_in.accomm_clean_X10012.Observation=max(accomm_clean_X10012.Observation)
    , adt_in.accomm_clean_X10013.Baby.Nursery.LV.1=max(accomm_clean_X10013.Baby.Nursery.LV.1)
    , adt_in.accomm_clean_X10014.Nursery.NICU.LV.2=max(accomm_clean_X10014.Nursery.NICU.LV.2)
    , adt_in.accomm_clean_X10015.Neonatal.ICU.LV.3=max(accomm_clean_X10015.Neonatal.ICU.LV.3)
    , adt_in.accomm_clean_X10016.Burn.Unit=max(accomm_clean_X10016.Burn.Unit)
    , adt_in.accomm_clean_X10017.Cardiac.Surg.Unit=max(accomm_clean_X10017.Cardiac.Surg.Unit)
    , adt_in.accomm_clean_X10018.Coronary.Care=max(accomm_clean_X10018.Coronary.Care)
    , adt_in.accomm_clean_X10019.Intcare.Prog.Care.SD=max(accomm_clean_X10019.Intcare.Prog.Care.SD)
    , adt_in.accomm_clean_X10020.Pedi.ICU=max(accomm_clean_X10020.Pedi.ICU)
    , adt_in.accomm_clean_X10021.Pediatric.Rehab=max(accomm_clean_X10021.Pediatric.Rehab)
    , adt_in.accomm_clean_X10022.Psych.Semi.Priv=max(accomm_clean_X10022.Psych.Semi.Priv)
    , adt_in.accomm_clean_X10023.PVT..Med.Justified=max(accomm_clean_X10023.PVT..Med.Justified)
    , adt_in.accomm_clean_X10024.Semi.Priv.Rehab=max(accomm_clean_X10024.Semi.Priv.Rehab)
    , adt_in.accomm_clean_X10025.Trauma=max(accomm_clean_X10025.Trauma)
    , adt_in.accomm_clean_X10026.Newborn.Nonviable.Bed=max(accomm_clean_X10026.Newborn.Nonviable.Bed)
    , adt_in.accomm_clean_X10027.ED.DEFAULT=max(accomm_clean_X10027.ED.DEFAULT)
    , adt_in.accomm_clean_X10028.Outpatient.in.Bed=max(accomm_clean_X10028.Outpatient.in.Bed)
    , adt_in.accomm_clean_X2.Semi.Private=max(accomm_clean_X2.Semi.Private)
    , adt_in.accomm_reason_REASON.Hospital.Convenience.2.=max(accomm_reason_REASON.Hospital.Convenience.2.)
    , adt_in.accomm_reason_REASON.Medical.Necessity.1001.=max(accomm_reason_REASON.Medical.Necessity.1001.)
    , adt_in.accomm_reason_REASON.Patient.Preference.1.=max(accomm_reason_REASON.Patient.Preference.1.)
    , adt_in.accomm_reason_NA=max(accomm_reason_NA)
    , adt_in.dept_specialty_X=max(dept_specialty_X)
    , adt_in.dept_specialty_X11.General.Surgery=max(dept_specialty_X11.General.Surgery)
    , adt_in.dept_specialty_X128.Pulmonary.Disease=max(dept_specialty_X128.Pulmonary.Disease)
    , adt_in.dept_specialty_X136.Transplant=max(dept_specialty_X136.Transplant)
    , adt_in.dept_specialty_X22.Obstetrics...Gynecology=max(dept_specialty_X22.Obstetrics...Gynecology)
    , adt_in.dept_specialty_X304124.Inpatient=max(dept_specialty_X304124.Inpatient)
    , adt_in.dept_specialty_X4.Cardiology=max(dept_specialty_X4.Cardiology)
    , adt_in.dept_specialty_X40.Radiology=max(dept_specialty_X40.Radiology)
    , adt_in.dept_specialty_X45.Emergency.Medicine=max(dept_specialty_X45.Emergency.Medicine)
    , adt_in.adt_unit_type_X=max(adt_unit_type_X)
    , adt_in.adt_unit_type_X1.Emergency.Dept=max(adt_unit_type_X1.Emergency.Dept)
    , adt_in.adt_unit_type_X2.Hospital.Outpatient=max(adt_unit_type_X2.Hospital.Outpatient)
    , adt_in.adt_unit_type_X3.Labor...Delivery=max(adt_unit_type_X3.Labor...Delivery)
)
adt.xfer_out_events <- xfer_out_event.dummies %>%
  group_by(visit_id,event_date) %>%
  summarize(
    #adt_out_event_count = n(), #removing because always the same as adt_xfer in count
    adt_out.periop_dep_yn = max(is_periop_dep_yn)
    , adt_out.icu_dept_yn = max(icu_dept_yn)
    , adt_out.patient_class_X = max(patient_class_X)
    , adt_out.patient_class_X101.Inpatient=max(patient_class_X101.Inpatient)
    , adt_out.patient_class_X102.Outpatient=max(patient_class_X102.Outpatient)
    , adt_out.patient_class_X103.Emergency=max(patient_class_X103.Emergency)
    , adt_out.patient_class_X104.Observation=max(patient_class_X104.Observation)
    , adt_out.patient_class_X106.Hospital.Outpatient.Surgery=max(patient_class_X106.Hospital.Outpatient.Surgery)
    , adt_out.patient_class_X107.Newborn=max(patient_class_X107.Newborn)
    , adt_out.patient_class_X108.Surgery.Admit=max(patient_class_X108.Surgery.Admit)
    , adt_out.patient_class_X111.Deceased...Organ.Donor=max(patient_class_X111.Deceased...Organ.Donor)
    , adt_out.patient_class_X116.Infusion.Series=max(patient_class_X116.Infusion.Series)
    , adt_out.patient_class_X122.Inpatient.Psych=max(patient_class_X122.Inpatient.Psych)
    , adt_out.patient_class_X123.Inpatient.Rehab=max(patient_class_X123.Inpatient.Rehab)
    , adt_out.patient_class_X124.Outpatient.in.a.Bed=max(patient_class_X124.Outpatient.in.a.Bed)
    , adt_out.level_of_care_X=max(level_of_care_X)
    , adt_out.level_of_care_X1.Acute=max(level_of_care_X1.Acute)
    , adt_out.level_of_care_X10.Nursery.Continuous.Care=max(level_of_care_X10.Nursery.Continuous.Care)
    , adt_out.level_of_care_X14.Critical.Care=max(level_of_care_X14.Critical.Care)
    , adt_out.level_of_care_X15.Stepdown=max(level_of_care_X15.Stepdown)
    , adt_out.level_of_care_X16.Cardiac.Telemetry=max(level_of_care_X16.Cardiac.Telemetry)
    , adt_out.level_of_care_X17.Medical.Telemetry=max(level_of_care_X17.Medical.Telemetry)
    , adt_out.level_of_care_X18.Med.Surg=max(level_of_care_X18.Med.Surg)
    , adt_out.level_of_care_X19.Procedural=max(level_of_care_X19.Procedural)
    , adt_out.level_of_care_X2.Sub.Acute=max(level_of_care_X2.Sub.Acute)
    , adt_out.level_of_care_X21.Psych=max(level_of_care_X21.Psych)
    , adt_out.level_of_care_X22.Obstetrics=max(level_of_care_X22.Obstetrics)
    , adt_out.level_of_care_X3.ICF=max(level_of_care_X3.ICF)
    , adt_out.level_of_care_X5.Telemetry=max(level_of_care_X5.Telemetry)
    , adt_out.level_of_care_X6.ICU=max(level_of_care_X6.ICU)
    , adt_out.level_of_care_X7.Hospice=max(level_of_care_X7.Hospice)
    , adt_out.level_of_care_X8.Newborn=max(level_of_care_X8.Newborn)
    , adt_out.level_of_care_X9.Nursery.Special.Care=max(level_of_care_X9.Nursery.Special.Care)
    , adt_out.accomm_clean_X.NA=max(accomm_clean_X.NA)
    , adt_out.accomm_clean_X1.Private=max(accomm_clean_X1.Private)
    , adt_out.accomm_clean_X10003.Intensive.Care.Unit=max(accomm_clean_X10003.Intensive.Care.Unit)
    , adt_out.accomm_clean_X10010.Patient.Not.on.Unit=max(accomm_clean_X10010.Patient.Not.on.Unit)
    , adt_out.accomm_clean_X10011.Meets.Discharge.Criteria=max(accomm_clean_X10011.Meets.Discharge.Criteria)
    , adt_out.accomm_clean_X10012.Observation=max(accomm_clean_X10012.Observation)
    , adt_out.accomm_clean_X10013.Baby.Nursery.LV.1=max(accomm_clean_X10013.Baby.Nursery.LV.1)
    , adt_out.accomm_clean_X10014.Nursery.NICU.LV.2=max(accomm_clean_X10014.Nursery.NICU.LV.2)
    , adt_out.accomm_clean_X10015.Neonatal.ICU.LV.3=max(accomm_clean_X10015.Neonatal.ICU.LV.3)
    , adt_out.accomm_clean_X10016.Burn.Unit=max(accomm_clean_X10016.Burn.Unit)
    , adt_out.accomm_clean_X10017.Cardiac.Surg.Unit=max(accomm_clean_X10017.Cardiac.Surg.Unit)
    , adt_out.accomm_clean_X10018.Coronary.Care=max(accomm_clean_X10018.Coronary.Care)
    , adt_out.accomm_clean_X10019.Intcare.Prog.Care.SD=max(accomm_clean_X10019.Intcare.Prog.Care.SD)
    , adt_out.accomm_clean_X10020.Pedi.ICU=max(accomm_clean_X10020.Pedi.ICU)
    , adt_out.accomm_clean_X10021.Pediatric.Rehab=max(accomm_clean_X10021.Pediatric.Rehab)
    , adt_out.accomm_clean_X10022.Psych.Semi.Priv=max(accomm_clean_X10022.Psych.Semi.Priv)
    , adt_out.accomm_clean_X10023.PVT..Med.Justified=max(accomm_clean_X10023.PVT..Med.Justified)
    , adt_out.accomm_clean_X10024.Semi.Priv.Rehab=max(accomm_clean_X10024.Semi.Priv.Rehab)
    , adt_out.accomm_clean_X10025.Trauma=max(accomm_clean_X10025.Trauma)
    , adt_out.accomm_clean_X10026.Newborn.Nonviable.Bed=max(accomm_clean_X10026.Newborn.Nonviable.Bed)
    , adt_out.accomm_clean_X10027.ED.DEFAULT=max(accomm_clean_X10027.ED.DEFAULT)
    , adt_out.accomm_clean_X10028.Outpatient.in.Bed=max(accomm_clean_X10028.Outpatient.in.Bed)
    , adt_out.accomm_clean_X2.Semi.Private=max(accomm_clean_X2.Semi.Private)
    , adt_out.accomm_reason_REASON.Hospital.Convenience.2.=max(accomm_reason_REASON.Hospital.Convenience.2.)
    , adt_out.accomm_reason_REASON.Medical.Necessity.1001.=max(accomm_reason_REASON.Medical.Necessity.1001.)
    , adt_out.accomm_reason_REASON.Patient.Preference.1.=max(accomm_reason_REASON.Patient.Preference.1.)
    , adt_out.accomm_reason_NA=max(accomm_reason_NA)
    , adt_out.dept_specialty_X=max(dept_specialty_X)
    , adt_out.dept_specialty_X11.General.Surgery=max(dept_specialty_X11.General.Surgery)
    , adt_out.dept_specialty_X128.Pulmonary.Disease=max(dept_specialty_X128.Pulmonary.Disease)
    , adt_out.dept_specialty_X136.Transplant=max(dept_specialty_X136.Transplant)
    , adt_out.dept_specialty_X22.Obstetrics...Gynecology=max(dept_specialty_X22.Obstetrics...Gynecology)
    , adt_out.dept_specialty_X304124.Inpatient=max(dept_specialty_X304124.Inpatient)
    , adt_out.dept_specialty_X4.Cardiology=max(dept_specialty_X4.Cardiology)
    , adt_out.dept_specialty_X40.Radiology=max(dept_specialty_X40.Radiology)
    , adt_out.dept_specialty_X45.Emergency.Medicine=max(dept_specialty_X45.Emergency.Medicine)
    , adt_out.adt_unit_type_X=max(adt_unit_type_X)
    , adt_out.adt_unit_type_X1.Emergency.Dept=max(adt_unit_type_X1.Emergency.Dept)
    , adt_out.adt_unit_type_X2.Hospital.Outpatient=max(adt_unit_type_X2.Hospital.Outpatient)
    , adt_out.adt_unit_type_X3.Labor...Delivery=max(adt_unit_type_X3.Labor...Delivery)
)
adt.census_events <- census_event.dummies %>%
  group_by(visit_id,event_date) %>%
  summarize(
    adt_cen_event_count = n()
    , adt_cen.periop_dep_yn = max(is_periop_dep_yn)
    , adt_cen.icu_dept_yn = max(icu_dept_yn)
    , adt_cen.patient_class_X = max(patient_class_X)
    , adt_cen.patient_class_X101.Inpatient=max(patient_class_X101.Inpatient)
    , adt_cen.patient_class_X102.Outpatient=max(patient_class_X102.Outpatient)
    , adt_cen.patient_class_X103.Emergency=max(patient_class_X103.Emergency)
    , adt_cen.patient_class_X104.Observation=max(patient_class_X104.Observation)
    , adt_cen.patient_class_X106.Hospital.Outpatient.Surgery=max(patient_class_X106.Hospital.Outpatient.Surgery)
    , adt_cen.patient_class_X107.Newborn=max(patient_class_X107.Newborn)
    , adt_cen.patient_class_X108.Surgery.Admit=max(patient_class_X108.Surgery.Admit)
    , adt_cen.patient_class_X111.Deceased...Organ.Donor=max(patient_class_X111.Deceased...Organ.Donor)
    , adt_cen.patient_class_X116.Infusion.Series=max(patient_class_X116.Infusion.Series)
    , adt_cen.patient_class_X122.Inpatient.Psych=max(patient_class_X122.Inpatient.Psych)
    , adt_cen.patient_class_X123.Inpatient.Rehab=max(patient_class_X123.Inpatient.Rehab)
    , adt_cen.patient_class_X124.Outpatient.in.a.Bed=max(patient_class_X124.Outpatient.in.a.Bed)
    , adt_cen.level_of_care_X=max(level_of_care_X)
    , adt_cen.level_of_care_X1.Acute=max(level_of_care_X1.Acute)
    , adt_cen.level_of_care_X10.Nursery.Continuous.Care=max(level_of_care_X10.Nursery.Continuous.Care)
    , adt_cen.level_of_care_X14.Critical.Care=max(level_of_care_X14.Critical.Care)
    , adt_cen.level_of_care_X15.Stepdown=max(level_of_care_X15.Stepdown)
    , adt_cen.level_of_care_X16.Cardiac.Telemetry=max(level_of_care_X16.Cardiac.Telemetry)
    , adt_cen.level_of_care_X17.Medical.Telemetry=max(level_of_care_X17.Medical.Telemetry)
    , adt_cen.level_of_care_X18.Med.Surg=max(level_of_care_X18.Med.Surg)
    , adt_cen.level_of_care_X19.Procedural=max(level_of_care_X19.Procedural)
    , adt_cen.level_of_care_X2.Sub.Acute=max(level_of_care_X2.Sub.Acute)
    , adt_cen.level_of_care_X21.Psych=max(level_of_care_X21.Psych)
    , adt_cen.level_of_care_X22.Obstetrics=max(level_of_care_X22.Obstetrics)
    , adt_cen.level_of_care_X3.ICF=max(level_of_care_X3.ICF)
    , adt_cen.level_of_care_X5.Telemetry=max(level_of_care_X5.Telemetry)
    , adt_cen.level_of_care_X6.ICU=max(level_of_care_X6.ICU)
    , adt_cen.level_of_care_X7.Hospice=max(level_of_care_X7.Hospice)
    , adt_cen.level_of_care_X8.Newborn=max(level_of_care_X8.Newborn)
    , adt_cen.level_of_care_X9.Nursery.Special.Care=max(level_of_care_X9.Nursery.Special.Care)
    , adt_cen.accomm_clean_X.NA=max(accomm_clean_X.NA)
    , adt_cen.accomm_clean_X1.Private=max(accomm_clean_X1.Private)
    , adt_cen.accomm_clean_X10003.Intensive.Care.Unit=max(accomm_clean_X10003.Intensive.Care.Unit)
    , adt_cen.accomm_clean_X10010.Patient.Not.on.Unit=max(accomm_clean_X10010.Patient.Not.on.Unit)
    , adt_cen.accomm_clean_X10011.Meets.Discharge.Criteria=max(accomm_clean_X10011.Meets.Discharge.Criteria)
    , adt_cen.accomm_clean_X10012.Observation=max(accomm_clean_X10012.Observation)
    , adt_cen.accomm_clean_X10013.Baby.Nursery.LV.1=max(accomm_clean_X10013.Baby.Nursery.LV.1)
    , adt_cen.accomm_clean_X10014.Nursery.NICU.LV.2=max(accomm_clean_X10014.Nursery.NICU.LV.2)
    , adt_cen.accomm_clean_X10015.Neonatal.ICU.LV.3=max(accomm_clean_X10015.Neonatal.ICU.LV.3)
    , adt_cen.accomm_clean_X10016.Burn.Unit=max(accomm_clean_X10016.Burn.Unit)
    , adt_cen.accomm_clean_X10017.Cardiac.Surg.Unit=max(accomm_clean_X10017.Cardiac.Surg.Unit)
    , adt_cen.accomm_clean_X10018.Coronary.Care=max(accomm_clean_X10018.Coronary.Care)
    , adt_cen.accomm_clean_X10019.Intcare.Prog.Care.SD=max(accomm_clean_X10019.Intcare.Prog.Care.SD)
    , adt_cen.accomm_clean_X10020.Pedi.ICU=max(accomm_clean_X10020.Pedi.ICU)
    , adt_cen.accomm_clean_X10021.Pediatric.Rehab=max(accomm_clean_X10021.Pediatric.Rehab)
    , adt_cen.accomm_clean_X10022.Psych.Semi.Priv=max(accomm_clean_X10022.Psych.Semi.Priv)
    , adt_cen.accomm_clean_X10023.PVT..Med.Justified=max(accomm_clean_X10023.PVT..Med.Justified)
    , adt_cen.accomm_clean_X10024.Semi.Priv.Rehab=max(accomm_clean_X10024.Semi.Priv.Rehab)
    , adt_cen.accomm_clean_X10025.Trauma=max(accomm_clean_X10025.Trauma)
    , adt_cen.accomm_clean_X10026.Newborn.Nonviable.Bed=max(accomm_clean_X10026.Newborn.Nonviable.Bed)
    , adt_cen.accomm_clean_X10027.ED.DEFAULT=max(accomm_clean_X10027.ED.DEFAULT)
    , adt_cen.accomm_clean_X10028.Outpatient.in.Bed=max(accomm_clean_X10028.Outpatient.in.Bed)
    , adt_cen.accomm_clean_X2.Semi.Private=max(accomm_clean_X2.Semi.Private)
    , adt_cen.accomm_reason_REASON.Hospital.Convenience.2.=max(accomm_reason_REASON.Hospital.Convenience.2.)
    , adt_cen.accomm_reason_REASON.Medical.Necessity.1001.=max(accomm_reason_REASON.Medical.Necessity.1001.)
    , adt_cen.accomm_reason_REASON.Patient.Preference.1.=max(accomm_reason_REASON.Patient.Preference.1.)
    , adt_cen.accomm_reason_NA=max(accomm_reason_NA)
    , adt_cen.dept_specialty_X=max(dept_specialty_X)
    , adt_cen.dept_specialty_X11.General.Surgery=max(dept_specialty_X11.General.Surgery)
    , adt_cen.dept_specialty_X128.Pulmonary.Disease=max(dept_specialty_X128.Pulmonary.Disease)
    , adt_cen.dept_specialty_X136.Transplant=max(dept_specialty_X136.Transplant)
    , adt_cen.dept_specialty_X22.Obstetrics...Gynecology=max(dept_specialty_X22.Obstetrics...Gynecology)
    , adt_cen.dept_specialty_X304124.Inpatient=max(dept_specialty_X304124.Inpatient)
    , adt_cen.dept_specialty_X4.Cardiology=max(dept_specialty_X4.Cardiology)
    , adt_cen.dept_specialty_X40.Radiology=max(dept_specialty_X40.Radiology)
    , adt_cen.dept_specialty_X45.Emergency.Medicine=max(dept_specialty_X45.Emergency.Medicine)
    , adt_cen.adt_unit_type_X=max(adt_unit_type_X)
    , adt_cen.adt_unit_type_X1.Emergency.Dept=max(adt_unit_type_X1.Emergency.Dept)
    , adt_cen.adt_unit_type_X2.Hospital.Outpatient=max(adt_unit_type_X2.Hospital.Outpatient)
    , adt_cen.adt_unit_type_X3.Labor...Delivery=max(adt_unit_type_X3.Labor...Delivery)
)
adt.patupdate_events <- update_event.dummies %>%
  group_by(visit_id,event_date) %>%
  summarize(
    adt_upd_event_count = n()
    , adt_upd.periop_dep_yn = max(is_periop_dep_yn)
    , adt_upd.icu_dept_yn = max(icu_dept_yn)
    , adt_upd.patient_class_X = max(patient_class_X)
    , adt_upd.patient_class_X101.Inpatient=max(patient_class_X101.Inpatient)
    , adt_upd.patient_class_X102.Outpatient=max(patient_class_X102.Outpatient)
    , adt_upd.patient_class_X103.Emergency=max(patient_class_X103.Emergency)
    , adt_upd.patient_class_X104.Observation=max(patient_class_X104.Observation)
    , adt_upd.patient_class_X106.Hospital.Outpatient.Surgery=max(patient_class_X106.Hospital.Outpatient.Surgery)
    , adt_upd.patient_class_X107.Newborn=max(patient_class_X107.Newborn)
    , adt_upd.patient_class_X108.Surgery.Admit=max(patient_class_X108.Surgery.Admit)
    , adt_upd.patient_class_X111.Deceased...Organ.Donor=max(patient_class_X111.Deceased...Organ.Donor)
    , adt_upd.patient_class_X116.Infusion.Series=max(patient_class_X116.Infusion.Series)
    , adt_upd.patient_class_X122.Inpatient.Psych=max(patient_class_X122.Inpatient.Psych)
    , adt_upd.patient_class_X123.Inpatient.Rehab=max(patient_class_X123.Inpatient.Rehab)
    , adt_upd.patient_class_X124.Outpatient.in.a.Bed=max(patient_class_X124.Outpatient.in.a.Bed)
    , adt_upd.level_of_care_X=max(level_of_care_X)
    , adt_upd.level_of_care_X1.Acute=max(level_of_care_X1.Acute)
    , adt_upd.level_of_care_X10.Nursery.Continuous.Care=max(level_of_care_X10.Nursery.Continuous.Care)
    , adt_upd.level_of_care_X14.Critical.Care=max(level_of_care_X14.Critical.Care)
    , adt_upd.level_of_care_X15.Stepdown=max(level_of_care_X15.Stepdown)
    , adt_upd.level_of_care_X16.Cardiac.Telemetry=max(level_of_care_X16.Cardiac.Telemetry)
    , adt_upd.level_of_care_X17.Medical.Telemetry=max(level_of_care_X17.Medical.Telemetry)
    , adt_upd.level_of_care_X18.Med.Surg=max(level_of_care_X18.Med.Surg)
    , adt_upd.level_of_care_X19.Procedural=max(level_of_care_X19.Procedural)
    , adt_upd.level_of_care_X2.Sub.Acute=max(level_of_care_X2.Sub.Acute)
    , adt_upd.level_of_care_X21.Psych=max(level_of_care_X21.Psych)
    , adt_upd.level_of_care_X22.Obstetrics=max(level_of_care_X22.Obstetrics)
    , adt_upd.level_of_care_X3.ICF=max(level_of_care_X3.ICF)
    , adt_upd.level_of_care_X5.Telemetry=max(level_of_care_X5.Telemetry)
    , adt_upd.level_of_care_X6.ICU=max(level_of_care_X6.ICU)
    , adt_upd.level_of_care_X7.Hospice=max(level_of_care_X7.Hospice)
    , adt_upd.level_of_care_X8.Newborn=max(level_of_care_X8.Newborn)
    , adt_upd.level_of_care_X9.Nursery.Special.Care=max(level_of_care_X9.Nursery.Special.Care)
    , adt_upd.accomm_clean_X.NA=max(accomm_clean_X.NA)
    , adt_upd.accomm_clean_X1.Private=max(accomm_clean_X1.Private)
    , adt_upd.accomm_clean_X10003.Intensive.Care.Unit=max(accomm_clean_X10003.Intensive.Care.Unit)
    , adt_upd.accomm_clean_X10010.Patient.Not.on.Unit=max(accomm_clean_X10010.Patient.Not.on.Unit)
    , adt_upd.accomm_clean_X10011.Meets.Discharge.Criteria=max(accomm_clean_X10011.Meets.Discharge.Criteria)
    , adt_upd.accomm_clean_X10012.Observation=max(accomm_clean_X10012.Observation)
    , adt_upd.accomm_clean_X10013.Baby.Nursery.LV.1=max(accomm_clean_X10013.Baby.Nursery.LV.1)
    , adt_upd.accomm_clean_X10014.Nursery.NICU.LV.2=max(accomm_clean_X10014.Nursery.NICU.LV.2)
    , adt_upd.accomm_clean_X10015.Neonatal.ICU.LV.3=max(accomm_clean_X10015.Neonatal.ICU.LV.3)
    , adt_upd.accomm_clean_X10016.Burn.Unit=max(accomm_clean_X10016.Burn.Unit)
    , adt_upd.accomm_clean_X10017.Cardiac.Surg.Unit=max(accomm_clean_X10017.Cardiac.Surg.Unit)
    , adt_upd.accomm_clean_X10018.Coronary.Care=max(accomm_clean_X10018.Coronary.Care)
    , adt_upd.accomm_clean_X10019.Intcare.Prog.Care.SD=max(accomm_clean_X10019.Intcare.Prog.Care.SD)
    , adt_upd.accomm_clean_X10020.Pedi.ICU=max(accomm_clean_X10020.Pedi.ICU)
    , adt_upd.accomm_clean_X10021.Pediatric.Rehab=max(accomm_clean_X10021.Pediatric.Rehab)
    , adt_upd.accomm_clean_X10022.Psych.Semi.Priv=max(accomm_clean_X10022.Psych.Semi.Priv)
    , adt_upd.accomm_clean_X10023.PVT..Med.Justified=max(accomm_clean_X10023.PVT..Med.Justified)
    , adt_upd.accomm_clean_X10024.Semi.Priv.Rehab=max(accomm_clean_X10024.Semi.Priv.Rehab)
    , adt_upd.accomm_clean_X10025.Trauma=max(accomm_clean_X10025.Trauma)
    , adt_upd.accomm_clean_X10026.Newborn.Nonviable.Bed=max(accomm_clean_X10026.Newborn.Nonviable.Bed)
    , adt_upd.accomm_clean_X10027.ED.DEFAULT=max(accomm_clean_X10027.ED.DEFAULT)
    , adt_upd.accomm_clean_X10028.Outpatient.in.Bed=max(accomm_clean_X10028.Outpatient.in.Bed)
    , adt_upd.accomm_clean_X2.Semi.Private=max(accomm_clean_X2.Semi.Private)
    , adt_upd.accomm_reason_REASON.Hospital.Convenience.2.=max(accomm_reason_REASON.Hospital.Convenience.2.)
    , adt_upd.accomm_reason_REASON.Medical.Necessity.1001.=max(accomm_reason_REASON.Medical.Necessity.1001.)
    , adt_upd.accomm_reason_REASON.Patient.Preference.1.=max(accomm_reason_REASON.Patient.Preference.1.)
    , adt_upd.accomm_reason_NA=max(accomm_reason_NA)
    , adt_upd.dept_specialty_X=max(dept_specialty_X)
    , adt_upd.dept_specialty_X11.General.Surgery=max(dept_specialty_X11.General.Surgery)
    , adt_upd.dept_specialty_X128.Pulmonary.Disease=max(dept_specialty_X128.Pulmonary.Disease)
    , adt_upd.dept_specialty_X136.Transplant=max(dept_specialty_X136.Transplant)
    , adt_upd.dept_specialty_X22.Obstetrics...Gynecology=max(dept_specialty_X22.Obstetrics...Gynecology)
    , adt_upd.dept_specialty_X304124.Inpatient=max(dept_specialty_X304124.Inpatient)
    , adt_upd.dept_specialty_X4.Cardiology=max(dept_specialty_X4.Cardiology)
    , adt_upd.dept_specialty_X40.Radiology=max(dept_specialty_X40.Radiology)
    , adt_upd.dept_specialty_X45.Emergency.Medicine=max(dept_specialty_X45.Emergency.Medicine)
    , adt_upd.adt_unit_type_X=max(adt_unit_type_X)
    , adt_upd.adt_unit_type_X1.Emergency.Dept=max(adt_unit_type_X1.Emergency.Dept)
    , adt_upd.adt_unit_type_X2.Hospital.Outpatient=max(adt_unit_type_X2.Hospital.Outpatient)
    , adt_upd.adt_unit_type_X3.Labor...Delivery=max(adt_unit_type_X3.Labor...Delivery)
)
```

```{r adt_recombine_dummies, warning=FALSE,message=FALSE,error=FALSE}
col.names <- c("visit_id","day_date","LengthOfStay","y.disch","y.days_until_disch")
cols <- which(colnames(stayday) %in% col.names)
adt_events.clean <- stayday[,cols] %>%
  left_join(adt.xfer_in_events, 
            by=c('visit_id'='visit_id',"day_date"="event_date"))
adt_events.clean <- adt_events.clean %>%
  left_join(adt.xfer_out_events, 
            by=c('visit_id'='visit_id',"day_date"="event_date"))
adt_events.clean <- adt_events.clean %>%
  left_join(adt.census_events, 
            by=c('visit_id'='visit_id',"day_date"="event_date"))
adt_events.clean <- adt_events.clean %>%
  left_join(adt.patupdate_events, 
            by=c('visit_id'='visit_id',"day_date"="event_date"))

col.names <- c("event_time","external_name","adt_dept_id","adt_dttm","event_type","LengthOfStay","y.disch","y.days_until_disch")
cols <- which(colnames(admit.dummies) %in% col.names)
adt_events.clean <- adt_events.clean %>%
  left_join(admit.dummies[,-cols], 
            by=c('visit_id'='visit_id',"day_date"="event_date"))
dim(adt_events.clean)
```

##ADT data checkpoint

```{r adt_events_checkpoint, eval=FALSE, warning=FALSE,message=FALSE,error=FALSE}
adt_events.clean.tosave <- adt_events.clean
save(adt_events.clean.tosave, file = "~/MSDS/DS785capstone/PHI_data/TGH/adt_events.clean.tosave.rda")
#load("R_data/ny.kaggle.clean.rda")
#ny.kaggle <- ny.kaggle.clean
#ny.kaggle.clean <- NULL
```


```{r adt_clean_nulls, warning=FALSE,message=FALSE,error=FALSE}
adt_events.clean[is.na(adt_events.clean)] <- 0
#remove columns that have only 0 (or NA) values
adt_events.clean.dummies.temp <- adt_events.clean
for (i in names(adt_events.clean[,sapply(adt_events.clean, is.numeric) ])) {
  if (sum(adt_events.clean[[i]]) == 0) {
    print(paste("-----******* removing",i,", all zero values ******** -----"))
    adt_events.clean.dummies.temp[[i]] <- NULL
  }
}
#check if there are any factors
for (i in names(adt_events.clean.dummies.temp[,sapply(adt_events.clean.dummies.temp, is.factor) ])) {
    print(paste("-----******* found factor: ",i," ******** -----"))
}
dim(adt_events.clean)
dim(adt_events.clean.dummies.temp)

```

####assess variance of dummy cols, consider removing columns with low variance

```{r adt_assess_var, warning=FALSE,message=FALSE,error=FALSE}
col.names <- c("visit_id","LengthOfStay","day_date","y.days_until_disch","y.disch","inp_admit_dept","adt_upd_event_count","adt_cen_event_count","adt_in_event_count")
cols <- which(colnames(adt_events.clean.dummies.temp) %in% col.names)
variances <- data.frame(variance=sapply(adt_events.clean.dummies.temp[,-cols], var))
variances$varnames <- rownames(variances)
variances <- data.table(variances)
colsums <- data.frame(colsum=sapply(adt_events.clean.dummies.temp[,-cols], sum))
colsums$varnames <- rownames(colsums)
colsums <- data.table(colsums)
variances <- variances %>% left_join(colsums, by=c('varnames'='varnames'))
variances[order(variances)]
```

```{r adt_remove_low_var, warning=FALSE,message=FALSE,error=FALSE}
#number of times last one excluded was populated...
table(adt_events.clean.dummies.temp$adt_cen.accomm_clean_X10013.Baby.Nursery.LV.1)
#      0      1 
# 863290    127 

#look at number of unique visits for the smallest one removed
length(unique(adt_events.clean.dummies.temp$visit_id[which(
  adt_events.clean.dummies.temp$adt_cen.accomm_clean_X10013.Baby.Nursery.LV.1 > 0)]))
# 12

#remove these because of low variance:
col.names <- c(
  "adt_upd.level_of_care_X3.ICF"
  ,"inp_admit_dept_specialty_Cardiology"
  ,"adt_upd.accomm_clean_X10016.Burn.Unit"
  ,"adt_in.level_of_care_X2.Sub.Acute"
  ,"adt_cen.level_of_care_X10.Nursery.Continuous.Care"
  ,"inp_admit_level_of_care_X10.Nursery.Continuous.Care"
  ,"adt_cen.level_of_care_X7.Hospice"
  ,"adt_in.level_of_care_X7.Hospice"
  ,"adt_in.accomm_clean_X10021.Pediatric.Rehab"
  ,"adt_out.accomm_clean_X10021.Pediatric.Rehab"
  ,"adt_out.level_of_care_X3.ICF"
  ,"adt_cen.dept_specialty_X22.Obstetrics...Gynecology"
  ,"adt_cen.dept_specialty_X22.Obstetrics...Gynecology"
  ,"adt_in.accomm_clean_X10022.Psych.Semi.Priv"
  ,"adt_in.patient_class_X122.Inpatient.Psych"
  ,"adt_out.accomm_clean_X10011.Meets.Discharge.Criteria"
  ,"adt_in.patient_class_X111.Deceased...Organ.Donor"
  ,"adt_upd.level_of_care_X9.Nursery.Special.Care"
  ,"adt_in.level_of_care_X3.ICF"
  ,"adt_cen.patient_class_X111.Deceased...Organ.Donor"
  ,"adt_cen.accomm_clean_X10026.Newborn.Nonviable.Bed"
  ,"adt_in.accomm_clean_X10026.Newborn.Nonviable.Bed"
  ,"adt_out.accomm_clean_X10026.Newborn.Nonviable.Bed"
  ,"adt_in.dept_specialty_X22.Obstetrics...Gynecology"
  ,"adt_in.level_of_care_X21.Psych"
  ,"adt_out.accomm_clean_X10022.Psych.Semi.Priv"
  ,"adt_out.patient_class_X122.Inpatient.Psych"
  ,"adt_cen.level_of_care_X2.Sub.Acute"
  ,"adt_cen.level_of_care_X21.Psych"
  ,"adt_cen.accomm_clean_X10024.Semi.Priv.Rehab"
  ,"inp_admit_accommodation_X10024.Semi.Priv.Rehab"
  ,"adt_in.level_of_care_X9.Nursery.Special.Care"
  ,"adt_out.level_of_care_X9.Nursery.Special.Care"
  ,"adt_cen.level_of_care_X3.ICF"
  ,"adt_cen.accomm_clean_X10021.Pediatric.Rehab"
  ,"adt_out.dept_specialty_X22.Obstetrics...Gynecology"
  ,"adt_out.accomm_clean_X10014.Nursery.NICU.LV.2"
  ,"adt_upd.accomm_clean_X.NA"
  ,"adt_upd.accomm_clean_X10015.Neonatal.ICU.LV.3"
  ,"inp_admit_accommodation_X10021.Pediatric.Rehab"
  ,"adt_out.level_of_care_X8.Newborn"
  ,"adt_upd.level_of_care_X8.Newborn"
  ,"inp_admit_dept_specialty_Transplant"
  ,"adt_in.accomm_clean_X10010.Patient.Not.on.Unit"
  ,"adt_in.patient_class_X123.Inpatient.Rehab"
  ,"adt_out.patient_class_X123.Inpatient.Rehab"
  ,"adt_cen.accomm_clean_X10011.Meets.Discharge.Criteria"
  ,"adt_out.accomm_clean_X10010.Patient.Not.on.Unit"
  ,"adt_cen.patient_class_X123.Inpatient.Rehab"
  ,"adt_upd.patient_class_X106.Hospital.Outpatient.Surgery"
  ,"inp_admit_accommodation_X10013.Baby.Nursery.LV.1"
  ,"adt_in.level_of_care_X8.Newborn"
  ,"adt_in.accomm_clean_X.NA"
  ,"inp_admit_accommodation_X"
  ,"adt_in.accomm_clean_X10024.Semi.Priv.Rehab"
  ,"adt_out.accomm_clean_X10024.Semi.Priv.Rehab"
  ,"adt_out.accomm_clean_X.NA"
  ,"adt_upd.accomm_clean_X10020.Pedi.ICU"
  ,"adt_cen.accomm_clean_X.NA"
  ,"adt_upd.level_of_care_X19.Procedural"
  ,"adt_upd.accomm_clean_X10010.Patient.Not.on.Unit"
  ,"adt_in.patient_class_X107.Newborn"
  ,"adt_out.patient_class_X107.Newborn"
  ,"adt_in.accomm_clean_X10011.Meets.Discharge.Criteria"
  ,"inp_admit_accommodation_X10012.Observation"
  ,"adt_cen.accomm_clean_X10010.Patient.Not.on.Unit"
  ,"adt_out.accomm_clean_X10013.Baby.Nursery.LV.1"
  ,"adt_in.accomm_clean_X10014.Nursery.NICU.LV.2"
  ,"adt_upd.patient_class_X103.Emergency"
  ,"adt_upd.accomm_clean_X10014.Nursery.NICU.LV.2"
  ,"adt_cen.accomm_clean_X10013.Baby.Nursery.LV.1")

cols <- which(colnames(adt_events.clean.dummies.temp) %in% col.names)
adt_events.clean.dummies.temp <- adt_events.clean.dummies.temp[,-cols]
```

####review highly correlated dummy cols, consider removal

```{r adt_remove_high_corr, warning=FALSE,message=FALSE,error=FALSE}
#highly correlated
adt_events.clean.dummies.temp$adt_out_event_count <- NULL

#going to leave this alone, the times when they are xfer in to L&D but not Xfer out that day could be informative
table(adt_events.clean.dummies.temp$adt_in.adt_unit_type_X3.Labor...Delivery, 
      adt_events.clean.dummies.temp$adt_out.adt_unit_type_X3.Labor...Delivery)
  #when "day" cutoff was 11 AM...
  #        0      1
  # 0 771655    279
  # 1   1497  69668
  #when "day" cutoff was 7 AM...
  #        0      1
  # 0 786182    156
  # 1   1752  75327

#This is a perfection correlation, removing the adt_census one
table(adt_events.clean.dummies.temp$inp_admit_level_of_care_X9.Nursery.Special.Care, 
      adt_events.clean.dummies.temp$adt_cen.level_of_care_X9.Nursery.Special.Care)
  #when "day" cutoff was 11 AM...
  #       0      1
  # 0 842521      0
  # 1      0    578
  #when "day" cutoff was 7 AM...
  #       0      1
  # 0 862839      0
  # 1      1    577
adt_events.clean.dummies.temp$adt_cen.level_of_care_X9.Nursery.Special.Care <- NULL

#perfect correlation: adt_cen.adt_unit_type_X1.Emergency.Dept<->adt_cen.dept_specialty_X45.Emergency.Medicine (in/out/upd/cen respectively)
adt_events.clean.dummies.temp$adt_cen.adt_unit_type_X1.Emergency.Dept <- NULL
adt_events.clean.dummies.temp$adt_in.adt_unit_type_X1.Emergency.Dept <- NULL
adt_events.clean.dummies.temp$adt_out.adt_unit_type_X1.Emergency.Dept <- NULL
adt_events.clean.dummies.temp$adt_upd.adt_unit_type_X1.Emergency.Dept <- NULL
#strong but not perfect: adt_cen.accomm_clean_X10027.ED.DEFAULT with each of the above (in/out/upd/cen respectively)

table(adt_events.clean.dummies.temp$adt_cen.patient_class_X104.Observation,
     adt_events.clean.dummies.temp$adt_cen.accomm_clean_X10012.Observation)
  #when "day" cutoff was 11 AM...
  #        0      1
  # 0 779037     80
  # 1    950  63032
 #when "day" cutoff was 7 AM...
  #        0      1
  # 0 793791    104
  # 1   1077  68445
table(adt_events.clean.dummies.temp$adt_out.patient_class_X104.Observation,
     adt_events.clean.dummies.temp$adt_out.accomm_clean_X10012.Observation)
  #when "day" cutoff was 11 AM...
  #      0      1
  # 0 782659     79
  # 1   5926  54435
 #when "day" cutoff was 7 AM...
  #        0      1
  # 0 795849     87
  # 1   7376  60105
#it looks like there are a significant number of days when a patient has accomm OBS but not Pt Class OBS...I'm going to leave it and let PCA handle it.

table(adt_events.clean.dummies.temp$adt_in.patient_class_X106.Hospital.Outpatient.Surgery,
     adt_events.clean.dummies.temp$adt_out.patient_class_X106.Hospital.Outpatient.Surgery)
  #when "day" cutoff was 11 AM...
  #       0      1
  # 0 831526    594
  # 1     18  10961
  #when "day" cutoff was 7 AM...
  #       0      1
  # 0 851920     56
  # 1     23  11418
#going to leave the above alone as well, could mean something if xfer into outpatient surg but not out...
```

##ADT event PCA

Referenced [this post](https://aaronschlegel.me/principal-component-analysis-r-example.html) for examples, explanation, and package references...

```{r adt_calc_corr, warning=FALSE,message=FALSE,error=FALSE}
col.names <- c("visit_id","day_date","LengthOfStay","y.disch","y.days_until_disch","inp_admit_dept")
cols <- which(colnames(adt_events.clean.dummies.temp) %in% col.names)
S <- cov(adt_events.clean.dummies.temp[,-cols])
R <- cor(adt_events.clean.dummies.temp[,-cols])
sum(diag(S))
s.eigen <- eigen(S); s.eigen
```

```{r viz_adt_corr, fig.asp=1, fig.width=25, warning=FALSE,message=FALSE,error=FALSE }
#library(corrplot)
#corrplot(R)
#library(sjPlot)
#sjp.corr(adt_events.clean.dummies.temp[,-cols])

#https://www.r-graph-gallery.com/97-correlation-ellipses.html
library(ellipse)
#library(viridis)
library(RColorBrewer)

## Build a Pannel of 100 colors with Rcolor Brewer
my_colors <- brewer.pal(5, "Spectral")
colors <- colorRampPalette(my_colors)(52*52)

#colors <- c("#A50F15","#DE2D26","#FB6A4A","#FCAE91","#FEE5D9","white",
#            "#EFF3FF","#BDD7E7","#6BAED6","#3182BD","#08519C")
#colors <- viridis(100)
# Order the correlation matrix
ord <- order(R[1, ])
corr.data_ord <- R[ord, ord]
small.corr <- corr.data_ord[52:104,104:166]
plotcorr(small.corr, col=colors[small.corr*(52*52/2)+(52*52/2)] 
         #col=inferno(256)[small.corr*3+3]
         #, diag=FALSE
         #, type="upper"
         , cex=.1,mar=c(1,1,1,1))
```

```{r adt_calc_pca, warning=FALSE,message=FALSE,error=FALSE}
col.names <- c("visit_id","day_date","LengthOfStay","y.disch","y.days_until_disch","inp_admit_dept")
cols <- which(colnames(adt_events.clean.dummies.temp) %in% col.names)
adt.pca <- prcomp(adt_events.clean.dummies.temp[,-cols],na.action=na.omit, scale=TRUE)
summary(adt.pca)
```

```{r viz_adt_pca, warning=FALSE,message=FALSE,error=FALSE}
require(ggfortify)
col.names <- c("visit_id","day_date","LengthOfStay","y.days_until_disch","inp_admit_dept")
cols <- which(colnames(adt_events.clean.dummies.temp) %in% col.names)
adt.pca.plot <- autoplot(adt.pca, data = adt_events.clean.dummies.temp[,-cols], colour = 'y.disch',alpha = .05)
```

```{r show_viz_adt_pca, fig.asp=.4, fig.width=25, warning=FALSE,message=FALSE,error=FALSE}
adt.pca.plot
```

Assess correlation between principal components and predictors, to try to understand what the PCA might be representing...

```{r adt_corr_w_pca, warning=FALSE,message=FALSE,error=FALSE}
PCcount <- length(adt_events.clean.dummies.temp[,-cols])
len <- as.numeric(length(adt.pca.plot$data))
comps <- adt.pca.plot$data[,c(1:2,4:(len-1))]
cor.full <- cor(comps[,3:(len-(PCcount-1))], comps[,c(1:2,(len-(PCcount-2)):(length(comps)))])
x.var.names <- rownames(cor.full)
cor.full <- data.frame(x.var.names,cor.full)
require(data.table)
cor.full <- data.table(cor.full)
```

PC1 is strongly correlated with xfers into and out of emergency, along with patient updates to/while in emergency, correlated also with being xfered out of a periop department and having no level of care documented. Inversely correlated with departments not having a specialty, with accommodations based on medical necessity, and with L&D/surgery. Inverse correlation less strong that positive. 

old:
PC1 seems to be inversely correlated to something like "moved from ED to Inpatient or Observation", and positively correlated to ICU/telemetry. It seems to be more related to the midnight census or a pat_update ADT event than an xfer into ICU. Its also a little bit related to a direct ICU admit. The negative correlation is stronger, so maybe this is more defined like "ICU patients that didn't go through ED-> Inp or ED-> Obs"
```{r adt_pc1_interp, warning=FALSE,message=FALSE,error=FALSE}
head(cor.full[order(-PC1),c("x.var.names","PC1")],20)
head(cor.full[order(PC1),c("x.var.names","PC1")],20)
```
                                       x.var.names       PC1
 1:        adt_out.accomm_clean_X10027.ED.DEFAULT 0.9114083
 2: adt_out.dept_specialty_X45.Emergency.Medicine 0.9111611
 3:       adt_out.adt_unit_type_X1.Emergency.Dept 0.9111611
 4:         adt_in.accomm_clean_X10027.ED.DEFAULT 0.8860417
 5:  adt_in.dept_specialty_X45.Emergency.Medicine 0.8858718
 6:        adt_in.adt_unit_type_X1.Emergency.Dept 0.8858718
 7: adt_upd.dept_specialty_X45.Emergency.Medicine 0.8387158
 8:       adt_upd.adt_unit_type_X1.Emergency.Dept 0.8387158
 9:                         adt_upd.periop_dep_yn 0.8377395
10:        adt_upd.accomm_clean_X10027.ED.DEFAULT 0.8351618
11:           adt_in.patient_class_X103.Emergency 0.8346965
12:          adt_out.patient_class_X103.Emergency 0.8340454
13:                         adt_out.periop_dep_yn 0.7091567
14:                       adt_out.level_of_care_X 0.6952872
15:                       adt_upd.level_of_care_X 0.6906067
16:                          adt_in.periop_dep_yn 0.6587021
17:                      adt_upd.accomm_reason_NA 0.6574982
18:                        adt_in.level_of_care_X 0.6469989
19:                            adt_in_event_count 0.6279255
20:                           adt_out_event_count 0.6279255
                                             x.var.names        PC1
 1:                             adt_cen.dept_specialty_X -0.3030434
 2:                 adt_cen.patient_class_X101.Inpatient -0.2583165
 3: adt_cen.accomm_reason_REASON.Medical.Necessity.1001. -0.2373075
 4:                             adt_out.dept_specialty_X -0.2347658
 5:                           inp_admit_dept_specialty_X -0.2272712
 6: adt_out.accomm_reason_REASON.Medical.Necessity.1001. -0.1939339
 7:                              adt_out.adt_unit_type_X -0.1912327
 8:  adt_in.accomm_reason_REASON.Medical.Necessity.1001. -0.1895048
 9:     adt_cen.accomm_clean_X10019.Intcare.Prog.Care.SD -0.1777305
10:                   inp_admit_accommodation_X1.Private -0.1687781
11:                              adt_cen.adt_unit_type_X -0.1670984
12:            adt_cen.adt_unit_type_X3.Labor...Delivery -0.1670088
13:                      adt_cen.accomm_clean_X1.Private -0.1664282
14:                                  adt_out.icu_dept_yn -0.1554522
15:           adt_out.dept_specialty_X11.General.Surgery -0.1457607
16:            adt_out.adt_unit_type_X3.Labor...Delivery -0.1405125
17:                      adt_out.accomm_clean_X1.Private -0.1384913
18:             adt_in.adt_unit_type_X3.Labor...Delivery -0.1337694
19:      adt_out.accomm_clean_X10003.Intensive.Care.Unit -0.1307910
20:            adt_in.dept_specialty_X11.General.Surgery -0.1295871

NEW: PC2 is strongly inversely correlated with L&D, as well as private beds and not having a level of care documented. It is correlated with inp_admits directly to ED, having NULL ADT unit type and ICU/telemetry.
OLD: PC2 is positively correlated with transfer into or out of Labor and Delivery and a private room. It is negatively correlated with emergency, but less strongly than its positive correlation.
                                             x.var.names       PC2
 1:                              adt_cen.adt_unit_type_X 0.5043868
 2:          inp_admit_dept_specialty_Emergency.Medicine 0.4035994
 3:            inp_admit_accommodation_X10027.ED.DEFAULT 0.3833111
 4: adt_cen.accomm_reason_REASON.Medical.Necessity.1001. 0.2436564
 5:                               adt_in.adt_unit_type_X 0.2319959
 6:                                  adt_cen.icu_dept_yn 0.2145076
 7:     adt_cen.accomm_clean_X10019.Intcare.Prog.Care.SD 0.2000010
 8:      adt_cen.accomm_clean_X10003.Intensive.Care.Unit 0.1890128
 9:              adt_cen.level_of_care_X14.Critical.Care 0.1867156
10:                                adt_out.periop_dep_yn 0.1795357
11:          adt_cen.level_of_care_X17.Medical.Telemetry 0.1667835
12:                 adt_cen.accomm_clean_X2.Semi.Private 0.1657798
13:  adt_in.accomm_reason_REASON.Medical.Necessity.1001. 0.1613281
14:                              adt_out.adt_unit_type_X 0.1572333
15: adt_out.accomm_reason_REASON.Medical.Necessity.1001. 0.1544294
16:                                 adt_in.periop_dep_yn 0.1506059
17:                   adt_cen.level_of_care_X18.Med.Surg 0.1444510
18:                                  adt_out.icu_dept_yn 0.1441909
19:                                   adt_in.icu_dept_yn 0.1424830
20:               adt_in.level_of_care_X14.Critical.Care 0.1385766

                                         x.var.names        PC2
 1:        adt_out.adt_unit_type_X3.Labor...Delivery -0.8966176
 2:         adt_in.adt_unit_type_X3.Labor...Delivery -0.8937720
 3:        adt_upd.adt_unit_type_X3.Labor...Delivery -0.8667544
 4:                  adt_upd.accomm_clean_X1.Private -0.8154876
 5:                  adt_out.accomm_clean_X1.Private -0.7685575
 6:        adt_cen.adt_unit_type_X3.Labor...Delivery -0.7639867
 7:                   adt_in.accomm_clean_X1.Private -0.7057745
 8:    adt_upd.accomm_clean_X10028.Outpatient.in.Bed -0.5746136
 9:               inp_admit_accommodation_X1.Private -0.5566292
10:                         adt_upd.dept_specialty_X -0.5536431
11:                  adt_cen.accomm_clean_X1.Private -0.5366948
12:       adt_upd.dept_specialty_X11.General.Surgery -0.5063058
13:                          adt_cen.level_of_care_X -0.4678358
14: inp_admit_accommodation_X10028.Outpatient.in.Bed -0.4665787
15:                              adt_upd_event_count -0.4663742
16:                           adt_in.level_of_care_X -0.4231751
17:                       inp_admit_dept_specialty_X -0.4202037
18:                          adt_upd.level_of_care_X -0.4107184
19:                          adt_out.level_of_care_X -0.4036303
20:                         adt_upd.accomm_reason_NA -0.4018318
```{r adt_pc2_interp, warning=FALSE,message=FALSE,error=FALSE}
head(cor.full[order(-PC2),c("x.var.names","PC2")],20)
head(cor.full[order(PC2),c("x.var.names","PC2")],20)
```
NEW:
OLD:PC3 looks to be correlated to a transfer out of ICU or surgery, although there are some correlations with xfers into ICU/telemetry as well. Those could be ICU->ICU xfers? Its negative correlations are more strong, and it looks to represent visits that were not labor and delivery.

                                   x.var.names       PC3
 1:                    adt_out.adt_unit_type_X 0.8303605
 2:                     adt_in.adt_unit_type_X 0.7671585
 3:                    adt_in.dept_specialty_X 0.6556575
 4: adt_out.dept_specialty_X11.General.Surgery 0.6397103
 5:  adt_in.dept_specialty_X11.General.Surgery 0.6275695
 6:       adt_out.accomm_clean_X2.Semi.Private 0.6193833
 7:        adt_in.patient_class_X101.Inpatient 0.6152653
 8:        adt_in.accomm_clean_X2.Semi.Private 0.5735119
 9:                   adt_out.dept_specialty_X 0.5691847
10:          adt_in.level_of_care_X18.Med.Surg 0.4910062
11:                         adt_in_event_count 0.4655193
12:                        adt_out_event_count 0.4655193
13:                   adt_out.accomm_reason_NA 0.4541884
14:       adt_out.patient_class_X101.Inpatient 0.4511844
15:                    adt_in.accomm_reason_NA 0.4330342
16:         adt_out.level_of_care_X18.Med.Surg 0.4252853
17:                      adt_out.periop_dep_yn 0.4078357
18:   adt_out.patient_class_X108.Surgery.Admit 0.3916550
19:    adt_in.patient_class_X108.Surgery.Admit 0.3827335
20:                       adt_in.periop_dep_yn 0.3802841

                                      x.var.names         PC3
 1: adt_cen.dept_specialty_X45.Emergency.Medicine -0.27195985
 2:       adt_cen.adt_unit_type_X1.Emergency.Dept -0.27195985
 3:        adt_cen.accomm_clean_X10027.ED.DEFAULT -0.26699201
 4:                       adt_cen.level_of_care_X -0.24729574
 5:          adt_cen.patient_class_X103.Emergency -0.20334183
 6:     inp_admit_accommodation_X10027.ED.DEFAULT -0.18917516
 7:   inp_admit_dept_specialty_Emergency.Medicine -0.17722679
 8:                         adt_cen.periop_dep_yn -0.16647163
 9:           adt_in.patient_class_X103.Emergency -0.16547209
10:  adt_in.dept_specialty_X45.Emergency.Medicine -0.16464492
11:        adt_in.adt_unit_type_X1.Emergency.Dept -0.16464492
12:          adt_out.patient_class_X103.Emergency -0.16314423
13:         adt_in.accomm_clean_X10027.ED.DEFAULT -0.15991433
14:        adt_out.accomm_clean_X10027.ED.DEFAULT -0.13896257
15:     adt_cen.adt_unit_type_X3.Labor...Delivery -0.13872926
16: adt_out.dept_specialty_X45.Emergency.Medicine -0.13773820
17:       adt_out.adt_unit_type_X1.Emergency.Dept -0.13773820
18:                       adt_upd.level_of_care_X -0.12928406
19:     adt_upd.adt_unit_type_X3.Labor...Delivery -0.10708782
20:               adt_upd.accomm_clean_X1.Private -0.09443924

```{r adt_pc3_interp, warning=FALSE,message=FALSE,error=FALSE}
head(cor.full[order(-PC3),c("x.var.names","PC3")],20)
# x.var.names                                 PC3
# adt_out.adt_unit_type_X	6.742406e-01			
# adt_in.adt_unit_type_X	5.877026e-01			
# adt_cen.adt_unit_type_X	4.750476e-01			
# adt_in.accomm_clean_X2.Semi.Private	3.985812e-01			
# adt_out.accomm_clean_X2.Semi.Private	3.899183e-01			
# adt_out.icu_dept_yn	3.811677e-01			
# adt_in.accomm_reason_REASON.Medical.Necessity.1001.	3.772396e-01			
# adt_out.accomm_reason_REASON.Medical.Necessity.1001.	3.594724e-01			
# adt_out.accomm_clean_X10003.Intensive.Care.Unit	3.482954e-01			
# adt_out.level_of_care_X14.Critical.Care	3.279592e-01	
head(cor.full[order(PC3),c("x.var.names","PC3")],20)
#                                         x.var.names        PC3
#  1:        adt_upd.adt_unit_type_X3.Labor...Delivery -0.6497117
#  2:        adt_out.adt_unit_type_X3.Labor...Delivery -0.6417283
#  3:         adt_in.adt_unit_type_X3.Labor...Delivery -0.6400667
#  4:                  adt_upd.accomm_clean_X1.Private -0.6045929
#  5:        adt_cen.adt_unit_type_X3.Labor...Delivery -0.5359324
#  6:                  adt_out.accomm_clean_X1.Private -0.4875079
#  7:    adt_upd.accomm_clean_X10028.Outpatient.in.Bed -0.4412404
#  8:                          adt_cen.level_of_care_X -0.4269544
#  9:                   adt_in.accomm_clean_X1.Private -0.4130598
# 10:                          adt_upd.level_of_care_X -0.4057402
# 11:                              adt_upd_event_count -0.3780003
# 12:               inp_admit_accommodation_X1.Private -0.3659215
# 13:                  adt_cen.accomm_clean_X1.Private -0.3397703
# 14:                         adt_upd.accomm_reason_NA -0.3358408
# 15: inp_admit_accommodation_X10028.Outpatient.in.Bed -0.3235264
# 16:                         adt_upd.dept_specialty_X -0.3221888
# 17:       adt_upd.dept_specialty_X11.General.Surgery -0.3114771
# 18:             adt_upd.patient_class_X101.Inpatient -0.2907627
# 19:                           adt_in.level_of_care_X -0.2286448
# 20:    adt_out.accomm_clean_X10028.Outpatient.in.Bed -0.1973788
```
NEW: 
OLD: PC4 looks to be negatively correlated with patients that moved through observation in any way, as well as day-surgery. It is positively correlated with patients that were transferred into ICU or were in ICU at a census.

> head(cor.full[order(-PC4),c("x.var.names","PC4")],20)
                                        x.var.names       PC4
 1:       inp_admit_accommodation_X10027.ED.DEFAULT 0.5755261
 2:            adt_out.patient_class_X101.Inpatient 0.5672073
 3:                       inp_admit_level_of_care_X 0.5586287
 4:     inp_admit_dept_specialty_Emergency.Medicine 0.5289425
 5:             adt_in.patient_class_X101.Inpatient 0.5025478
 6:            adt_upd.patient_class_X101.Inpatient 0.3512584
 7:            adt_cen.patient_class_X101.Inpatient 0.3505848
 8:          adt_in.level_of_care_X14.Critical.Care 0.3431075
 9:  adt_in.accomm_clean_X10003.Intensive.Care.Unit 0.3257749
10:                              adt_in.icu_dept_yn 0.3221216
11:         adt_cen.level_of_care_X14.Critical.Care 0.2899251
12: adt_cen.accomm_clean_X10003.Intensive.Care.Unit 0.2623844
13:                             adt_cen.icu_dept_yn 0.2545849
14:                         adt_in.dept_specialty_X 0.2503200
15:         adt_out.level_of_care_X14.Critical.Care 0.2437271
16:                             adt_out.icu_dept_yn 0.2395953
17: adt_out.accomm_clean_X10003.Intensive.Care.Unit 0.2378500
18:                        adt_out.dept_specialty_X 0.2160602
19: adt_in.accomm_clean_X10019.Intcare.Prog.Care.SD 0.2101119
20:                  adt_in.accomm_clean_X1.Private 0.1946785
> head(cor.full[order(PC4),c("x.var.names","PC4")],20)
                                       x.var.names        PC4
 1:         adt_in.accomm_clean_X10012.Observation -0.6845076
 2:          adt_in.patient_class_X104.Observation -0.6821246
 3:         adt_out.patient_class_X104.Observation -0.6632410
 4:        adt_cen.accomm_clean_X10012.Observation -0.6612718
 5:        adt_out.accomm_clean_X10012.Observation -0.6602158
 6:         adt_cen.patient_class_X104.Observation -0.6595925
 7:        adt_upd.accomm_clean_X10012.Observation -0.6054979
 8:         adt_upd.patient_class_X104.Observation -0.5888161
 9:        inp_admit_accommodation_X2.Semi.Private -0.5750327
10:                     inp_admit_dept_specialty_X -0.4502911
11:           inp_admit_level_of_care_X18.Med.Surg -0.4251850
12:           adt_upd.accomm_clean_X2.Semi.Private -0.2571682
13:           inp_admit_level_of_care_X5.Telemetry -0.2204217
14:  inp_admit_level_of_care_X16.Cardiac.Telemetry -0.1954638
15:  inp_admit_level_of_care_X17.Medical.Telemetry -0.1841267
16:   adt_in.accomm_clean_X10028.Outpatient.in.Bed -0.1832455
17:             adt_cen.level_of_care_X18.Med.Surg -0.1579604
18: adt_out.patient_class_X124.Outpatient.in.a.Bed -0.1566890
19:  adt_in.patient_class_X124.Outpatient.in.a.Bed -0.1565328
20:             adt_upd.level_of_care_X18.Med.Surg -0.1543747

```{r adt_pc4_interp, warning=FALSE,message=FALSE,error=FALSE}
head(cor.full[order(-PC4),c("x.var.names","PC4")],20)
#                                              x.var.names       PC4
#  1:            inp_admit_accommodation_X10027.ED.DEFAULT 0.3425259
#  2:                 adt_out.patient_class_X101.Inpatient 0.3284180
#  3:               adt_in.level_of_care_X14.Critical.Care 0.3152652
#  4:       adt_in.accomm_clean_X10003.Intensive.Care.Unit 0.3024869
#  5:                 adt_upd.patient_class_X101.Inpatient 0.2963162
#  6:                                   adt_in.icu_dept_yn 0.2878797
#  7:                 adt_cen.patient_class_X101.Inpatient 0.2812559
#  8:              adt_cen.level_of_care_X14.Critical.Care 0.2687003
#  9:                                  adt_cen.icu_dept_yn 0.2682398
# 10:      adt_cen.accomm_clean_X10003.Intensive.Care.Unit 0.2577430
# 11:                                  adt_out.icu_dept_yn 0.2497534
# 12:      adt_out.accomm_clean_X10003.Intensive.Care.Unit 0.2480373
# 13:              adt_out.level_of_care_X14.Critical.Care 0.2416949
# 14:                  adt_in.patient_class_X101.Inpatient 0.2229245
# 15:      adt_in.accomm_clean_X10019.Intcare.Prog.Care.SD 0.1866701
# 16:  adt_in.accomm_reason_REASON.Medical.Necessity.1001. 0.1776793
# 17:                              adt_upd.level_of_care_X 0.1716110
# 18: adt_out.accomm_reason_REASON.Medical.Necessity.1001. 0.1627157
# 19:                             adt_upd.accomm_reason_NA 0.1619727
# 20:               adt_upd.accomm_clean_X10027.ED.DEFAULT 0.1602923
head(cor.full[order(PC4),c("x.var.names","PC4")],20)
#                                                x.var.names        PC4
#  1:                 adt_in.accomm_clean_X10012.Observation -0.5849366
#  2:                  adt_in.patient_class_X104.Observation -0.5827726
#  3:                adt_out.accomm_clean_X10012.Observation -0.5629555
#  4:                 adt_out.patient_class_X104.Observation -0.5604174
#  5:                adt_cen.accomm_clean_X10012.Observation -0.5236240
#  6:                 adt_cen.patient_class_X104.Observation -0.5230403
#  7:                adt_upd.accomm_clean_X10012.Observation -0.4802676
#  8:                 adt_upd.patient_class_X104.Observation -0.4582841
#  9:                inp_admit_accommodation_X2.Semi.Private -0.4326823
# 10:                adt_in.patient_class_X108.Surgery.Admit -0.3837259
# 11:               adt_out.patient_class_X108.Surgery.Admit -0.3827114
# 12:                   adt_out.accomm_clean_X2.Semi.Private -0.3680539
# 13:             adt_out.dept_specialty_X11.General.Surgery -0.3021156
# 14:           adt_in.accomm_clean_X10028.Outpatient.in.Bed -0.2908691
# 15:              adt_in.dept_specialty_X11.General.Surgery -0.2880295
# 16:                     adt_cen.level_of_care_X18.Med.Surg -0.2410919
# 17:                      adt_in.level_of_care_X18.Med.Surg -0.2354918
# 18:                    adt_in.accomm_clean_X2.Semi.Private -0.2350470
# 19:          adt_out.accomm_clean_X10028.Outpatient.in.Bed -0.2285228
# 20: adt_out.patient_class_X106.Hospital.Outpatient.Surgery -0.2100865
```

OLD:PC5 is positively correlated with surgery and outpatient suregery. Negatively correlated with patients that received a patient status update without an ADT unit type (NULL) and negatively correlated with patients that ever touched observation.

```{r adt_pc5_interp, warning=FALSE,message=FALSE,error=FALSE}
#head(cor.PC10[order(-PC5),c("x.var.names","PC5")],20)
#                                                x.var.names       PC5
#  1:                adt_in.patient_class_X108.Surgery.Admit 0.4127435
#  2:               adt_out.patient_class_X108.Surgery.Admit 0.4063476
#  3:             adt_out.dept_specialty_X11.General.Surgery 0.3475414
#  4:              adt_in.dept_specialty_X11.General.Surgery 0.3410388
#  5:                                   adt_in.periop_dep_yn 0.3069750
#  6:                                 adt_in.level_of_care_X 0.2966418
#  7:                                  adt_out.periop_dep_yn 0.2529366
#  8:                                adt_out.level_of_care_X 0.2410654
#  9:                   adt_out.accomm_clean_X2.Semi.Private 0.2306248
# 10:                    adt_in.accomm_clean_X2.Semi.Private 0.2294190
# 11:  adt_in.patient_class_X106.Hospital.Outpatient.Surgery 0.1688331
# 12: adt_out.patient_class_X106.Hospital.Outpatient.Surgery 0.1660876
# 13:           adt_in.accomm_clean_X10028.Outpatient.in.Bed 0.1659533
# 14:                                adt_in.accomm_reason_NA 0.1475846
# 15:          adt_out.accomm_clean_X10028.Outpatient.in.Bed 0.1336147
# 16:                               adt_out.accomm_reason_NA 0.1304948
# 17:                   adt_out.patient_class_X103.Emergency 0.1096210
# 18:                    adt_in.patient_class_X103.Emergency 0.1095504
# 19:                      adt_in.level_of_care_X18.Med.Surg 0.1061433
# 20:                                  adt_cen.periop_dep_yn 0.1019972
head(cor.PC10[order(PC5),c("x.var.names","PC5")],20)
#                                              x.var.names        PC5
#  1:                              adt_upd.adt_unit_type_X -0.5442823
#  2:               adt_out.patient_class_X104.Observation -0.4837313
#  3:              adt_out.accomm_clean_X10012.Observation -0.4807223
#  4:                             adt_upd.dept_specialty_X -0.4733897
#  5:               adt_in.accomm_clean_X10012.Observation -0.4684818
#  6:                adt_in.patient_class_X104.Observation -0.4663957
#  7:               adt_cen.patient_class_X104.Observation -0.4519341
#  8:              adt_cen.accomm_clean_X10012.Observation -0.4516338
#  9:              adt_upd.accomm_clean_X10012.Observation -0.4419767
# 10:               adt_upd.patient_class_X104.Observation -0.4306691
# 11:                                  adt_upd_event_count -0.3914556
# 12:                             adt_cen.dept_specialty_X -0.3832802
# 13:                 adt_upd.accomm_clean_X2.Semi.Private -0.3697218
# 14:     adt_upd.accomm_clean_X10019.Intcare.Prog.Care.SD -0.3590915
# 15:                              adt_cen.adt_unit_type_X -0.3558430
# 16: adt_upd.accomm_reason_REASON.Medical.Necessity.1001. -0.3034414
# 17:          adt_upd.level_of_care_X16.Cardiac.Telemetry -0.2713061
# 18:                                  adt_cen_event_count -0.2680190
# 19:                 adt_cen.patient_class_X101.Inpatient -0.2560141
# 20:                                  adt_upd.icu_dept_yn -0.2469820
```

OLD:PC251 is correlated very strongly with accomodation rehab, specifcially xfers in a out of rehab. negatively correlated with pediatric rehab, and census events finding rehab.
```{r}
#head(cor.full[order(-PC251),c("x.var.names","PC251")],20)
#head(cor.full[order(PC251),c("x.var.names","PC251")],20)
```
OLD:PC253 = very strong indicator of not being discharged. It is correlated with xfer in or out of surgery admit for, general surgery - and less so xfer in and out of L&D. Negatively correlated with xfers in an out of newborn, and emergency

```{r}
#head(cor.full[order(-PC253),c("x.var.names","PC253")],20)
#head(cor.full[order(PC253),c("x.var.names","PC253")],20)
```

OLD:PC254 very strongly correlated with xfer in and out of newborn/OBGyn/nursery. Not strongly negatively correlated with anything - weakly negatively correlated with emergency.


```{r}
#head(cor.full[order(-PC254),c("x.var.names","PC254")],20)
#head(cor.full[order(PC254),c("x.var.names","PC254")],20)
```
OLD:PC260 is a very strong predictor of discharge, and is correlated with counts of ADT events of various types (xfer in/out, less so patient status update). Not negatively correlated with much.

```{r}
#head(cor.full[order(-PC260),c("x.var.names","PC260")],20)
#head(cor.full[order(PC260),c("x.var.names","PC260")],20)
```

OLD:PC262 predicts discharge=yes. It is correlated with spending the night in the ED. Not negatively correlated with much.

```{r}
#head(cor.full[order(-PC262),c("x.var.names","PC262")],20)
#head(cor.full[order(PC262),c("x.var.names","PC262")],20)
```

```{r adt_create_lm, warning=FALSE,message=FALSE,error=FALSE}
#excluding PC192 through PC208 (last 17) because they have near zero variance, and the first 191 PCs explain more than 99% of variance. 
#last column is rownames, excluding that too.
#adt_pca <- adt.pca.plot$data[,-c(3:6,(len-17):(len))]
#adt_pca <- adt.pca.plot$data[,-c(3:6,len)]
adt_pca <- adt.pca.plot$data[,-c(len)]
adt_pca.lm <- lm(as.numeric(y.disch)~., data=adt_pca)
x <- model.matrix(adt_pca.lm)[,-1]
y <- adt_pca$y.disch
```

```{r pca_data_checkpoint, eval=FALSE, warning=FALSE,message=FALSE,error=FALSE}
pca_x.tosave <- x
save(pca_x.tosave, file = "~/MSDS/DS785capstone/PHI_data/TGH/pca_x.tosave.rda")
#load("R_data/ny.kaggle.clean.rda")
#ny.kaggle <- ny.kaggle.clean
#ny.kaggle.clean <- NULL
```

[This post](https://stats.stackexchange.com/questions/357407/glmnet-weights-and-imbalanced-data) provided a reference for the weighting logic used below.

```{r adt_glmnet_fit, warning=FALSE,message=FALSE,error=FALSE}
weighted <- TRUE
fraction_0 <- length(which(y == TRUE))
fraction_1 <- length(which(y == FALSE))
# assign that value to a "weights" vector
weights <- numeric(length(y))
if (weighted == TRUE) {
  weights[y == FALSE] <- fraction_0
  weights[y == TRUE] <- fraction_1
} else {
  weights <- rep(1, length(y))
}
require(glmnet)

#alphalist = c(0, .2, .5, .80, .99, 1)
# https://stackoverflow.com/questions/21698435/executing-glmnet-in-parallel-in-r
# https://web.stanford.edu/~hastie/glmnet/glmnet_alpha.html

#registerDoMC(cores=4)
doMC::registerDoMC(cores = detectCores()-1)
detectCores()
#cvfit.auc = cv.glmnet(x, y, family = "binomial", parallel = TRUE, alpha=.9, type.measure = "auc") #, type.measure = "class" (misclassification error) or "deviance" or "mae??? uses mean absolute error.
cvfit.auc.alpha.99 = cv.glmnet(x, y, family = "binomial", weights=weights, parallel = TRUE, alpha=.99, type.measure = "auc") #, type.measure = "class" (misclassification error) or "deviance" or "mae??? uses mean 
```

```{r adt_glmnet_coef, warning=FALSE,message=FALSE,error=FALSE}
coef(cvfit.auc.alpha.99, s="lambda.min")
```
1
(Intercept)                                            -2.478949e+00
PC1                                                     .           
PC2                                                     .           
adt_in.periop_dep_yn                                    .           
adt_in.icu_dept_yn                                     -2.665088e-01
adt_in.patient_class_X101.Inpatient                     .           
adt_in.patient_class_X103.Emergency                     .           
adt_in.patient_class_X104.Observation                   .           
adt_in.patient_class_X106.Hospital.Outpatient.Surgery   .           
adt_in.patient_class_X107.Newborn                       .           
adt_in.patient_class_X108.Surgery.Admit                 .           
adt_in.patient_class_X111.Deceased...Organ.Donor        .           
adt_in.patient_class_X122.Inpatient.Psych               .           
adt_in.patient_class_X123.Inpatient.Rehab              -3.750934e-01
adt_in.patient_class_X124.Outpatient.in.a.Bed          -2.898296e-01
adt_in.level_of_care_X                                  .           
adt_in.level_of_care_X1.Acute                           1.010868e-01
adt_in.level_of_care_X14.Critical.Care                 -2.937383e-01
adt_in.level_of_care_X15.Stepdown                       .           
adt_in.level_of_care_X16.Cardiac.Telemetry             -2.101579e-01
adt_in.level_of_care_X17.Medical.Telemetry              .           
adt_in.level_of_care_X18.Med.Surg                       .           
adt_in.level_of_care_X19.Procedural                     .           
adt_in.level_of_care_X2.Sub.Acute                       .           
adt_in.level_of_care_X21.Psych                         -3.445787e+00
adt_in.level_of_care_X22.Obstetrics                     .           
adt_in.level_of_care_X3.ICF                             .           
adt_in.level_of_care_X5.Telemetry                       .           
adt_in.level_of_care_X6.ICU                             .           
adt_in.level_of_care_X7.Hospice                         2.114460e+00
adt_in.level_of_care_X8.Newborn                         .           
adt_in.level_of_care_X9.Nursery.Special.Care           -4.369164e-01
adt_in.accomm_clean_X.NA                                .           
adt_in.accomm_clean_X1.Private                         -5.356066e-02
adt_in.accomm_clean_X10003.Intensive.Care.Unit          .           
adt_in.accomm_clean_X10010.Patient.Not.on.Unit         -5.207192e-01
adt_in.accomm_clean_X10011.Meets.Discharge.Criteria     .           
adt_in.accomm_clean_X10012.Observation                  .           
adt_in.accomm_clean_X10013.Baby.Nursery.LV.1            .           
adt_in.accomm_clean_X10014.Nursery.NICU.LV.2            .           
adt_in.accomm_clean_X10015.Neonatal.ICU.LV.3            .           
adt_in.accomm_clean_X10016.Burn.Unit                    .           
adt_in.accomm_clean_X10017.Cardiac.Surg.Unit            2.243052e-01
adt_in.accomm_clean_X10018.Coronary.Care               -1.663739e-01
adt_in.accomm_clean_X10019.Intcare.Prog.Care.SD        -1.912293e-01
adt_in.accomm_clean_X10020.Pedi.ICU                     8.862907e-01
adt_in.accomm_clean_X10021.Pediatric.Rehab              .           
adt_in.accomm_clean_X10022.Psych.Semi.Priv              .           
adt_in.accomm_clean_X10023.PVT..Med.Justified          -4.660948e-01
adt_in.accomm_clean_X10024.Semi.Priv.Rehab              .           
adt_in.accomm_clean_X10025.Trauma                       .           
adt_in.accomm_clean_X10026.Newborn.Nonviable.Bed        .           
adt_in.accomm_clean_X10027.ED.DEFAULT                   .           
adt_in.accomm_clean_X10028.Outpatient.in.Bed            6.754495e-01
adt_in.accomm_clean_X2.Semi.Private                     .           
adt_in.accomm_reason_REASON.Hospital.Convenience.2.     .           
adt_in.accomm_reason_REASON.Medical.Necessity.1001.     .           
adt_in.accomm_reason_REASON.Patient.Preference.1.       .           
adt_in.accomm_reason_NA                                 .           
adt_in.dept_specialty_X                                 .           
adt_in.dept_specialty_X11.General.Surgery               .           
adt_in.dept_specialty_X22.Obstetrics...Gynecology       .           
adt_in.dept_specialty_X304124.Inpatient                 2.738682e-01
adt_in.dept_specialty_X45.Emergency.Medicine            .           
adt_in.adt_unit_type_X                                  .           
adt_in.adt_unit_type_X1.Emergency.Dept                  .           
adt_in.adt_unit_type_X2.Hospital.Outpatient             5.501194e-02
adt_in.adt_unit_type_X3.Labor...Delivery               -3.127257e-01
adt_in_event_count                                      .           
adt_out.periop_dep_yn                                   .           
adt_out.icu_dept_yn                                     .           
adt_out.patient_class_X101.Inpatient                    .           
adt_out.patient_class_X103.Emergency                    .           
adt_out.patient_class_X104.Observation                  .           
adt_out.patient_class_X106.Hospital.Outpatient.Surgery  2.110338e-01
adt_out.patient_class_X107.Newborn                      .           
adt_out.patient_class_X108.Surgery.Admit                4.699623e-01
adt_out.patient_class_X122.Inpatient.Psych              .           
adt_out.patient_class_X123.Inpatient.Rehab             -8.408053e-03
adt_out.patient_class_X124.Outpatient.in.a.Bed          .           
adt_out.level_of_care_X                                 .           
adt_out.level_of_care_X1.Acute                          .           
adt_out.level_of_care_X14.Critical.Care                 4.315604e-02
adt_out.level_of_care_X15.Stepdown                      2.833979e-02
adt_out.level_of_care_X16.Cardiac.Telemetry             .           
adt_out.level_of_care_X17.Medical.Telemetry             .           
adt_out.level_of_care_X18.Med.Surg                     -6.023881e-02
adt_out.level_of_care_X19.Procedural                    .           
adt_out.level_of_care_X22.Obstetrics                    .           
adt_out.level_of_care_X3.ICF                            .           
adt_out.level_of_care_X5.Telemetry                      .           
adt_out.level_of_care_X6.ICU                            .           
adt_out.level_of_care_X8.Newborn                       -3.513487e-01
adt_out.level_of_care_X9.Nursery.Special.Care           .           
adt_out.accomm_clean_X.NA                               .           
adt_out.accomm_clean_X1.Private                        -3.223589e-02
adt_out.accomm_clean_X10003.Intensive.Care.Unit         .           
adt_out.accomm_clean_X10010.Patient.Not.on.Unit         .           
adt_out.accomm_clean_X10011.Meets.Discharge.Criteria    .           
adt_out.accomm_clean_X10012.Observation                 .           
adt_out.accomm_clean_X10013.Baby.Nursery.LV.1           .           
adt_out.accomm_clean_X10014.Nursery.NICU.LV.2           .           
adt_out.accomm_clean_X10015.Neonatal.ICU.LV.3           .           
adt_out.accomm_clean_X10016.Burn.Unit                   1.378197e-02
adt_out.accomm_clean_X10017.Cardiac.Surg.Unit          -2.740689e-01
adt_out.accomm_clean_X10018.Coronary.Care               2.336265e-03
adt_out.accomm_clean_X10019.Intcare.Prog.Care.SD       -5.621189e-02
adt_out.accomm_clean_X10020.Pedi.ICU                   -2.720220e-02
adt_out.accomm_clean_X10021.Pediatric.Rehab             .           
adt_out.accomm_clean_X10022.Psych.Semi.Priv             .           
adt_out.accomm_clean_X10023.PVT..Med.Justified          .           
adt_out.accomm_clean_X10024.Semi.Priv.Rehab             .           
adt_out.accomm_clean_X10025.Trauma                      .           
adt_out.accomm_clean_X10026.Newborn.Nonviable.Bed       .           
adt_out.accomm_clean_X10027.ED.DEFAULT                  .           
adt_out.accomm_clean_X10028.Outpatient.in.Bed           .           
adt_out.accomm_clean_X2.Semi.Private                    .           
adt_out.accomm_reason_REASON.Hospital.Convenience.2.    .           
adt_out.accomm_reason_REASON.Medical.Necessity.1001.   -7.039198e-02
adt_out.accomm_reason_REASON.Patient.Preference.1.      .           
adt_out.accomm_reason_NA                                .           
adt_out.dept_specialty_X                                .           
adt_out.dept_specialty_X11.General.Surgery              7.594480e-02
adt_out.dept_specialty_X22.Obstetrics...Gynecology     -6.433067e-01
adt_out.dept_specialty_X304124.Inpatient                .           
adt_out.dept_specialty_X45.Emergency.Medicine           .           
adt_out.adt_unit_type_X                                 .           
adt_out.adt_unit_type_X1.Emergency.Dept                 .           
adt_out.adt_unit_type_X2.Hospital.Outpatient            .           
adt_out.adt_unit_type_X3.Labor...Delivery              -8.029094e-01
adt_out_event_count                                     .           
adt_cen_event_count                                     .           
adt_cen.periop_dep_yn                                   .           
adt_cen.icu_dept_yn                                    -8.209914e-01
adt_cen.patient_class_X101.Inpatient                    2.305054e+00
adt_cen.patient_class_X103.Emergency                    7.719051e-01
adt_cen.patient_class_X104.Observation                  .           
adt_cen.patient_class_X106.Hospital.Outpatient.Surgery  .           
adt_cen.patient_class_X107.Newborn                     -3.624596e-01
adt_cen.patient_class_X108.Surgery.Admit                .           
adt_cen.patient_class_X111.Deceased...Organ.Donor       .           
adt_cen.patient_class_X123.Inpatient.Rehab             -8.614850e-01
adt_cen.patient_class_X124.Outpatient.in.a.Bed          .           
adt_cen.level_of_care_X                                 .           
adt_cen.level_of_care_X1.Acute                          .           
adt_cen.level_of_care_X10.Nursery.Continuous.Care       .           
adt_cen.level_of_care_X14.Critical.Care                -1.358293e-01
adt_cen.level_of_care_X15.Stepdown                     -6.089497e-01
adt_cen.level_of_care_X16.Cardiac.Telemetry             .           
adt_cen.level_of_care_X17.Medical.Telemetry            -7.190038e-02
adt_cen.level_of_care_X18.Med.Surg                      6.228505e-02
adt_cen.level_of_care_X19.Procedural                    .           
adt_cen.level_of_care_X2.Sub.Acute                     -4.288479e-01
adt_cen.level_of_care_X21.Psych                         .           
adt_cen.level_of_care_X22.Obstetrics                   -3.212139e-01
adt_cen.level_of_care_X3.ICF                            .           
adt_cen.level_of_care_X5.Telemetry                      2.912688e-02
adt_cen.level_of_care_X6.ICU                           -3.584260e-01
adt_cen.level_of_care_X7.Hospice                        .           
adt_cen.level_of_care_X8.Newborn                        5.294773e-01
adt_cen.level_of_care_X9.Nursery.Special.Care          -1.259950e+00
adt_cen.accomm_clean_X.NA                              -1.017472e+00
adt_cen.accomm_clean_X1.Private                         .           
adt_cen.accomm_clean_X10003.Intensive.Care.Unit        -2.322903e-01
adt_cen.accomm_clean_X10010.Patient.Not.on.Unit        -2.753465e-01
adt_cen.accomm_clean_X10011.Meets.Discharge.Criteria   -1.182144e+00
adt_cen.accomm_clean_X10012.Observation                 .           
adt_cen.accomm_clean_X10013.Baby.Nursery.LV.1           .           
adt_cen.accomm_clean_X10014.Nursery.NICU.LV.2           .           
adt_cen.accomm_clean_X10015.Neonatal.ICU.LV.3           .           
adt_cen.accomm_clean_X10016.Burn.Unit                  -4.675052e-04
adt_cen.accomm_clean_X10017.Cardiac.Surg.Unit          -1.610558e+00
adt_cen.accomm_clean_X10018.Coronary.Care               .           
adt_cen.accomm_clean_X10019.Intcare.Prog.Care.SD        .           
adt_cen.accomm_clean_X10020.Pedi.ICU                    .           
adt_cen.accomm_clean_X10021.Pediatric.Rehab             .           
adt_cen.accomm_clean_X10023.PVT..Med.Justified         -2.376585e-02
adt_cen.accomm_clean_X10024.Semi.Priv.Rehab             .           
adt_cen.accomm_clean_X10025.Trauma                     -2.164299e-01
adt_cen.accomm_clean_X10026.Newborn.Nonviable.Bed       .           
adt_cen.accomm_clean_X10027.ED.DEFAULT                  .           
adt_cen.accomm_clean_X10028.Outpatient.in.Bed           .           
adt_cen.accomm_clean_X2.Semi.Private                    1.185093e-01
adt_cen.accomm_reason_REASON.Hospital.Convenience.2.    .           
adt_cen.accomm_reason_REASON.Medical.Necessity.1001.    .           
adt_cen.accomm_reason_REASON.Patient.Preference.1.      .           
adt_cen.accomm_reason_NA                                2.671358e-01
adt_cen.dept_specialty_X                                2.125145e-01
adt_cen.dept_specialty_X11.General.Surgery              .           
adt_cen.dept_specialty_X22.Obstetrics...Gynecology      .           
adt_cen.dept_specialty_X304124.Inpatient                2.956836e-01
adt_cen.dept_specialty_X45.Emergency.Medicine           2.660714e-04
adt_cen.adt_unit_type_X                                 .           
adt_cen.adt_unit_type_X1.Emergency.Dept                 1.932658e-08
adt_cen.adt_unit_type_X2.Hospital.Outpatient            5.081631e-02
adt_cen.adt_unit_type_X3.Labor...Delivery               1.501977e+00
adt_upd_event_count                                     .           
adt_upd.periop_dep_yn                                   .           
adt_upd.icu_dept_yn                                     .           
adt_upd.patient_class_X101.Inpatient                    .           
adt_upd.patient_class_X103.Emergency                    .           
adt_upd.patient_class_X104.Observation                  .           
adt_upd.patient_class_X106.Hospital.Outpatient.Surgery  .           
adt_upd.patient_class_X108.Surgery.Admit                .           
adt_upd.patient_class_X124.Outpatient.in.a.Bed          6.132051e-01
adt_upd.level_of_care_X                                -3.374031e-01
adt_upd.level_of_care_X1.Acute                          2.008053e-02
adt_upd.level_of_care_X14.Critical.Care                -8.745556e-02
adt_upd.level_of_care_X15.Stepdown                      .           
adt_upd.level_of_care_X16.Cardiac.Telemetry             .           
adt_upd.level_of_care_X17.Medical.Telemetry             .           
adt_upd.level_of_care_X18.Med.Surg                      .           
adt_upd.level_of_care_X19.Procedural                    .           
adt_upd.level_of_care_X22.Obstetrics                   -7.462901e-02
adt_upd.level_of_care_X3.ICF                            .           
adt_upd.level_of_care_X5.Telemetry                      .           
adt_upd.level_of_care_X6.ICU                            .           
adt_upd.level_of_care_X8.Newborn                        .           
adt_upd.level_of_care_X9.Nursery.Special.Care           .           
adt_upd.accomm_clean_X.NA                               .           
adt_upd.accomm_clean_X1.Private                        -2.611523e-01
adt_upd.accomm_clean_X10003.Intensive.Care.Unit        -1.188354e-01
adt_upd.accomm_clean_X10010.Patient.Not.on.Unit        -5.258232e-01
adt_upd.accomm_clean_X10012.Observation                -6.068209e-01
adt_upd.accomm_clean_X10014.Nursery.NICU.LV.2           9.443149e-01
adt_upd.accomm_clean_X10015.Neonatal.ICU.LV.3           .           
adt_upd.accomm_clean_X10016.Burn.Unit                   .           
adt_upd.accomm_clean_X10017.Cardiac.Surg.Unit          -5.841279e-01
adt_upd.accomm_clean_X10018.Coronary.Care               8.554057e-02
adt_upd.accomm_clean_X10019.Intcare.Prog.Care.SD        .           
adt_upd.accomm_clean_X10020.Pedi.ICU                    .           
adt_upd.accomm_clean_X10023.PVT..Med.Justified          .           
adt_upd.accomm_clean_X10025.Trauma                     -1.088215e+00
adt_upd.accomm_clean_X10027.ED.DEFAULT                  .           
adt_upd.accomm_clean_X10028.Outpatient.in.Bed          -5.754988e-01
adt_upd.accomm_clean_X2.Semi.Private                    3.655214e-01
adt_upd.accomm_reason_REASON.Hospital.Convenience.2.    .           
adt_upd.accomm_reason_REASON.Medical.Necessity.1001.    .           
adt_upd.accomm_reason_REASON.Patient.Preference.1.     -1.988036e+00
adt_upd.accomm_reason_NA                                .           
adt_upd.dept_specialty_X                                .           
adt_upd.dept_specialty_X11.General.Surgery             -1.727731e+00
adt_upd.dept_specialty_X304124.Inpatient                .           
adt_upd.dept_specialty_X45.Emergency.Medicine           .           
adt_upd.adt_unit_type_X                                 .           
adt_upd.adt_unit_type_X1.Emergency.Dept                 .           
adt_upd.adt_unit_type_X2.Hospital.Outpatient            .           
adt_upd.adt_unit_type_X3.Labor...Delivery              -1.499559e+00
inp_admit_accommodation_X                               8.064826e-01
inp_admit_accommodation_X1.Private                      .           
inp_admit_accommodation_X10003.Intensive.Care.Unit     -3.483301e-02
inp_admit_accommodation_X10012.Observation              .           
inp_admit_accommodation_X10013.Baby.Nursery.LV.1        .           
inp_admit_accommodation_X10014.Nursery.NICU.LV.2        .           
inp_admit_accommodation_X10015.Neonatal.ICU.LV.3        .           
inp_admit_accommodation_X10016.Burn.Unit               -2.089330e-01
inp_admit_accommodation_X10017.Cardiac.Surg.Unit        .           
inp_admit_accommodation_X10018.Coronary.Care            .           
inp_admit_accommodation_X10019.Intcare.Prog.Care.SD    -1.934856e-03
inp_admit_accommodation_X10020.Pedi.ICU                 1.815422e-02
inp_admit_accommodation_X10021.Pediatric.Rehab          .           
inp_admit_accommodation_X10023.PVT..Med.Justified       .           
inp_admit_accommodation_X10024.Semi.Priv.Rehab          .           
inp_admit_accommodation_X10025.Trauma                  -1.490445e-01
inp_admit_accommodation_X10027.ED.DEFAULT               .           
inp_admit_accommodation_X10028.Outpatient.in.Bed        1.294326e-01
inp_admit_accommodation_X2.Semi.Private                 6.763414e-02
PC3                                                     .           
PC4                                                    -5.205499e-04
PC5                                                     2.664499e-02
PC6                                                     .           
PC7                                                     .           
PC8                                                     .           
PC9                                                     .           
PC10                                                    .           
PC11                                                   -6.370015e-03
PC12                                                    .           
PC13                                                    .           
PC14                                                    2.310762e-03
PC15                                                    .           
PC16                                                    .           
PC17                                                   -3.643080e-03
PC18                                                    .           
PC19                                                    .           
PC20                                                    2.453360e-02
PC21                                                    .           
PC22                                                    .           
PC23                                                    .           
PC24                                                    .           
PC25                                                    .           
PC26                                                    1.381948e-03
PC27                                                    2.432056e-03
PC28                                                    .           
PC29                                                    9.447001e-04
PC30                                                    .           
PC31                                                    .           
PC32                                                    .           
PC33                                                    .           
PC34                                                    .           
PC35                                                    .           
PC36                                                    .           
PC37                                                    .           
PC38                                                    .           
PC39                                                   -3.008665e-03
PC40                                                    1.335386e-02
PC41                                                    .           
PC42                                                    .           
PC43                                                   -1.153990e-02
PC44                                                    .           
PC45                                                   -5.875499e-02
PC46                                                    .           
PC47                                                    .           
PC48                                                    .           
PC49                                                    .           
PC50                                                    .           
PC51                                                    1.314702e-02
PC52                                                    .           
PC53                                                    .           
PC54                                                    1.691168e-02
PC55                                                    .           
PC56                                                    1.381476e-03
PC57                                                    1.328975e-02
PC58                                                    .           
PC59                                                   -6.546886e-03
PC60                                                    .           
PC61                                                   -1.349466e-03
PC62                                                    .           
PC63                                                   -1.379099e-02
PC64                                                    .           
PC65                                                    .           
PC66                                                    .           
PC67                                                    .           
PC68                                                    .           
PC69                                                    .           
PC70                                                    .           
PC71                                                    .           
PC72                                                    .           
PC73                                                    .           
PC74                                                    .           
PC75                                                    .           
PC76                                                    7.314535e-03
PC77                                                    .           
PC78                                                    .           
PC79                                                    8.811647e-03
PC80                                                    1.510350e-03
PC81                                                    .           
PC82                                                    .           
PC83                                                    .           
PC84                                                    .           
PC85                                                    .           
PC86                                                    1.314653e-02
PC87                                                    .           
PC88                                                    6.000962e-02
PC89                                                    .           
PC90                                                    .           
PC91                                                   -4.416368e-03
PC92                                                    1.344115e-02
PC93                                                    1.305595e-03
PC94                                                    .           
PC95                                                    .           
PC96                                                    .           
PC97                                                    .           
PC98                                                    8.182085e-04
PC99                                                    5.481898e-03
PC100                                                  -6.357808e-03
PC101                                                   .           
PC102                                                   .           
PC103                                                   .           
PC104                                                   7.044332e-03
PC105                                                   .           
PC106                                                  -3.747245e-02
PC107                                                  -1.133962e-02
PC108                                                   9.670970e-03
PC109                                                   .           
PC110                                                   .           
PC111                                                  -2.801987e-03
PC112                                                   .           
PC113                                                  -1.903618e-02
PC114                                                  -3.171576e-02
PC115                                                  -7.898135e-03
PC116                                                  -2.021395e-02
PC117                                                   .           
PC118                                                   .           
PC119                                                   .           
PC120                                                   1.947681e-02
PC121                                                   .           
PC122                                                   .           
PC123                                                   2.527539e-03
PC124                                                   2.307389e-03
PC125                                                   .           
PC126                                                   .           
PC127                                                  -3.224957e-02
PC128                                                   .           
PC129                                                   6.071764e-03
PC130                                                   .           
PC131                                                  -9.852935e-03
PC132                                                   7.279859e-03
PC133                                                   .           
PC134                                                   3.274190e-02
PC135                                                   .           
PC136                                                   .           
PC137                                                   .           
PC138                                                   3.657740e-02
PC139                                                   .           
PC140                                                   .           
PC141                                                  -1.395438e-02
PC142                                                   .           
PC143                                                   5.108402e-03
PC144                                                  -1.151546e-03
PC145                                                   8.041189e-03
PC146                                                   3.127045e-04
PC147                                                   .           
PC148                                                  -5.071345e-04
PC149                                                   .           
PC150                                                   .           
PC151                                                   6.603644e-03
PC152                                                   7.339391e-03
PC153                                                   .           
PC154                                                   .           
PC155                                                  -1.262711e-02
PC156                                                  -6.168367e-03
PC157                                                   2.782542e-02
PC158                                                   .           
PC159                                                   .           
PC160                                                   .           
PC161                                                   1.022326e-02
PC162                                                   .           
PC163                                                   1.388815e-03
PC164                                                   1.045374e-02
PC165                                                  -1.710036e-03
PC166                                                   .           
PC167                                                   1.564861e-02
PC168                                                   .           
PC169                                                  -2.428724e-03
PC170                                                   3.101943e-02
PC171                                                   .           
PC172                                                   .           
PC173                                                   .           
PC174                                                  -1.050038e-01
PC175                                                  -1.096933e-01
PC176                                                   1.039938e-02
PC177                                                   3.264104e-02
PC178                                                  -2.906902e-02
PC179                                                  -1.463330e-01
PC180                                                   .           
PC181                                                   1.754991e-01
PC182                                                  -3.123688e-02
PC183                                                   4.249868e-02
PC184                                                  -1.228729e-02
PC185                                                  -6.115285e-02
PC186                                                   1.955959e-03
PC187                                                   .           
PC188                                                  -4.314047e-02
PC189                                                  -8.626685e-03
PC190                                                   7.991286e-02
PC191                                                   1.120580e-03
PC192                                                   .           
PC193                                                   2.759966e-02
PC194                                                  -3.130841e-02
PC195                                                  -1.568720e-03
PC196                                                   7.874154e-02
PC197                                                   1.806525e-02
PC198                                                  -2.711847e-02
PC199                                                  -5.751557e-02
PC200                                                   2.358396e-02
PC201                                                  -9.303823e-02
PC202                                                   .           
PC203                                                  -1.238513e-03
PC204                                                  -2.514835e-02
PC205                                                  -7.279675e-03
PC206                                                   .           
PC207                                                  -6.584144e-02
PC208                                                   8.727153e-03
PC209                                                  -1.163887e-01
PC210                                                  -1.026917e-01
PC211                                                   9.284235e-02
PC212                                                  -8.960451e-02
PC213                                                   5.816399e-02
PC214                                                  -6.532125e-02
PC215                                                  -6.915601e-02
PC216                                                   5.958214e-02
PC217                                                   .           
PC218                                                  -1.395082e-02
PC219                                                   .           
PC220                                                  -1.689186e-01
PC221                                                   8.943149e-02
PC222                                                   3.587114e-02
PC223                                                  -2.698183e-02
PC224                                                   2.090183e-01
PC225                                                  -4.658079e-01
PC226                                                  -6.129074e-02
PC227                                                  -2.881958e-02
PC228                                                   1.529931e-02
PC229                                                  -1.333934e-01
PC230                                                   1.568524e-01
PC231                                                  -5.157069e-02
PC232                                                  -3.724801e-01
PC233                                                  -4.793297e-02
PC234                                                   8.483921e-02
PC235                                                   9.802747e-02
PC236                                                   .           
PC237                                                   .           
PC238                                                  -2.369389e-01
PC239                                                   7.136211e-01
PC240                                                  -5.066727e-01
PC241                                                  -3.046272e-01
PC242                                                  -2.979308e-02
PC243                                                   .           
PC244                                                  -4.341253e-03
PC245                                                  -5.000639e-01
PC246                                                   3.633549e-01
PC247                                                   .           
PC248                                                   .           
PC249                                                   .           
PC250                                                   .           
PC251                                                   4.504585e+08
PC252                                                   .           
PC253                                                  -6.378313e+10
PC254                                                  -2.120139e+10
PC255                                                   .           
PC256                                                   .           
PC257                                                   .           
PC258                                                   .           
PC259                                                   .           
PC260                                                   9.771654e+10
PC261                                                   .           
PC262                                                   1.121086e+10
PC263                                                   .           
PC264                                                   .  


```{r}
predictions.cvfit.auc.alpha.99.response <- predict(cvfit.auc.alpha.99, newx=x, type="response") #"link", "response", "coefficients", "nonzero""
```

```{r}
plot(cvfit.auc.alpha.99)
cvfit.auc.alpha.99$lambda.min
cvfit.auc.alpha.99$lambda.1se
```

```{r}
initial.ENET.remove.auc <- names(coef(cvfit.auc.alpha.99, s = "lambda.min")[which(coef(cvfit.auc.alpha.99, s = "lambda.min") == 0),1])
length(which(coef(cvfit.auc.alpha.99, s = "lambda.min") == 0))
initial.ENET.remove.auc
```

```{r}
ENET.predictions.cvfit.auc.alpha.99 <- predict(cvfit.auc.alpha.99, newx = x,  s = "lambda.min", type = "class")
paste("predictions == TRUE:", length(which(ENET.predictions.cvfit.auc.alpha.99 == TRUE)))
length(which(y == TRUE))
#"predictions == TRUE: 381799"
summary(y)
#  FALSE   TRUE 
# 741817 121600 
table(y,ENET.predictions.cvfit.auc.alpha.99)
# without balancing (used weights instead)
# y        FALSE   TRUE
#   FALSE 451850 289967
#   TRUE   29768  91832
```
###Remove variables with coefficients within one standard error of zero...

Get p-values/error estimates for ENET coefficients (to possibly reduce their number...)

Using [parallel bootstrapping via boot](https://stackoverflow.com/questions/31351526/use-parallel-option-of-boot-function-in-r) package. 

https://cran.r-project.org/web/packages/bcaboot/vignettes/bcaboot.html

```{r}
# library(glmnet)
# glmnet_boot <- function(B, X, y, glmnet_model, var = "resp") {
#     lambda <- cvfit.auc.alpha.99$lambda.min
#     theta <- as.matrix(coef(cvfit.auc.alpha.99, s = lambda))
#     pi_hat <- predict(cvfit.auc.alpha.99, newx = X, s = "lambda.min", type = "response")
#     n <- length(pi_hat)
#     y_star <- sapply(seq_len(B), function(i) ifelse(runif(n) <= pi_hat, 1, 0))
#     beta_star <- apply(y_star, 2,
#                        function(y) {
#                            as.matrix(coef(glmnet::glmnet(x = X, y = y, lambda = lambda, family = "binomial")))
#                        })
# 
#     rownames(beta_star) <- rownames(theta)
#     list(theta = theta[var, ],
#          theta_star = beta_star[var, ],
#          suff_stat = t(y_star) %*% X)
# }
# glmnet_boot_out <- glmnet_boot(B = 10, x, y, cvfit.auc.alpha.99)
# glmnet_bca <- bcapar(t0 = glmnet_boot_out$theta,
#                      tt = glmnet_boot_out$theta_star,
#                      bb = glmnet_boot_out$suff_stat)
```


```{r}
library(foreach) 
library(doMC)
doMC::registerDoMC(cores = detectCores()-1)
detectCores()

library(boot)

starttime=proc.time()
# glmnet - elastic net with bootstrapping

#bestlambdaENET = best.lambda.in[a.best]
#bestalphaENET <- alphalist[a.best]
beta.fn.ENET = function(inputdata,index) {
  yboot = inputdata[index,1]
  xboot = inputdata[index,-1]
  ENETfitboot = glmnet(xboot, 
                       yboot, 
                       alpha=.99,
                       weights=weights, 
                       parallel = TRUE,
                       lambda=cvfit.auc.alpha.99$lamda.min
                       #,parallel=TRUE
                       )
  return(coef(ENETfitboot,s=cvfit.auc.alpha.99$lamda.min)[,1])
}
set.seed(100)
ENETbootoutput.weights = boot(cbind(y,x), 
                      beta.fn.ENET,
                      R=1000,
                      parallel="multicore",
                      ncpus=detectCores()-1
                      )
endtime=proc.time()
endtime[3]-starttime[3]

#elapsed time: 73044.65 with 3 cores
```

```{r eval=FALSE}
pcaENETbootoutput.tosave <- ENETbootoutput
save(pcaENETbootoutput.tosave, file = "PHI_data/pcaENETbootoutput.tosave.rda")
#load("R_data/ny.kaggle.clean.rda")
#ny.kaggle <- ny.kaggle.clean
#ny.kaggle.clean <- NULL
```

```{r}
print(ENETbootoutput.weights)
```


```{r eval=FALSE}
#print(ENETbootoutput)
#t - A matrix with sum(R) rows each of which is a bootstrap replicate of the result of calling statistic.
# the 2 in apply(####,2,sd) below is the "margin" param of apply, 1=apply over rows. 2=apply over columns
SE_ENET = as.vector(as.numeric(round(apply((ENETbootoutput$t),2,sd),10)))

#check out how funky this got...
names.ENET <- names(coef(cvfit.auc.alpha.99, s="lambda.min")[,1])
coef.ENET <- coef(cvfit.auc.alpha.99, s="lambda.min")[,1]

ENET.coef <- data.frame(SE_ENET)
ENET.coef$predictors <- names.ENET
ENET.coef[1,]$predictors <- "Intercept"
ENET.coef$coef.ENET <- coef.ENET
rownames(ENET.coef) <- NULL
ENET.coef.signif <- ENET.coef[which(abs(ENET.coef$coef.ENET) - ENET.coef$SE_ENET > 0),]
ENET.coef.not_signif <- ENET.coef[which(abs(ENET.coef$coef.ENET) - ENET.coef$SE_ENET <= 0),]
rownames(ENET.coef.signif) <- 1:as.numeric(dim(ENET.coef.signif)[1])
rownames(ENET.coef.not_signif) <- 1:as.numeric(dim(ENET.coef.not_signif)[1])
ENET.coef.not_signif
ENET.coef.signif
```